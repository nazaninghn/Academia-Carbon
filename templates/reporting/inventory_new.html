{% extends 'dashboard_base.html' %}
{% load static %}

{% block page_title %}ISO 14064-1 Report{% endblock %}

{% block content %}
<!-- Report Header -->
<div class="mb-8">
    <div class="card">
        <div class="card-body text-center">
            <div class="mb-4">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-primary-100 rounded-full mb-4">
                    <i class="fas fa-file-alt text-2xl text-primary-600"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ report_title }}</h1>
                <p class="text-lg text-gray-600 mb-1">{{ standard }} Compliant Emissions Inventory</p>
                <p class="text-sm text-gray-500">Generated on {{ generated_at|date:"F d, Y \a\t H:i T" }}</p>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-center gap-4 flex-wrap">
                <a href="?format=pdf" class="btn btn-primary btn-lg">
                    <i class="fas fa-file-pdf"></i>
                    Download PDF Report
                </a>
                <a href="/en/reporting/inventory.pdf" class="btn btn-secondary btn-lg">
                    <i class="fas fa-download"></i>
                    Direct PDF Download
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Improve Report Accuracy Card -->
<div class="card mb-8">
    <div class="card-body">
        <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
                <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-shield-alt text-primary-600 text-xl"></i>
                </div>
            </div>
            <div class="flex-1">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Improve report accuracy</h3>
                <p class="text-gray-600 mb-4">Want a more complete ISO 14064-1 report? You can optionally share extra details (organization info, boundaries, data sources).</p>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <label class="flex items-center gap-2 text-sm">
                        <input type="checkbox" id="share-org" checked class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        Organization profile
                    </label>
                    <label class="flex items-center gap-2 text-sm">
                        <input type="checkbox" id="share-boundary" checked class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        Reporting boundary
                    </label>
                    <label class="flex items-center gap-2 text-sm">
                        <input type="checkbox" id="share-sources" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        Data sources (bills/receipts)
                    </label>
                    <label class="flex items-center gap-2 text-sm">
                        <input type="checkbox" id="share-projects" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                        Projects / initiatives
                    </label>
                </div>
                
                <div class="flex items-center gap-3">
                    <button type="button" onclick="openReportDetailsModal()" class="btn btn-primary">
                        Share info (optional)
                    </button>
                    <a href="#" class="text-sm text-secondary-600 hover:text-secondary-700">Privacy & data use</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters Applied -->
{% if summary.filters.date_from or summary.filters.date_to or summary.filters.scope or summary.filters.country %}
<div class="card mb-6">
    <div class="card-body">
        <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2">
            <i class="fas fa-filter text-secondary-500"></i>
            Filters Applied
        </h3>
        <div class="flex flex-wrap gap-2">
            {% if summary.filters.date_from %}
                <span class="badge badge-secondary">From: {{ summary.filters.date_from }}</span>
            {% endif %}
            {% if summary.filters.date_to %}
                <span class="badge badge-secondary">To: {{ summary.filters.date_to }}</span>
            {% endif %}
            {% if summary.filters.scope %}
                <span class="badge badge-success">Scope: {{ summary.filters.scope }}</span>
            {% endif %}
            {% if summary.filters.country %}
                <span class="badge badge-primary">Country: {{ summary.filters.country }}</span>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Summary Cards -->
<div class="grid grid-auto-fit mb-8">
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Total Emissions</div>
            <div class="stat-icon primary">
                <i class="fas fa-leaf"></i>
            </div>
        </div>
        <div class="stat-value">{{ summary.totals.total_t|floatformat:3 }}</div>
        <div class="stat-change">tCO₂e ({{ summary.totals.total_kg|floatformat:0 }} kgCO₂e)</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Emission Records</div>
            <div class="stat-icon secondary">
                <i class="fas fa-chart-bar"></i>
            </div>
        </div>
        <div class="stat-value">{{ summary.totals.records }}</div>
        <div class="stat-change">Total records</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Custom Factors</div>
            <div class="stat-icon accent">
                <i class="fas fa-cog"></i>
            </div>
        </div>
        <div class="stat-value">{{ summary.flags.custom_factor_records }}</div>
        <div class="stat-change">Supplier-provided factors</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">Compliance Standard</div>
            <div class="stat-icon primary">
                <i class="fas fa-certificate"></i>
            </div>
        </div>
        <div class="stat-value">{{ standard }}</div>
        <div class="stat-change">ISO 14064-1</div>
    </div>
</div>

{% if summary.totals.records == 0 %}
<!-- No Data State -->
<div class="card">
    <div class="card-body text-center py-12">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-chart-bar text-2xl text-gray-400"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">No Emission Records Found</h3>
        <p class="text-gray-600 mb-6">Add some emission records to generate your comprehensive inventory report.</p>
        <a href="/en/data-entry/" class="btn btn-primary btn-lg">
            <i class="fas fa-plus"></i>
            Add Emission Records
        </a>
    </div>
</div>
{% else %}

<!-- Scope Breakdown -->
{% if summary.by_scope %}
<div class="card mb-8">
    <div class="card-header">
        <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
            <i class="fas fa-layer-group text-primary-500"></i>
            Emissions by Scope
        </h2>
    </div>
    <div class="card-body">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-3 px-4 font-semibold text-gray-900">Scope</th>
                        <th class="text-right py-3 px-4 font-semibold text-gray-900">Emissions (tCO₂e)</th>
                        <th class="text-right py-3 px-4 font-semibold text-gray-900">Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in summary.by_scope %}
                    <tr class="border-b border-gray-100">
                        <td class="py-3 px-4 font-semibold">{{ item.scope }}</td>
                        <td class="py-3 px-4 text-right">{{ item.value_t|floatformat:3 }}</td>
                        <td class="py-3 px-4 text-right">
                            <span class="badge badge-success">{{ item.percentage|floatformat:1 }}%</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Top Sources -->
{% if summary.top_sources %}
<div class="card mb-8">
    <div class="card-header">
        <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
            <i class="fas fa-trophy text-accent-500"></i>
            Top Emission Sources
        </h2>
    </div>
    <div class="card-body">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-3 px-4 font-semibold text-gray-900">Scope</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-900">Category</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-900">Source</th>
                        <th class="text-right py-3 px-4 font-semibold text-gray-900">tCO₂e</th>
                        <th class="text-right py-3 px-4 font-semibold text-gray-900">%</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in summary.top_sources|slice:":10" %}
                    <tr class="border-b border-gray-100">
                        <td class="py-3 px-4">
                            <span class="badge badge-secondary">{{ item.scope }}</span>
                        </td>
                        <td class="py-3 px-4">{{ item.category }}</td>
                        <td class="py-3 px-4 font-semibold">{{ item.source_name }}</td>
                        <td class="py-3 px-4 text-right">{{ item.value_t|floatformat:3 }}</td>
                        <td class="py-3 px-4 text-right">
                            <span class="badge badge-primary">{{ item.percentage|floatformat:1 }}%</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% endif %}

<!-- Filter Examples -->
<div class="card">
    <div class="card-header">
        <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <i class="fas fa-tools text-secondary-500"></i>
            Filter Examples
        </h3>
    </div>
    <div class="card-body">
        <p class="text-gray-600 mb-4">You can filter the report using URL parameters:</p>
        <div class="grid grid-cols-2 gap-3">
            <a href="?from=2025-01-01&to=2025-12-31" class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <i class="fas fa-calendar text-primary-500"></i>
                <span class="text-sm font-medium">Year 2025</span>
            </a>
            <a href="?scope=1" class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <i class="fas fa-industry text-primary-500"></i>
                <span class="text-sm font-medium">Scope 1 only</span>
            </a>
            <a href="?scope=2" class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <i class="fas fa-bolt text-primary-500"></i>
                <span class="text-sm font-medium">Scope 2 only</span>
            </a>
            <a href="?country=turkey" class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                <i class="fas fa-flag text-primary-500"></i>
                <span class="text-sm font-medium">Turkey only</span>
            </a>
        </div>
    </div>
</div>

<!-- Report Details Modal -->
<div id="reportDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
    <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-auto">
        {% csrf_token %}
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-semibold text-gray-900">Complete report details</h3>
                <button type="button" onclick="closeReportDetailsModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <p class="text-sm text-gray-600 mt-2">Optional — used only for report generation. You can remove this anytime.</p>
        </div>
        
        <div class="p-6">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="form-group">
                    <label class="form-label">Legal name</label>
                    <input id="rep_legal_name" type="text" class="form-control" placeholder="Company/Organization name">
                </div>
                <div class="form-group">
                    <label class="form-label">Industry (optional)</label>
                    <input id="rep_industry" type="text" class="form-control" placeholder="e.g., Manufacturing">
                </div>
                <div class="form-group">
                    <label class="form-label">Reporting period</label>
                    <input id="rep_period" type="text" class="form-control" placeholder="e.g., 2025-01-01 to 2025-12-31">
                </div>
                <div class="form-group">
                    <label class="form-label">Boundary approach</label>
                    <select id="rep_boundary" class="form-control">
                        <option value="">Select</option>
                        <option value="operational_control">Operational control</option>
                        <option value="financial_control">Financial control</option>
                        <option value="equity_share">Equity share</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group mb-6">
                <label class="form-label">Notes (optional)</label>
                <textarea id="rep_notes" class="form-control" rows="3" placeholder="Any extra context for the report..."></textarea>
            </div>
        </div>
        
        <div class="p-6 border-t border-gray-200 flex justify-end gap-3">
            <button type="button" onclick="closeReportDetailsModal()" class="btn btn-ghost">
                Cancel
            </button>
            <button type="button" onclick="saveReportDetails()" class="btn btn-primary">
                Save
            </button>
        </div>
    </div>
</div>

<script>
// Modal functionality (keeping the existing JavaScript from the original file)
const REPORT_EXTRA_URL = "{% url 'ghg:report_extra_info_api' %}";

function openReportDetailsModal() {
    const modal = document.getElementById('reportDetailsModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    loadExistingReportData();
}

function closeReportDetailsModal() {
    const modal = document.getElementById('reportDetailsModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

function loadExistingReportData() {
    fetch(REPORT_EXTRA_URL, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('rep_legal_name').value = data.legal_name || '';
        document.getElementById('rep_industry').value = data.industry || '';
        document.getElementById('rep_period').value = data.period || '';
        document.getElementById('rep_boundary').value = data.boundary || '';
        document.getElementById('rep_notes').value = data.notes || '';
        
        document.getElementById('share-org').checked = data.share_org_profile !== false;
        document.getElementById('share-boundary').checked = data.share_boundary !== false;
        document.getElementById('share-sources').checked = data.share_data_sources === true;
        document.getElementById('share-projects').checked = data.share_projects === true;
    })
    .catch(error => console.error('Error loading existing data:', error));
}

function saveReportDetails() {
    const payload = {
        legal_name: document.getElementById('rep_legal_name').value,
        industry: document.getElementById('rep_industry').value,
        period: document.getElementById('rep_period').value,
        boundary: document.getElementById('rep_boundary').value,
        notes: document.getElementById('rep_notes').value,
        share_org_profile: document.getElementById('share-org').checked,
        share_boundary: document.getElementById('share-boundary').checked,
        share_data_sources: document.getElementById('share-sources').checked,
        share_projects: document.getElementById('share-projects').checked,
    };
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                     document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                     getCookie('csrftoken');
    
    fetch(REPORT_EXTRA_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Report details saved successfully!');
            closeReportDetailsModal();
        } else {
            alert('Error saving report details: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Network error: ' + error.message + '. Please try again.');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Close modal when clicking outside
document.getElementById('reportDetailsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeReportDetailsModal();
    }
});
</script>
{% endblock %}