{% extends 'dashboard_base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Reporting" %} - Academia Carbon{% endblock %}

{% block page_title %}{% trans "Reporting" %}{% endblock %}

{% block header_actions %}
<!-- Reporting specific actions -->
<div style="display: flex; align-items: center; gap: 15px;">
    <div style="display: flex; align-items: center; gap: 8px;">
        <label style="font-size: 13px; font-weight: 600; color: #475569;">
            <i class="fas fa-filter" style="color: #22c55e;"></i> {% trans "Filter" %}:
        </label>
        <select id="report-scope" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; min-width: 120px; background: white;">
            <option value="all" selected>{% trans "All Scopes" %}</option>
            <option value="1">{% trans "Scope 1" %}</option>
            <option value="2">{% trans "Scope 2" %}</option>
            <option value="3">{% trans "Scope 3" %}</option>
        </select>
    </div>
    <button onclick="generatePDF()" style="padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;">
        <i class="fas fa-file-pdf"></i> {% trans "Generate PDF" %}
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Professional Page Header -->
{% include 'partials/page_header.html' %}

<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">
    <!-- Summary Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
            <h3 style="margin: 0 0 10px 0; color: #6b7280; font-size: 14px; font-weight: 600;">Total Emissions</h3>
            <div style="font-size: 32px; font-weight: 700; color: #10b981; margin-bottom: 5px;">{{ total_emissions_tons|floatformat:3 }}</div>
            <div style="color: #6b7280; font-size: 12px;">tCO₂e ({{ total_emissions_kg|floatformat:0 }} kgCO₂e)</div>
        </div>
        
        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
            <h3 style="margin: 0 0 10px 0; color: #6b7280; font-size: 14px; font-weight: 600;">Emission Records</h3>
            <div style="font-size: 32px; font-weight: 700; color: #3b82f6; margin-bottom: 5px;">{{ total_records }}</div>
            <div style="color: #6b7280; font-size: 12px;">Total records</div>
        </div>
        
        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
            <h3 style="margin: 0 0 10px 0; color: #6b7280; font-size: 14px; font-weight: 600;">Reporting Period</h3>
            <div style="font-size: 32px; font-weight: 700; color: #f59e0b; margin-bottom: 5px;">2024</div>
            <div style="color: #6b7280; font-size: 12px;">Current year</div>
        </div>
        
        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;">
            <h3 style="margin: 0 0 10px 0; color: #6b7280; font-size: 14px; font-weight: 600;">Compliance Standard</h3>
            <div style="font-size: 32px; font-weight: 700; color: #8b5cf6; margin-bottom: 5px;">ISO</div>
            <div style="color: #6b7280; font-size: 12px;">14064-1</div>
        </div>
    </div>

    {% if total_records == 0 %}
    <div style="background: white; border-radius: 12px; padding: 40px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <h3 style="color: #6b7280; margin-bottom: 15px;"><i class="fas fa-chart-bar"></i> No Emission Records Found</h3>
        <p style="color: #9ca3af; margin-bottom: 20px;">Add some emission records to generate your comprehensive inventory report.</p>
        <a href="/en/data-entry/" style="background: #10b981; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600;">
            <i class="fas fa-plus"></i> Add Emission Records
        </a>
    </div>
    {% else %}
    
    <!-- Scope Breakdown -->
    {% if scope_breakdown %}
    <div style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <h2 style="margin: 0 0 20px 0; color: #1e293b; font-size: 18px; font-weight: 600;">
            <i class="fas fa-layer-group" style="color: #10b981; margin-right: 10px;"></i>
            Emissions by Scope
        </h2>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8fafc;">
                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Scope</th>
                        <th style="padding: 12px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Emissions (tCO₂e)</th>
                        <th style="padding: 12px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Records</th>
                        <th style="padding: 12px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in scope_breakdown %}
                    {% if item.emissions_tons > 0 %}
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;"><strong>Scope {{ item.scope }}</strong></td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #f3f4f6;">{{ item.emissions_tons|floatformat:3 }}</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #f3f4f6;">{{ item.records_count }}</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #f3f4f6;">
                            <span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">{{ item.percentage|floatformat:1 }}%</span>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Top Sources -->
    {% if top_sources %}
    <div style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <h2 style="margin: 0 0 20px 0; color: #1e293b; font-size: 18px; font-weight: 600;">
            <i class="fas fa-trophy" style="color: #f59e0b; margin-right: 10px;"></i>
            Top Emission Sources
        </h2>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8fafc;">
                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Scope</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Category</th>
                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Source</th>
                        <th style="padding: 12px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">tCO₂e</th>
                        <th style="padding: 12px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">%</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in top_sources %}
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">
                            <span style="background: #6b7280; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">Scope {{ item.scope }}</span>
                        </td>
                        <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;">{{ item.category|title }}</td>
                        <td style="padding: 12px; border-bottom: 1px solid #f3f4f6;"><strong>{{ item.source_name }}</strong></td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #f3f4f6;">{{ item.total_tons|floatformat:3 }}</td>
                        <td style="padding: 12px; text-align: right; border-bottom: 1px solid #f3f4f6;">
                            <span style="background: #3b82f6; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">{{ item.percentage|floatformat:1 }}%</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% endif %}

    <!-- Filter Examples -->
    <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 16px; font-weight: 600;">
            <i class="fas fa-tools" style="color: #8b5cf6; margin-right: 10px;"></i>
            Filter Examples
        </h3>
        <p style="margin-bottom: 15px; color: #6b7280;">You can filter the report using URL parameters:</p>
        <ul style="list-style: none; padding: 0; margin: 0;">
            <li style="margin-bottom: 8px;">
                <a href="?from=2025-01-01&to=2025-12-31" style="color: #10b981; text-decoration: none; font-weight: 500;">
                    <i class="fas fa-calendar" style="margin-right: 8px;"></i> Year 2025
                </a>
            </li>
            <li style="margin-bottom: 8px;">
                <a href="?scope=1" style="color: #10b981; text-decoration: none; font-weight: 500;">
                    <i class="fas fa-industry" style="margin-right: 8px;"></i> Scope 1 only
                </a>
            </li>
            <li style="margin-bottom: 8px;">
                <a href="?scope=2" style="color: #10b981; text-decoration: none; font-weight: 500;">
                    <i class="fas fa-bolt" style="margin-right: 8px;"></i> Scope 2 only
                </a>
            </li>
            <li style="margin-bottom: 8px;">
                <a href="?scope=3" style="color: #10b981; text-decoration: none; font-weight: 500;">
                    <i class="fas fa-truck" style="margin-right: 8px;"></i> Scope 3 only
                </a>
            </li>
            <li>
                <a href="?country=turkey" style="color: #10b981; text-decoration: none; font-weight: 500;">
                    <i class="fas fa-flag" style="margin-right: 8px;"></i> Turkey only
                </a>
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// PDF Generation function
function generatePDF() {
    // Get current filter parameters
    const urlParams = new URLSearchParams(window.location.search);
    const params = new URLSearchParams();
    
    // Add current filters to PDF request
    if (urlParams.get('from')) params.set('from', urlParams.get('from'));
    if (urlParams.get('to')) params.set('to', urlParams.get('to'));
    if (urlParams.get('scope')) params.set('scope', urlParams.get('scope'));
    if (urlParams.get('country')) params.set('country', urlParams.get('country'));
    
    // Add header scope filter if set
    const headerScope = document.getElementById('report-scope')?.value;
    if (headerScope && headerScope !== 'all') {
        params.set('scope', headerScope);
    }
    
    // Open PDF in new tab
    const pdfUrl = `/en/reporting/pdf/?${params.toString()}`;
    window.open(pdfUrl, '_blank');
    
    // Show success message
    showToast('PDF generation started...', 'success');
}

// Toast notification function
function showToast(message, type = 'success') {
    const colors = {
        'success': '#22c55e',
        'error': '#ef4444',
        'info': '#3b82f6'
    };
    
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed; 
        top: 20px; 
        right: 20px; 
        background: ${colors[type]}; 
        color: white; 
        padding: 15px 25px; 
        border-radius: 8px; 
        z-index: 10000; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-weight: 500;
    `;
    toast.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Initialize filters on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set current filter values from URL
    const urlParams = new URLSearchParams(window.location.search);
    
    if (urlParams.get('scope')) {
        const headerScope = document.getElementById('report-scope');
        if (headerScope) headerScope.value = urlParams.get('scope');
    }
});
</script>
{% endblock %}