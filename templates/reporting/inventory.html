{% extends 'dashboard_base.html' %}
{% load static %}

{% block title %}Reporting - Academia Carbon{% endblock %}

{% block extra_css %}
<meta name="csrf-token" content="{{ csrf_token }}">
<style>
    .reporting-header {
        background: linear-gradient(135deg, #2d7a5f 0%, #1e5a45 100%);
        color: white;
        padding: 40px 0;
        margin-bottom: 30px;
        border-radius: 0 0 20px 20px;
    }
    
    .reporting-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
    }
    
    .reporting-header .subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 5px;
    }
    
    .reporting-header .generated-time {
        font-size: 0.9rem;
        opacity: 0.7;
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }
    
    .btn-report {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 16px;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
    }
    
    .btn-report:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        color: white;
    }
    
    .btn-report.secondary {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
    }
    
    .btn-report.secondary:hover {
        background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
    }
    
    .complete-report-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 18px;
        margin: 20px 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }
    
    .complete-report-content {
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }
    
    .complete-report-icon {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        background: #ecfdf5;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #10b981;
        font-size: 18px;
        flex-shrink: 0;
    }
    
    .complete-report-text {
        flex: 1;
    }
    
    .complete-report-text h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 700;
        color: #111827;
    }
    
    .complete-report-text p {
        margin: 6px 0 12px;
        color: #6b7280;
        font-size: 13px;
        line-height: 1.5;
    }
    
    .consent-checkboxes {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 14px;
        font-size: 13px;
    }
    
    .consent-checkboxes label {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        color: #374151;
    }
    
    .consent-checkboxes input[type="checkbox"] {
        margin: 0;
    }
    
    .complete-report-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .btn-complete-report {
        background: #10b981;
        color: white;
        border: none;
        padding: 10px 14px;
        border-radius: 10px;
        font-weight: 700;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.3s;
    }
    
    .btn-complete-report:hover {
        background: #059669;
    }
    
    .privacy-link {
        font-size: 13px;
        color: #3b82f6;
        text-decoration: none;
    }
    
    .privacy-link:hover {
        color: #2563eb;
        text-decoration: underline;
    }
    
    /* Modal Styles */
    .report-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    
    .report-modal-content {
        background: #fff;
        border-radius: 14px;
        width: 100%;
        max-width: 720px;
        padding: 22px;
        max-height: 85vh;
        overflow: auto;
    }
    
    .report-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
    }
    
    .report-modal-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 800;
        color: #111827;
    }
    
    .modal-close-btn {
        border: none;
        background: transparent;
        font-size: 22px;
        cursor: pointer;
        color: #6b7280;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-close-btn:hover {
        color: #374151;
    }
    
    .modal-subtitle {
        margin: 8px 0 16px;
        color: #6b7280;
        font-size: 13px;
    }
    
    .modal-form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 14px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        font-size: 13px;
        font-weight: 700;
        color: #374151;
        margin-bottom: 4px;
    }
    
    .form-control {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 18px;
    }
    
    .btn-modal-cancel {
        background: #e5e7eb;
        border: none;
        padding: 10px 14px;
        border-radius: 10px;
        font-weight: 700;
        cursor: pointer;
        color: #374151;
        font-size: 13px;
    }
    
    .btn-modal-cancel:hover {
        background: #d1d5db;
    }
    
    .btn-modal-save {
        background: #10b981;
        color: white;
        border: none;
        padding: 10px 14px;
        border-radius: 10px;
        font-weight: 800;
        cursor: pointer;
        font-size: 13px;
    }
    
    .btn-modal-save:hover {
        background: #059669;
    }
    
    .filters-card {
        background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
        border: none;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }
    
    .filters-card h5 {
        color: #0277bd;
        font-weight: 700;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .summary-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border-left: 5px solid #10b981;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }
    
    .summary-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%);
        border-radius: 50%;
        transform: translate(30%, -30%);
    }
    
    .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }
    
    .summary-card h3 {
        font-size: 1rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 15px;
    }
    
    .summary-card .value {
        font-size: 2.2rem;
        font-weight: 800;
        color: #10b981;
        margin-bottom: 5px;
        position: relative;
        z-index: 1;
    }
    
    .summary-card .label {
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: 500;
    }
    
    .data-table {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
    }
    
    .data-table h2 {
        background: linear-gradient(135deg, #2d7a5f 0%, #1e5a45 100%);
        color: white;
        padding: 20px 25px;
        margin: 0;
        font-size: 1.3rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .table {
        margin: 0;
        border: none;
    }
    
    .table th {
        background: #f8fafc;
        color: #374151;
        font-weight: 600;
        border: none;
        padding: 15px 20px;
        font-size: 0.9rem;
    }
    
    .table td {
        padding: 15px 20px;
        border: none;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
    }
    
    .table tbody tr:hover {
        background: #f8fafc;
    }
    
    .no-data {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }
    
    .no-data h3 {
        color: #6b7280;
        font-size: 1.5rem;
        margin-bottom: 15px;
    }
    
    .no-data p {
        color: #9ca3af;
        margin-bottom: 25px;
    }
    
    .filter-examples {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border-radius: 15px;
        padding: 25px;
        margin-top: 30px;
        border-left: 5px solid #22c55e;
    }
    
    .filter-examples h3 {
        color: #15803d;
        font-weight: 700;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .filter-examples ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 10px;
    }
    
    .filter-examples li {
        background: white;
        padding: 12px 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .filter-examples a {
        color: #059669;
        text-decoration: none;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .filter-examples a:hover {
        color: #047857;
    }
    
    @media (max-width: 768px) {
        .reporting-header h1 {
            font-size: 2rem;
        }
        
        .action-buttons {
            flex-direction: column;
            align-items: center;
        }
        
        .btn-report {
            width: 100%;
            max-width: 300px;
            justify-content: center;
        }
        
        .summary-grid {
            grid-template-columns: 1fr;
        }
        
        .filter-examples ul {
            grid-template-columns: 1fr;
        }
        
        .complete-report-content {
            flex-direction: column;
            gap: 15px;
        }
        
        .complete-report-icon {
            align-self: flex-start;
        }
        
        .consent-checkboxes {
            grid-template-columns: 1fr;
        }
        
        .modal-form-grid {
            grid-template-columns: 1fr;
        }
        
        .report-modal-content {
            margin: 10px;
            padding: 18px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Professional Page Header -->
<div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-bottom: 1px solid #e2e8f0; padding: 24px 30px; margin-bottom: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="font-size: 28px; font-weight: 700; color: #1e293b; margin: 0 0 8px 0;">ISO 14064-1 Reporting</h1>
            <p style="color: #64748b; margin: 0; font-size: 14px;">
                <span style="margin-right: 20px;"><strong>Organization:</strong> {{ user.username|title }}</span>
                <span style="margin-right: 20px;"><strong>Period:</strong> 2024</span>
                <span><strong>Standard:</strong> ISO 14064-1</span>
            </p>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div style="text-align: right; font-size: 12px; color: #64748b;">
                <div><strong>Report Generated:</strong></div>
                <div>{{ generated_at|date:"F d, Y \a\t H:i T" }}</div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="action-buttons">
        <a href="?format=pdf" class="btn-report">
            <i class="fas fa-file-pdf"></i>
            Download PDF Report
        </a>
        <a href="/en/reporting/inventory.pdf" class="btn-report secondary">
            <i class="fas fa-download"></i>
            Direct PDF Download
        </a>
    </div>

    <!-- Complete Report Card -->
    <div class="complete-report-card">
        <div class="complete-report-content">
            <div class="complete-report-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="complete-report-text">
                <h3>Improve report accuracy</h3>
                <p>Want a more complete ISO 14064-1 report? You can optionally share extra details (organization info, boundaries, data sources).</p>
                
                <div class="consent-checkboxes">
                    <label><input type="checkbox" id="share-org" checked> Organization profile</label>
                    <label><input type="checkbox" id="share-boundary" checked> Reporting boundary</label>
                    <label><input type="checkbox" id="share-sources"> Data sources (bills/receipts)</label>
                    <label><input type="checkbox" id="share-projects"> Projects / initiatives</label>
                </div>
                
                <div class="complete-report-actions">
                    <button type="button" onclick="openReportDetailsModal()" class="btn-complete-report">
                        Share info (optional)
                    </button>
                    <a href="#" class="privacy-link">Privacy & data use</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Applied -->
    {% if summary.filters.date_from or summary.filters.date_to or summary.filters.scope or summary.filters.country %}
    <div class="filters-card">
        <h5><i class="fas fa-filter"></i> Filters Applied</h5>
        <div class="d-flex flex-wrap gap-3">
            {% if summary.filters.date_from %}
                <span class="badge bg-primary fs-6">From: {{ summary.filters.date_from }}</span>
            {% endif %}
            {% if summary.filters.date_to %}
                <span class="badge bg-primary fs-6">To: {{ summary.filters.date_to }}</span>
            {% endif %}
            {% if summary.filters.scope %}
                <span class="badge bg-success fs-6">Scope: {{ summary.filters.scope }}</span>
            {% endif %}
            {% if summary.filters.country %}
                <span class="badge bg-info fs-6">Country: {{ summary.filters.country }}</span>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Summary Cards -->
    <div class="summary-grid">
        <div class="summary-card">
            <h3>Total Emissions</h3>
            <div class="value">{{ summary.totals.total_t|floatformat:3 }}</div>
            <div class="label">tCO₂e ({{ summary.totals.total_kg|floatformat:0 }} kgCO₂e)</div>
        </div>
        
        <div class="summary-card">
            <h3>Emission Records</h3>
            <div class="value">{{ summary.totals.records }}</div>
            <div class="label">Total records</div>
        </div>
        
        <div class="summary-card">
            <h3>Custom Factors</h3>
            <div class="value">{{ summary.flags.custom_factor_records }}</div>
            <div class="label">Supplier-provided factors</div>
        </div>
        
        <div class="summary-card">
            <h3>Compliance Standard</h3>
            <div class="value">{{ standard }}</div>
            <div class="label">ISO 14064-1</div>
        </div>
    </div>

    {% if summary.totals.records == 0 %}
    <div class="no-data">
        <h3><i class="fas fa-chart-bar"></i> No Emission Records Found</h3>
        <p>Add some emission records to generate your comprehensive inventory report.</p>
        <a href="/en/data-entry/" class="btn-report">
            <i class="fas fa-plus"></i>
            Add Emission Records
        </a>
    </div>
    {% else %}
    
    <!-- Scope Breakdown -->
    {% if summary.by_scope %}
    <div class="data-table">
        <h2><i class="fas fa-layer-group"></i> Emissions by Scope</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Scope</th>
                    <th class="text-end">Emissions (tCO₂e)</th>
                    <th class="text-end">Percentage</th>
                </tr>
            </thead>
            <tbody>
                {% for item in summary.by_scope %}
                <tr>
                    <td><strong>{{ item.scope }}</strong></td>
                    <td class="text-end">{{ item.value_t|floatformat:3 }}</td>
                    <td class="text-end">
                        <span class="badge bg-success">{{ item.percentage|floatformat:1 }}%</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Top Sources -->
    {% if summary.top_sources %}
    <div class="data-table">
        <h2><i class="fas fa-trophy"></i> Top Emission Sources</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Scope</th>
                    <th>Category</th>
                    <th>Source</th>
                    <th class="text-end">tCO₂e</th>
                    <th class="text-end">%</th>
                </tr>
            </thead>
            <tbody>
                {% for item in summary.top_sources|slice:":10" %}
                <tr>
                    <td><span class="badge bg-secondary">{{ item.scope }}</span></td>
                    <td>{{ item.category }}</td>
                    <td><strong>{{ item.source_name }}</strong></td>
                    <td class="text-end">{{ item.value_t|floatformat:3 }}</td>
                    <td class="text-end">
                        <span class="badge bg-primary">{{ item.percentage|floatformat:1 }}%</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% endif %}

    <!-- Filter Examples -->
    <div class="filter-examples">
        <h3><i class="fas fa-tools"></i> Filter Examples</h3>
        <p class="mb-3">You can filter the report using URL parameters:</p>
        <ul>
            <li><a href="?from=2025-01-01&to=2025-12-31"><i class="fas fa-calendar"></i> Year 2025</a></li>
            <li><a href="?scope=1"><i class="fas fa-industry"></i> Scope 1 only</a></li>
            <li><a href="?scope=2"><i class="fas fa-bolt"></i> Scope 2 only</a></li>
            <li><a href="?country=turkey"><i class="fas fa-flag"></i> Turkey only</a></li>
            <li><a href="?from=2025-01-01&scope=1&country=turkey"><i class="fas fa-search"></i> Combined filters</a></li>
        </ul>
    </div>
</div>

<!-- Report Details Modal -->
<div id="reportDetailsModal" class="report-modal">
    <div class="report-modal-content">
        {% csrf_token %}
        <div class="report-modal-header">
            <h3>Complete report details</h3>
            <button type="button" onclick="closeReportDetailsModal()" class="modal-close-btn">×</button>
        </div>
        
        <p class="modal-subtitle">Optional — used only for report generation. You can remove this anytime.</p>
        
        <div class="modal-form-grid">
            <div class="form-group">
                <label>Legal name</label>
                <input id="rep_legal_name" type="text" class="form-control" placeholder="Company/Organization name">
            </div>
            <div class="form-group">
                <label>Industry (optional)</label>
                <input id="rep_industry" type="text" class="form-control" placeholder="e.g., Manufacturing">
            </div>
            <div class="form-group">
                <label>Reporting period</label>
                <input id="rep_period" type="text" class="form-control" placeholder="e.g., 2025-01-01 to 2025-12-31">
            </div>
            <div class="form-group">
                <label>Boundary approach</label>
                <select id="rep_boundary" class="form-control">
                    <option value="">Select</option>
                    <option value="operational_control">Operational control</option>
                    <option value="financial_control">Financial control</option>
                    <option value="equity_share">Equity share</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label>Notes (optional)</label>
            <textarea id="rep_notes" class="form-control" rows="3" placeholder="Any extra context for the report..."></textarea>
        </div>
        
        <div class="modal-actions">
            <button type="button" onclick="closeReportDetailsModal()" class="btn-modal-cancel">
                Cancel
            </button>
            <button type="button" onclick="saveReportDetails()" class="btn-modal-save">
                Save
            </button>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// API URLs - using Django URL reverse to avoid hardcoding
const REPORT_EXTRA_URL = "{% url 'ghg:report_extra_info_api' %}";

// Debug: Log the URL
console.log('REPORT_EXTRA_URL:', REPORT_EXTRA_URL);

function openReportDetailsModal() {
    console.log('openReportDetailsModal called');
    const modal = document.getElementById('reportDetailsModal');
    if (!modal) {
        console.error('reportDetailsModal not found in DOM');
        return;
    }
    
    console.log('Opening modal, loading existing data...');
    
    // Load existing data
    loadExistingReportData();
    
    modal.style.display = 'flex';
    console.log('Modal opened');
}

function loadExistingReportData() {
    fetch(REPORT_EXTRA_URL, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Loaded existing data:', data);
        // Populate form fields
        document.getElementById('rep_legal_name').value = data.legal_name || '';
        document.getElementById('rep_industry').value = data.industry || '';
        document.getElementById('rep_period').value = data.period || '';
        document.getElementById('rep_boundary').value = data.boundary || '';
        document.getElementById('rep_notes').value = data.notes || '';
        
        // Update checkboxes
        document.getElementById('share-org').checked = data.share_org_profile !== false;
        document.getElementById('share-boundary').checked = data.share_boundary !== false;
        document.getElementById('share-sources').checked = data.share_data_sources === true;
        document.getElementById('share-projects').checked = data.share_projects === true;
    })
    .catch(error => {
        console.error('Error loading existing data:', error);
        // Continue with empty form if loading fails
    });
}

function closeReportDetailsModal() {
    const modal = document.getElementById('reportDetailsModal');
    if (modal) modal.style.display = 'none';
}

// Close modal when clicking on backdrop
document.addEventListener('click', function(e) {
    const modal = document.getElementById('reportDetailsModal');
    if (!modal) return;
    if (modal.style.display === 'flex' && e.target === modal) {
        closeReportDetailsModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeReportDetailsModal();
    }
});

function saveReportDetails() {
    console.log('saveReportDetails called');
    
    // Collect form data
    const payload = {
        legal_name: document.getElementById('rep_legal_name').value,
        industry: document.getElementById('rep_industry').value,
        period: document.getElementById('rep_period').value,
        boundary: document.getElementById('rep_boundary').value,
        notes: document.getElementById('rep_notes').value,
        share_org_profile: document.getElementById('share-org').checked,
        share_boundary: document.getElementById('share-boundary').checked,
        share_data_sources: document.getElementById('share-sources').checked,
        share_projects: document.getElementById('share-projects').checked,
    };
    
    console.log('Report details payload:', payload);
    console.log('REPORT_EXTRA_URL:', REPORT_EXTRA_URL);
    
    // Get CSRF token - try multiple methods
    let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!csrfToken) {
        csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    }
    if (!csrfToken) {
        // Try to get from cookie
        csrfToken = getCookie('csrftoken');
    }
    
    if (!csrfToken) {
        alert('CSRF token not found. Please refresh the page and try again.');
        return;
    }
    
    // Send to backend API
    fetch(REPORT_EXTRA_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify(payload)
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            console.log('Success:', data);
            alert('Report details saved successfully!');
            closeReportDetailsModal();
        } else {
            console.error('Error:', data.error);
            alert('Error saving report details: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Network error:', error);
        alert('Network error: ' + error.message + '. Please try again.');
    });
}

// Helper function to get cookie value
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
{% endblock %}