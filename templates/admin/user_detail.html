{% extends 'base.html' %}
{% load static %}

{% block title %}User Details: {{ user_obj.username }} - Academia Carbon{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin-panel.css' %}">
{% endblock %}

{% block content %}
<div class="user-detail">
    <!-- User Header -->
    <div class="user-header">
        <div class="user-avatar">
            {{ user_obj.username|first|upper }}
        </div>
        <div class="user-info">
            <h1>{{ user_obj.get_full_name|default:user_obj.username }}</h1>
            <div class="user-meta">
                <span>ğŸ“§ {{ user_obj.email }}</span>
                <span>ğŸ“… Joined: {{ user_obj.date_joined|date:"Y/m/d" }}</span>
                <span>ğŸ• Last Login: {{ user_obj.last_login|date:"Y/m/d H:i"|default:"Never" }}</span>
                <span class="badge {% if user_obj.is_active %}verified{% else %}pending{% endif %}">
                    {% if user_obj.is_active %}Active{% else %}Inactive{% endif %}
                </span>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="action-buttons">
        <a href="{% url 'ghg:admin_user_list' %}" class="btn btn-primary">â† Back to List</a>
        <a href="{% url 'ghg:admin_export_user_data' user_obj.id %}" class="btn btn-success">ğŸ“Š Export Data</a>
        <button onclick="toggleUserStatus({{ user_obj.id }})" class="btn {% if user_obj.is_active %}btn-warning{% else %}btn-success{% endif %}">
            {% if user_obj.is_active %}ğŸ”’ Deactivate{% else %}âœ… Activate{% endif %}
        </button>
        <button onclick="deleteUserData({{ user_obj.id }})" class="btn btn-danger">ğŸ—‘ï¸ Delete Data</button>
    </div>
    
    <!-- General Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ emission_count }}</div>
            <div class="stat-label">Carbon Calculations</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ total_emissions_tons }}</div>
            <div class="stat-label">Total CO2 Tons</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ supplier_count }}</div>
            <div class="stat-label">Suppliers</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ custom_factor_count }}</div>
            <div class="stat-label">Custom Factors</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ request_count }}</div>
            <div class="stat-label">Requests</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-number">{{ uploaded_files|length }}</div>
            <div class="stat-label">ÙØ§ÛŒÙ„ Ø¢Ù¾Ù„ÙˆØ¯</div>
        </div>
    </div>
    
    <div class="two-column">
        <!-- Ø¢Ù…Ø§Ø± Scope -->
        <div class="section">
            <div class="section-header">ğŸ“Š Ø¢Ù…Ø§Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Scope</div>
            <div class="section-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Scope</th>
                            <th>ØªØ¹Ø¯Ø§Ø¯</th>
                            <th>Ø§Ù†ØªØ´Ø§Ø± (ØªÙ†)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for scope in scope_stats %}
                        <tr>
                            <td><span class="badge scope{{ scope.scope }}">Scope {{ scope.scope }}</span></td>
                            <td>{{ scope.count }}</td>
                            <td>{{ scope.emissions_tons }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ÙØ¹Ø§Ù„ÛŒØª Ù…Ø§Ù‡Ø§Ù†Ù‡ -->
        <div class="section">
            <div class="section-header">ğŸ“ˆ ÙØ¹Ø§Ù„ÛŒØª Ù…Ø§Ù‡Ø§Ù†Ù‡</div>
            <div class="section-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ù…Ø§Ù‡</th>
                            <th>Ø§Ù†ØªØ´Ø§Ø± (ØªÙ†)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for month in monthly_activity %}
                        <tr>
                            <td>{{ month.month }}</td>
                            <td>{{ month.emissions_tons }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø§Ø®ÛŒØ± -->
    <div class="section">
        <div class="section-header">âš¡ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø§Ø®ÛŒØ±</div>
        <div class="section-content">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ØªØ§Ø±ÛŒØ®</th>
                        <th>Ù…Ù†Ø¨Ø¹</th>
                        <th>Scope</th>
                        <th>Ø¯Ø§Ø¯Ù‡ ÙØ¹Ø§Ù„ÛŒØª</th>
                        <th>Ø§Ù†ØªØ´Ø§Ø± (kg)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for emission in recent_emissions %}
                    <tr>
                        <td>{{ emission.created_at|date:"Y/m/d H:i" }}</td>
                        <td>{{ emission.source_name }}</td>
                        <td><span class="badge scope{{ emission.scope }}">Scope {{ emission.scope }}</span></td>
                        <td>{{ emission.activity_data }} {{ emission.unit }}</td>
                        <td>{{ emission.emissions_kg|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align: center; color: #6b7280;">Ù…Ø­Ø§Ø³Ø¨Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- ØªØ§Ù…ÛŒÙ†â€ŒÚ©Ù†Ù†Ø¯Ú¯Ø§Ù† -->
    {% if suppliers %}
    <div class="section">
        <div class="section-header">ğŸ¢ ØªØ§Ù…ÛŒÙ†â€ŒÚ©Ù†Ù†Ø¯Ú¯Ø§Ù†</div>
        <div class="section-content">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ù†Ø§Ù…</th>
                        <th>Ù†ÙˆØ¹</th>
                        <th>Ú©Ø´ÙˆØ±</th>
                        <th>Ø§ÛŒÙ…ÛŒÙ„</th>
                        <th>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯</th>
                    </tr>
                </thead>
                <tbody>
                    {% for supplier in suppliers %}
                    <tr>
                        <td><strong>{{ supplier.name }}</strong></td>
                        <td>{{ supplier.supplier_type|default:"-" }}</td>
                        <td>{{ supplier.country|default:"-" }}</td>
                        <td>{{ supplier.email|default:"-" }}</td>
                        <td>{{ supplier.created_at|date:"Y/m/d" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    <!-- ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ -->
    {% if custom_factors %}
    <div class="section">
        <div class="section-header">ğŸ”§ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ</div>
        <div class="section-content">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ù†Ø§Ù…</th>
                        <th>Ù…Ù‚Ø¯Ø§Ø±</th>
                        <th>ÙˆØ§Ø­Ø¯</th>
                        <th>ÙˆØ¶Ø¹ÛŒØª</th>
                        <th>ØªØ§Ø±ÛŒØ®</th>
                    </tr>
                </thead>
                <tbody>
                    {% for factor in custom_factors %}
                    <tr>
                        <td><strong>{{ factor.name }}</strong></td>
                        <td>{{ factor.factor_value }}</td>
                        <td>{{ factor.unit }}</td>
                        <td>
                            <span class="badge {% if factor.is_verified %}verified{% else %}pending{% endif %}">
                                {% if factor.is_verified %}ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡{% else %}Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±{% endif %}
                            </span>
                        </td>
                        <td>{{ factor.created_at|date:"Y/m/d" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    <!-- ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù‡ -->
    {% if uploaded_files %}
    <div class="section">
        <div class="section-header">ğŸ“ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù‡</div>
        <div class="section-content">
            {% for file_info in uploaded_files %}
            <div class="file-item">
                <div class="file-icon">ğŸ“„</div>
                <div class="file-info">
                    <div class="file-name">{{ file_info.file.name|default:"ÙØ§ÛŒÙ„ Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…" }}</div>
                    <div class="file-meta">
                        Ø­Ø¬Ù…: {{ file_info.size|filesizeformat|default:"Ù†Ø§Ù…Ø´Ø®Øµ" }}
                        {% if file_info.record %}
                        - Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡: {{ file_info.record.source_name }}
                        {% elif file_info.factor %}
                        - Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡: {{ file_info.factor.name }}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¶Ø§ÙÛŒ Ú¯Ø²Ø§Ø±Ø´ -->
    {% if report_extra %}
    <div class="section">
        <div class="section-header">ğŸ“‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú¯Ø²Ø§Ø±Ø´</div>
        <div class="section-content">
            <table class="data-table">
                <tr>
                    <th style="width: 200px;">Ù†Ø§Ù… Ù‚Ø§Ù†ÙˆÙ†ÛŒ Ø³Ø§Ø²Ù…Ø§Ù†</th>
                    <td>{{ report_extra.legal_name|default:"-" }}</td>
                </tr>
                <tr>
                    <th>ØµÙ†Ø¹Øª</th>
                    <td>{{ report_extra.industry|default:"-" }}</td>
                </tr>
                <tr>
                    <th>Ø¯ÙˆØ±Ù‡ Ú¯Ø²Ø§Ø±Ø´</th>
                    <td>{{ report_extra.reporting_period|default:"-" }}</td>
                </tr>
                <tr>
                    <th>Ø±ÙˆÛŒÚ©Ø±Ø¯ Ù…Ø±Ø²Ø¨Ù†Ø¯ÛŒ</th>
                    <td>{{ report_extra.get_boundary_approach_display|default:"-" }}</td>
                </tr>
                <tr>
                    <th>ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§</th>
                    <td>{{ report_extra.notes|default:"-" }}</td>
                </tr>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
function toggleUserStatus(userId) {
    if (confirm('Ø¢ÛŒØ§ Ø§Ø² ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
        fetch(`/admin/users/${userId}/toggle-status/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±');
            }
        });
    }
}

function deleteUserData(userId) {
    if (confirm('âš ï¸ Ù‡Ø´Ø¯Ø§Ø±: Ø§ÛŒÙ† Ø¹Ù…Ù„ ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª!\n\nØ¢ÛŒØ§ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
        fetch(`/admin/users/${userId}/delete-data/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('ØªÙ…Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯');
                location.reload();
            } else {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±');
            }
        });
    }
}
</script>
{% endblock %}
