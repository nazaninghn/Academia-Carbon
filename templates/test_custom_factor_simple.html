<!DOCTYPE html>
<html>
<head>
    <title>Test Custom Factor - Simple</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        button { padding: 10px 20px; margin: 10px; cursor: pointer; }
        #result { background: #f5f5f5; padding: 10px; margin: 10px 0; white-space: pre-wrap; }
        .form-control { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; }
        .form-group { margin: 15px 0; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
    </style>
</head>
<body>
    <h1>Test Custom Factor Feature - Simple</h1>
    
    <div class="test-section">
        <h2>URL Test</h2>
        <p>Custom Factor Add URL: <strong id="url-display"></strong></p>
        <p>CSRF Token: <strong id="csrf-display"></strong></p>
        <button onclick="showURLs()">Show URLs & Token</button>
    </div>
    
    <div class="test-section">
        <h2>Direct API Test</h2>
        <button onclick="testAPI()">Test API with Fixed Data</button>
        <div id="result"></div>
    </div>
    
    <div class="test-section">
        <h2>Form Test</h2>
        <div class="form-group">
            <label>Material Name:</label>
            <input type="text" id="material-name" class="form-control" value="Test Material Browser">
        </div>
        <div class="form-group">
            <label>Category:</label>
            <select id="category" class="form-control">
                <option value="stationary">Stationary Combustion</option>
                <option value="mobile">Mobile Combustion</option>
                <option value="purchased-goods">Purchased Goods</option>
            </select>
        </div>
        <div class="form-group">
            <label>Emission Factor:</label>
            <input type="number" id="emission-factor" class="form-control" value="3.5" step="0.0001">
        </div>
        <div class="form-group">
            <label>Unit:</label>
            <select id="unit" class="form-control">
                <option value="kg">Kilograms (kg)</option>
                <option value="liters">Liters</option>
                <option value="m3">Cubic Meters (mÂ³)</option>
            </select>
        </div>
        <button onclick="testFormData()">Test with Form Data</button>
    </div>

    <script>
        // Django URLs
        const CUSTOM_FACTOR_ADD_URL = "{% url 'ghg:add_custom_factor' %}";
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        function showResult(message) {
            document.getElementById('result').textContent = message;
        }
        
        function showURLs() {
            document.getElementById('url-display').textContent = CUSTOM_FACTOR_ADD_URL;
            document.getElementById('csrf-display').textContent = getCookie('csrftoken') || 'NOT FOUND';
        }
        
        function testAPI() {
            const csrfToken = getCookie('csrftoken');
            const data = {
                material_name: 'Test Material Browser Direct',
                category: 'stationary',
                emission_factor: 4.5,
                unit: 'kg',
                source_reference: 'Browser direct test',
                description: 'Test from browser direct API call'
            };
            
            showResult('Testing API...\nURL: ' + CUSTOM_FACTOR_ADD_URL + '\nCSRF: ' + (csrfToken || 'MISSING'));
            
            fetch(CUSTOM_FACTOR_ADD_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            })
            .then(response => {
                showResult('Response Status: ' + response.status + '\nResponse OK: ' + response.ok);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error('HTTP ' + response.status + ': ' + text);
                    });
                }
                return response.json();
            })
            .then(data => {
                showResult('SUCCESS!\n' + JSON.stringify(data, null, 2));
            })
            .catch(error => {
                showResult('ERROR!\n' + error.message);
            });
        }
        
        function testFormData() {
            const csrfToken = getCookie('csrftoken');
            const data = {
                material_name: document.getElementById('material-name').value,
                category: document.getElementById('category').value,
                emission_factor: parseFloat(document.getElementById('emission-factor').value),
                unit: document.getElementById('unit').value,
                source_reference: 'Browser form test',
                description: 'Test from browser form'
            };
            
            showResult('Testing with form data...\n' + JSON.stringify(data, null, 2));
            
            fetch(CUSTOM_FACTOR_ADD_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error('HTTP ' + response.status + ': ' + text);
                    });
                }
                return response.json();
            })
            .then(data => {
                showResult('FORM TEST SUCCESS!\n' + JSON.stringify(data, null, 2));
            })
            .catch(error => {
                showResult('FORM TEST ERROR!\n' + error.message);
            });
        }
        
        // Auto-show URLs on load
        window.onload = function() {
            showURLs();
        };
    </script>
</body>
</html>