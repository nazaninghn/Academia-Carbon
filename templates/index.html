{% extends 'dashboard_base.html' %}
{% load static %}
{% load i18n %}

{% block page_title %}{% trans "Dashboard" %}{% endblock %}

{% block header_actions %}
<!-- Dashboard specific actions -->
<div style="display: flex; align-items: center; gap: 15px;">
    <div style="display: flex; align-items: center; gap: 8px;">
        <label style="font-size: 13px; font-weight: 600; color: #475569;">
            <i class="fas fa-calendar" style="color: #22c55e;"></i> {% trans "Period" %}:
        </label>
        <select id="period-selector" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; min-width: 120px; background: white;">
            <option value="2024" selected>2024</option>
            <option value="2023">2023</option>
            <option value="all">{% trans "All Time" %}</option>
        </select>
    </div>
    <button onclick="refreshDashboard()" style="padding: 8px 16px; background: #22c55e; color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer;">
        <i class="fas fa-sync-alt"></i> {% trans "Refresh" %}
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Professional Page Header -->
{% include 'partials/page_header.html' %}

<!-- Welcome Section -->
<div class="mb-8">
    <div style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <h2 class="text-2xl font-bold text-gray-900 mb-2">{% trans "Welcome back!" %} ðŸ‘‹</h2>
        <p class="text-gray-600">{% trans "Here's what's happening with your carbon emissions today." %}</p>
    </div>
</div>

<!-- Stats Grid -->
<div class="grid grid-auto-fit mb-8" id="dashboard-stats">
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">{% trans "Total Emissions" %}</div>
            <div class="stat-icon primary">
                <i class="fas fa-leaf"></i>
            </div>
        </div>
        <div class="stat-value" id="total-emissions">
            <div class="loading-spinner">{% trans "Loading..." %}</div>
        </div>
        <div class="stat-change" id="emissions-change">
            <i class="fas fa-sync fa-spin"></i>
            {% trans "Calculating..." %}
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">{% trans "Records Count" %}</div>
            <div class="stat-icon secondary">
                <i class="fas fa-chart-bar"></i>
            </div>
        </div>
        <div class="stat-value" id="records-count">
            <div class="loading-spinner">{% trans "Loading..." %}</div>
        </div>
        <div class="stat-change" id="records-change">
            <i class="fas fa-sync fa-spin"></i>
            {% trans "Calculating..." %}
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">{% trans "This Month" %}</div>
            <div class="stat-icon accent">
                <i class="fas fa-calendar"></i>
            </div>
        </div>
        <div class="stat-value" id="month-emissions">
            <div class="loading-spinner">{% trans "Loading..." %}</div>
        </div>
        <div class="stat-change" id="month-change">
            <i class="fas fa-sync fa-spin"></i>
            {% trans "Calculating..." %}
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-title">{% trans "Suppliers" %}</div>
            <div class="stat-icon primary">
                <i class="fas fa-building"></i>
            </div>
        </div>
        <div class="stat-value" id="suppliers-count">
            <div class="loading-spinner">{% trans "Loading..." %}</div>
        </div>
        <div class="stat-change">
            {% trans "Active suppliers" %}
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-2 gap-6 mb-8">
    <div class="card">
        <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900">{% trans "Emissions by Scope" %}</h3>
            <p class="text-sm text-gray-600">{% trans "Distribution across Scope 1, 2, and 3" %}</p>
        </div>
        <div class="card-body">
            <canvas id="scopeChart" width="400" height="200"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900">{% trans "Monthly Trends" %}</h3>
            <p class="text-sm text-gray-600">{% trans "Emission trends over the last 6 months" %}</p>
        </div>
        <div class="card-body">
            <canvas id="trendsChart" width="400" height="200"></canvas>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="card mb-8">
    <div class="card-header">
        <h2 class="text-xl font-semibold text-gray-900">{% trans "Quick Actions" %}</h2>
        <p class="text-sm text-gray-600">{% trans "Get started with common tasks" %}</p>
    </div>
    <div class="card-body">
        <div class="grid grid-cols-2 gap-4">
            <a href="{% url 'ghg:data_entry' %}" class="btn btn-primary btn-lg">
                <i class="fas fa-plus"></i>
                {% trans "Add Emission Data" %}
            </a>
            <a href="/en/reporting/inventory" class="btn btn-secondary btn-lg">
                <i class="fas fa-file-alt"></i>
                {% trans "Generate Report" %}
            </a>
            <a href="{% url 'ghg:analysis' %}" class="btn btn-outline btn-lg">
                <i class="fas fa-chart-line"></i>
                {% trans "View Analysis" %}
            </a>
            <a href="{% url 'ghg:emission_history' %}" class="btn btn-ghost btn-lg">
                <i class="fas fa-history"></i>
                {% trans "View History" %}
            </a>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="grid grid-cols-2 gap-6">
    <div class="card">
        <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900">{% trans "Recent Activity" %}</h3>
        </div>
        <div class="card-body">
            <div class="space-y-4">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-plus text-green-600 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">{% trans "New emission record added" %}</p>
                        <p class="text-xs text-gray-500">{% trans "2 hours ago" %}</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-file-alt text-blue-600 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">{% trans "Report generated" %}</p>
                        <p class="text-xs text-gray-500">{% trans "1 day ago" %}</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-purple-600 text-sm"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">{% trans "Analysis completed" %}</p>
                        <p class="text-xs text-gray-500">{% trans "3 days ago" %}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="text-lg font-semibold text-gray-900">{% trans "Tips & Insights" %}</h3>
        </div>
        <div class="card-body">
            <div class="space-y-4">
                <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-lightbulb text-green-600 mt-1"></i>
                        <div>
                            <h4 class="text-sm font-semibold text-green-900">{% trans "Reduce Scope 2 Emissions" %}</h4>
                            <p class="text-xs text-green-700 mt-1">{% trans "Consider switching to renewable energy sources to lower your electricity-based emissions." %}</p>
                        </div>
                    </div>
                </div>
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-chart-bar text-blue-600 mt-1"></i>
                        <div>
                            <h4 class="text-sm font-semibold text-blue-900">{% trans "Track Progress" %}</h4>
                            <p class="text-xs text-blue-700 mt-1">{% trans "Set monthly targets and monitor your emission reduction progress over time." %}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Dashboard functionality
let scopeChart = null;
let trendsChart = null;

// Load dashboard data
async function loadDashboardData() {
    try {
        const response = await fetch('/api/dashboard/', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch dashboard data');
        }
        
        const data = await response.json();
        updateDashboardStats(data);
        updateCharts(data);
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showErrorState();
    }
}

// Update KPI cards with real data
function updateDashboardStats(data) {
    // Total emissions
    document.getElementById('total-emissions').textContent = 
        data.total_emissions_tons ? `${data.total_emissions_tons.toFixed(2)} t COâ‚‚e` : '0.00 t COâ‚‚e';
    
    // Records count
    document.getElementById('records-count').textContent = data.total_records || '0';
    
    // This month emissions
    document.getElementById('month-emissions').textContent = 
        data.current_month_tons ? `${data.current_month_tons.toFixed(2)} t COâ‚‚e` : '0.00 t COâ‚‚e';
    
    // Suppliers count
    document.getElementById('suppliers-count').textContent = data.suppliers_count || '0';
    
    // Update change indicators
    updateChangeIndicators(data);
}

// Update change indicators with percentage changes
function updateChangeIndicators(data) {
    const emissionsChange = document.getElementById('emissions-change');
    const recordsChange = document.getElementById('records-change');
    const monthChange = document.getElementById('month-change');
    
    // Calculate month-over-month changes
    const emissionsPct = data.emissions_change_pct || 0;
    const recordsPct = data.records_change_pct || 0;
    const monthPct = data.month_change_pct || 0;
    
    // Update emissions change
    emissionsChange.innerHTML = `
        <i class="fas fa-arrow-${emissionsPct >= 0 ? 'up' : 'down'}"></i>
        ${Math.abs(emissionsPct).toFixed(1)}% from last month
    `;
    emissionsChange.className = `stat-change ${emissionsPct <= 0 ? 'positive' : 'negative'}`;
    
    // Update records change
    recordsChange.innerHTML = `
        <i class="fas fa-arrow-${recordsPct >= 0 ? 'up' : 'down'}"></i>
        ${Math.abs(recordsPct).toFixed(1)}% from last month
    `;
    recordsChange.className = `stat-change ${recordsPct >= 0 ? 'positive' : 'negative'}`;
    
    // Update month change
    monthChange.innerHTML = `
        <i class="fas fa-calendar"></i>
        Current month progress
    `;
}

// Update charts with real data
function updateCharts(data) {
    updateScopeChart(data.scope_breakdown || []);
    updateTrendsChart(data.monthly_trends || []);
}

// Create/update scope distribution pie chart
function updateScopeChart(scopeData) {
    const ctx = document.getElementById('scopeChart').getContext('2d');
    
    if (scopeChart) {
        scopeChart.destroy();
    }
    
    const labels = scopeData.map(item => item.scope);
    const values = scopeData.map(item => item.value_t);
    const colors = ['#10b981', '#3b82f6', '#f59e0b'];
    
    scopeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const percentage = ((context.parsed / values.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed.toFixed(2)} t COâ‚‚e (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Create/update monthly trends line chart
function updateTrendsChart(trendsData) {
    const ctx = document.getElementById('trendsChart').getContext('2d');
    
    if (trendsChart) {
        trendsChart.destroy();
    }
    
    const labels = trendsData.map(item => item.month);
    const values = trendsData.map(item => item.emissions_tons);
    
    trendsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Emissions (t COâ‚‚e)',
                data: values,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#10b981',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return `${context.parsed.y.toFixed(2)} t COâ‚‚e`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + ' t';
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

// Show error state when data loading fails
function showErrorState() {
    document.getElementById('total-emissions').textContent = 'Error';
    document.getElementById('records-count').textContent = 'Error';
    document.getElementById('month-emissions').textContent = 'Error';
    document.getElementById('suppliers-count').textContent = 'Error';
    
    document.getElementById('emissions-change').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Unable to load';
    document.getElementById('records-change').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Unable to load';
    document.getElementById('month-change').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Unable to load';
}

// Refresh dashboard data
function refreshDashboard() {
    // Show loading state
    document.querySelectorAll('.stat-value').forEach(el => {
        el.innerHTML = '<div class="loading-spinner">{% trans "Loading..." %}</div>';
    });
    
    document.querySelectorAll('.stat-change').forEach(el => {
        el.innerHTML = '<i class="fas fa-sync fa-spin"></i> Calculating...';
    });
    
    // Reload data
    loadDashboardData();
}

// Initialize dashboard when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
});

// Add loading spinner styles
const style = document.createElement('style');
style.textContent = `
    .loading-spinner {
        color: #9ca3af;
        font-size: 14px;
        font-weight: 500;
    }
    
    .stat-change.positive {
        color: #10b981;
    }
    
    .stat-change.negative {
        color: #ef4444;
    }
    
    .stat-change {
        color: #6b7280;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}