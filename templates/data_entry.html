{% extends 'dashboard_base.html' %}
{% load static %}
{% load i18n %}

{% block page_title %}{% trans "Data Collection" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/data-entry-responsive.css' %}">
<style>
    .scope-tabs {
        display: flex;
        gap: 0;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 30px;
    }

    .scope-tab {
        padding: 12px 24px;
        background: transparent;
        border: none;
        color: #666;
        font-weight: 600;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
        font-size: 14px;
    }

    .scope-tab:hover {
        color: #22c55e;
    }

    .scope-tab.active {
        color: #22c55e;
        border-bottom-color: #22c55e;
    }

    .scope-content {
        display: none;
    }

    .scope-content.active {
        display: block;
    }

    .form-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 20px;
    }

    .emission-category {
        padding: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .emission-category:hover {
        border-color: #22c55e;
        background: #f0fdf4;
    }

    .emission-category h3 {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .emission-category p {
        font-size: 13px;
        color: #666;
        margin: 5px 0 0 0;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }

    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
    }

    .form-control:focus {
        outline: none;
        border-color: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    }

    .form-control::placeholder {
        color: #999;
    }

    .btn-calculate {
        background: #22c55e;
        color: white;
        border: none;
        padding: 12px 32px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        float: right;
    }

    .btn-calculate:hover {
        background: #16a34a;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    .activity-input {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .activity-input input {
        flex: 1;
    }

    .activity-input button {
        background: #22c55e;
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 18px;
    }

    .activity-input button:hover {
        background: #16a34a;
    }
</style>
{% endblock %}

{% block content %}
<!-- Professional Page Header -->
<div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-bottom: 1px solid #e2e8f0; padding: 24px 30px; margin-bottom: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="font-size: 28px; font-weight: 700; color: #1e293b; margin: 0 0 8px 0;">{% trans "Data Collection" %}</h1>
            <p style="color: #64748b; margin: 0; font-size: 14px;">
                <span style="margin-right: 20px;"><strong>{% trans "Organization" %}:</strong> {{ user.username|title }}</span>
                <span style="margin-right: 20px;"><strong>{% trans "Period" %}:</strong> 2024</span>
                <span><strong>{% trans "Standard" %}:</strong> ISO 14064-1</span>
            </p>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <!-- Country Selector -->
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-size: 13px; font-weight: 600; color: #475569;">
                    <i class="fas fa-globe" style="color: #22c55e;"></i> {% trans "Country" %}:
                </label>
                <select id="country-selector" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; min-width: 160px; background: white;">
                    <option value="global">üåç {% trans "Global Average" %}</option>
                    <option value="turkey" selected>üáπüá∑ {% trans "Turkey" %}</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">

        <!-- Scope Tabs -->
        <div class="scope-tabs">
            <button class="scope-tab active" onclick="switchScope(1)">{% trans "Scope 1" %}</button>
            <button class="scope-tab" onclick="switchScope(2)">{% trans "Scope 2" %}</button>
            <button class="scope-tab" onclick="switchScope(3)">{% trans "Scope 3" %}</button>
        </div>

        <!-- Scope 1 Content -->
        <div class="scope-content active" id="scope1">
            <div class="form-card">
                <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">{% trans "Scope 1 - Direct Emissions" %}</h2>
                
                <div class="emission-category" onclick="toggleCategory('stationary')">
                    <h3>
                        {% trans "Stationary combustion" %}
                        <i class="fas fa-chevron-down"></i>
                    </h3>
                    <p>{% trans "Emissions from fuel combustion in stationary equipment" %}</p>
                </div>

                <div id="stationary-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control" id="stationary-source" onchange="updateStationaryFields(); handleOtherSelection(this, 'stationary')">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <option value="coal-industrial">{% trans "Coal (industrial) - Defra 2024" %}</option>
                            <option value="coal">{% trans "Coal (generic) - IPCC 2006" %}</option>
                            <option value="gas-diesel-oil-energy">{% trans "Gas/Diesel Oil (energy basis) - IPCC 2019" %}</option>
                            <option value="lpg">{% trans "Liquefied Petroleum Gas (LPG) - Defra 2024" %}</option>
                            <option value="propane">{% trans "Propane - Defra 2024" %}</option>
                            <option value="motor-gasoline">{% trans "Motor Gasoline - IPCC 2019" %}</option>
                            <option value="natural-gas">{% trans "Natural Gas - IPCC 2019" %}</option>
                            <option value="diesel">{% trans "Diesel (volume) - IPCC 2006" %}</option>
                            <option value="fuel-oil">{% trans "Fuel Oil - IPCC 2006" %}</option>
                            <option value="other">üìù {% trans "Other / Not Listed" %}</option>
                        </select>
                        <p class="text-muted" style="font-size: 12px; margin-top: 8px;">
                            <i class="fas fa-info-circle"></i> {% trans "Calculate your emissions more precisely by accessing additional emission sources with the Booster Plan." %} 
                            <a href="#" style="color: #22c55e;">{% trans "Learn more" %}</a>
                        </p>
                    </div>

                    <!-- Industry Type (for all emission sources) -->
                    <div class="form-group" id="industry-type-group" style="display: none;">
                        <label>{% trans "Industry Type" %}</label>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1; position: relative;">
                                <select class="form-control" id="stationary-industry-type" style="flex: 1;">
                                    <option value="">{% trans "Loading industry types..." %}</option>
                                </select>
                                <input type="text" id="industry-search" class="form-control" placeholder="{% trans 'Search industries...' %}" style="display: none; margin-top: 5px; font-size: 13px;">
                            </div>
                            <button type="button" class="btn-add-industry" onclick="showAddIndustryModal()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; white-space: nowrap;">
                                <i class="fas fa-plus"></i> {% trans "Add Industry" %}
                            </button>
                        </div>
                        <p class="text-muted" style="font-size: 12px; margin-top: 8px;">
                            <i class="fas fa-info-circle"></i> {% trans "Don't see your industry? Click 'Add Industry' to request a new one." %}
                        </p>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Unit" %}</label>
                        <select class="form-control" id="stationary-unit">
                            <option value="">{% trans "Select Unit" %}</option>
                            <option value="liters">{% trans "Liters" %}</option>
                            <option value="kg">{% trans "Kilograms" %}</option>
                            <option value="m3">{% trans "Cubic Meters (m¬≥)" %}</option>
                            <option value="kwh">{% trans "kWh" %}</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Activity Data" %}</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" id="stationary-activity" placeholder="{% trans 'Enter activity data' %}" value="0">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Supplier (Optional)" %}</label>
                        <div style="display: flex; gap: 10px;">
                            <select class="form-control supplier-select" id="stationary-supplier" style="flex: 1;">
                                <option value="">{% trans "Select Supplier" %}</option>
                            </select>
                            <button type="button" class="btn-add-supplier" onclick="showAddSupplierModal()" style="background: #0ea5e9; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; white-space: nowrap;">
                                <i class="fas fa-plus"></i> {% trans "Add" %}
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Description (Optional)" %} <span class="text-muted">0/100</span></label>
                        <textarea class="form-control" id="stationary-description" rows="3" maxlength="100" placeholder="{% trans 'Add description' %}"></textarea>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Proof Document (Optional)" %} <span class="text-muted">{% trans "PDF, DOC, DOCX - Max 10MB" %}</span></label>
                        <input type="file" class="form-control" id="stationary-proof-document" accept=".pdf,.doc,.docx,.txt" style="padding: 8px;">
                        <p class="text-muted" style="font-size: 12px; margin-top: 5px;">
                            {% trans "Upload supporting documents like gas bills, invoices, etc." %}
                        </p>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>

                <div class="emission-category" onclick="toggleCategory('mobile')">
                    <h3>
                        {% trans "Mobile combustion" %}
                        <i class="fas fa-chevron-down"></i>
                    </h3>
                    <p>{% trans "Emissions from fuel combustion in mobile equipment" %}</p>
                </div>

                <div id="mobile-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control" id="mobile-source" onchange="updateMobileFields(); handleOtherSelection(this, 'mobile')">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <option value="off-road-ipcc">Off-Road Equipment - IPCC 2019</option>
                            <option value="off-road-diesel">Off-Road Diesel - DESNZ 2024</option>
                            <option value="off-road-gasoline">Off-Road Gasoline - DESNZ 2024</option>
                            <option value="on-road-diesel">On-Road Diesel - IPCC 2019</option>
                            <option value="on-road-gasoline-low-mileage">On-Road Gasoline (Low Mileage) - IPCC 2019</option>
                            <option value="on-road-gasoline-uncontrolled">On-Road Gasoline (Uncontrolled) - IPCC 2019</option>
                            <option value="on-road-gasoline-oxidation">On-Road Gasoline (Oxidation Catalyst) - IPCC 2019</option>
                            <option value="on-road-natural-gas">On-Road Natural Gas - IPCC 2019</option>
                            <option value="on-road-lpg">On-Road LPG - IPCC 2019</option>
                            <option value="on-road-petrol-desnz">On-Road Petrol - DESNZ 2024</option>
                            <option value="on-road-diesel-desnz">On-Road Diesel - DESNZ 2024</option>
                            <option value="gasoline">Gasoline (generic)</option>
                            <option value="diesel">Diesel (generic)</option>
                            <option value="cng">CNG</option>
                            <option value="vehicle-km">Vehicle distance (avg car)</option>
                            <option value="other">üìù Other / Not Listed</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Unit" %}</label>
                        <select class="form-control" id="mobile-unit">
                            <option value="">{% trans "Select Unit" %}</option>
                            <option value="liters">{% trans "Liters" %}</option>
                            <option value="kg">{% trans "Kilograms" %}</option>
                            <option value="gj">{% trans "Gigajoules (GJ)" %}</option>
                            <option value="km">{% trans "Kilometers" %}</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Activity Data" %}</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" id="mobile-activity" placeholder="{% trans 'Enter activity data' %}" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Supplier (Optional)" %}</label>
                        <div style="display: flex; gap: 10px;">
                            <select class="form-control supplier-select" id="mobile-supplier" style="flex: 1;">
                                <option value="">{% trans "Select Supplier" %}</option>
                            </select>
                            <button type="button" class="btn-add-supplier" onclick="showAddSupplierModal()" style="background: #0ea5e9; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; white-space: nowrap;">
                                <i class="fas fa-plus"></i>{% trans "Add" %}</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Description (Optional)" %}<span class="text-muted">0/100</span></label>
                        <textarea class="form-control" id="mobile-description" rows="3" maxlength="100" placeholder="{% trans 'Add description' %}"></textarea>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Proof Document (Optional)" %} <span class="text-muted">{% trans "PDF, DOC, DOCX - Max 10MB" %}</span></label>
                        <input type="file" class="form-control" id="mobile-proof-document" accept=".pdf,.doc,.docx,.txt" style="padding: 8px;">
                        <p class="text-muted" style="font-size: 12px; margin-top: 5px;">
                            {% trans "Upload supporting documents like fuel receipts, invoices, etc." %}
                        </p>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>

                <div class="emission-category" onclick="toggleCategory('fugitive')">
                    <h3>
                        Fugitive emissions
                        <i class="fas fa-chevron-down"></i>
                    </h3>
                    <p>Emissions from refrigerants, air conditioning, and other sources</p>
                </div>

                <div id="fugitive-form" style="display: none;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control" id="fugitive-source" onchange="handleOtherSelection(this, 'fugitive')">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <option value="r410a">R-410A (Refrigerant) - Defra 2024</option>
                            <option value="r432a">R-432A (Refrigerant) - Defra 2024</option>
                            <option value="r22">R-22 (HCFC-22) - Defra 2024</option>
                            <option value="hfc-227ea">HFC-227ea - Defra 2024</option>
                            <option value="r600a">R-600a (Isobutane) - Defra 2024</option>
                            <option value="methane">Methane (CH4) - IPCC AR6</option>
                            <option value="other">üìù Other / Not Listed</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans 'Unit' %}</label>
                        <select class="form-control" id="fugitive-unit" disabled>
                            <option value="kg">Kilograms (kg)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Activity Data" %}</label>
                        <div class="activity-input">
                            <button type="button" onclick="adjustValue(this, -1)">‚àí</button>
                            <input type="number" class="form-control" id="fugitive-activity" placeholder="{% trans 'Enter activity data' %}" value="0" min="0" step="0.1">
                            <button type="button" onclick="adjustValue(this, 1)">+</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Supplier (Optional)" %}</label>
                        <div style="display: flex; gap: 10px;">
                            <select class="form-control supplier-select" id="fugitive-supplier" style="flex: 1;">
                                <option value="">{% trans "Select Supplier" %}</option>
                            </select>
                            <button type="button" class="btn-add-supplier" onclick="showAddSupplierModal()" style="background: #0ea5e9; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; white-space: nowrap;">
                                <i class="fas fa-plus"></i>{% trans "Add" %}</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Description <span style="color: #999; font-weight: normal;">(Optional)</span></label>
                        <textarea class="form-control" id="fugitive-description" placeholder="{% trans 'Add description' %}" rows="3" maxlength="500"></textarea>
                        <small class="form-text text-muted" style="text-align: right; display: block;">
                            <span id="fugitive-char-count">0</span>/500
                        </small>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Proof Document (Optional)" %} <span class="text-muted">{% trans "PDF, DOC, DOCX - Max 10MB" %}</span></label>
                        <input type="file" class="form-control" id="fugitive-proof-document" accept=".pdf,.doc,.docx,.txt" style="padding: 8px;">
                        <p class="text-muted" style="font-size: 12px; margin-top: 5px;">
                            {% trans "Upload supporting documents like maintenance records, etc." %}
                        </p>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>
            </div>
        </div>

        <!-- Scope 2 Content -->
        <div class="scope-content" id="scope2">
            <div class="form-card">
                <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">Scope 2 - Indirect Emissions (Energy)</h2>
                
                <div class="emission-category" onclick="toggleCategory('electricity')">
                    <h3>
                        Electricity
                        <i class="fas fa-chevron-down help-icon" title="Emissions from purchased electricity"></i>
                    </h3>
                    <p>{% trans 'Emissions from purchased electricity consumption' %}</p>
                </div>

                <div id="electricity-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control" id="electricity-source">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <option value="turkey-grid">üáπüá∑ Turkey National Grid</option>
                            <option value="grid-average">üåç Grid Average (Global)</option>
                            <option value="us-grid">üá∫üá∏ US Grid</option>
                            <option value="eu-grid">üá™üá∫ EU Grid</option>
                            <option value="china-grid">üá®üá≥ China Grid</option>
                            <option value="renewable">‚ôªÔ∏è 100% Renewable Energy</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans 'Unit' %}</label>
                        <select class="form-control" disabled>
                            <option value="kwh">kWh</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Activity Data" %}</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="{% trans 'Enter activity data' %}" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Supplier (Optional)" %}</label>
                        <select class="form-control">
                            <option value="">{% trans "Select Supplier" %}</option>
                            <option value="supplier1">Electric Company 1</option>
                            <option value="supplier2">Electric Company 2</option>
                            <option value="supplier3">Electric Company 3</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Description (Optional)" %}<span class="text-muted">0/100</span></label>
                        <textarea class="form-control" rows="3" maxlength="100" placeholder="{% trans 'Add description' %}"></textarea>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Proof Document (Optional)" %} <span class="text-muted">{% trans "PDF, DOC, DOCX - Max 10MB" %}</span></label>
                        <input type="file" class="form-control" id="electricity-proof-document" accept=".pdf,.doc,.docx,.txt" style="padding: 8px;">
                        <p class="text-muted" style="font-size: 12px; margin-top: 5px;">
                            {% trans "Upload supporting documents like electricity bills, invoices, etc." %}
                        </p>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>

                <div class="emission-category" onclick="toggleCategory('steam-heat')">
                    <h3>
                        Steam, Heat and Cooling
                        <i class="fas fa-chevron-down help-icon" title="Emissions from purchased steam, heat, or cooling"></i>
                    </h3>
                    <p>Emissions from purchased steam, heating, or cooling energy</p>
                </div>

                <div id="steam-heat-form" style="display: none;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control" id="steam-heat-source">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <option value="district-heating">{% trans 'District Heating' %}</option>
                            <option value="district-cooling">{% trans 'District Cooling' %}</option>
                            <option value="steam">{% trans 'Steam' %}</option>
                            <option value="chilled-water">{% trans 'Chilled Water' %}</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans 'Unit' %}</label>
                        <select class="form-control">
                            <option value="">{% trans "Select Unit" %}</option>
                            <option value="kwh">kWh</option>
                            <option value="mj">MJ (Megajoules)</option>
                            <option value="mmbtu">{% trans 'MMBtu' %}</option>
                            <option value="tons">{% trans 'Tons' %}</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Activity Data" %}</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="{% trans 'Enter activity data' %}" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Supplier (Optional)" %}</label>
                        <select class="form-control">
                            <option value="">{% trans "Select Supplier" %}</option>
                            <option value="supplier1">Energy Provider 1</option>
                            <option value="supplier2">Energy Provider 2</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Description (Optional)" %}<span class="text-muted">0/100</span></label>
                        <textarea class="form-control" rows="3" maxlength="100" placeholder="{% trans 'Add description' %}"></textarea>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Proof Document (Optional)" %} <span class="text-muted">{% trans "PDF, DOC, DOCX - Max 10MB" %}</span></label>
                        <input type="file" class="form-control" id="steam-heat-proof-document" accept=".pdf,.doc,.docx,.txt" style="padding: 8px;">
                        <p class="text-muted" style="font-size: 12px; margin-top: 5px;">
                            {% trans "Upload supporting documents like energy bills, invoices, etc." %}
                        </p>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>
            </div>
        </div>

        <!-- Scope 3 Content -->
        <div class="scope-content" id="scope3">
            <div class="form-card">
                <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">Scope 3 - Other Indirect Emissions</h2>
                
                <!-- Purchased Goods and Services -->
                <div class="emission-category" onclick="toggleCategory('purchased-goods')">
                    <h3>
                        Purchased Goods and Services
                        <i class="fas fa-chevron-down help-icon" title="Emissions from purchased goods and services"></i>
                    </h3>
                    <p>{% trans 'Emissions from production of purchased goods and services' %}</p>
                </div>

                <div id="purchased-goods-form" style="display: none; margin-bottom: 30px;">
                    <!-- Custom Factor & Request Material Buttons -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                        <button type="button" onclick="showCustomFactorModal()" style="flex: 1; background: #22c55e; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                            <i class="fas fa-calculator"></i> Use Custom Factor
                        </button>
                        <button type="button" onclick="showRequestMaterialModal()" style="flex: 1; background: #3b82f6; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                            <i class="fas fa-paper-plane"></i> {% trans "Request New Material" %}
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control" id="purchased-goods-source" onchange="handlePurchasedGoodsSourceChange(this)">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <optgroup label="Turkey-Specific (ATOM KABLO ISO 14064-1)">
                                <option value="chemical">{% trans 'Chemical' %}</option>
                                <option value="chemical-oil">{% trans 'Chemical Oil' %}</option>
                                <option value="plastic">{% trans 'Plastic' %}</option>
                                <option value="carton">{% trans 'Carton' %}</option>
                                <option value="metal-primary">Metal (Primary)</option>
                                <option value="metal-recycled">Metal (Recycled)</option>
                                <option value="wood">{% trans 'Wood' %}</option>
                                <option value="foam-tape">{% trans 'Foam Tape' %}</option>
                            </optgroup>
                            <optgroup label="Global (Defra 2024)">
                                <option value="electrical-large">Electrical Items - Large</option>
                                <option value="electrical-small">Electrical Items - Small</option>
                                <option value="electrical-fridges-freezers">Electrical Items - Fridges & Freezers</option>
                                <option value="electrical-it">Electrical Items - IT</option>
                                <option value="glass">{% trans 'Glass' %}</option>
                                <option value="metal-aluminium-cans-foil">{% trans 'Metal' %}: Aluminium Cans & Foil</option>
                                <option value="metal-mixed-cans">{% trans 'Metal' %}: Mixed Cans</option>
                                <option value="metal-steel-cans">{% trans 'Metal' %}: Steel Cans</option>
                                <option value="mineral-oil">{% trans 'Mineral Oil' %}</option>
                                <option value="paper-mixed">Paper & Board: Mixed</option>
                                <option value="plastic-average">Plastics: Average</option>
                                <option value="plastic-hdpe">Plastics: HDPE</option>
                            </optgroup>
                            <optgroup label="Custom Factors" id="custom-factors-optgroup" style="display: none;">
                                <!-- Custom factors will be loaded here dynamically -->
                            </optgroup>
                            <optgroup label="Other">
                                <option value="other">üìù Other / Not Listed</option>
                            </optgroup>
                        </select>
                        <p style="font-size: 12px; color: #666; margin-top: 8px;">
                            <i class="fas fa-info-circle"></i> Can't find your material? Select "Other" or use buttons above.
                        </p>
                    </div>

                    <div class="form-group">
                        <label>{% trans 'Unit' %}</label>
                        <select class="form-control">
                            <option value="">{% trans "Select Unit" %}</option>
                            <option value="kg">{% trans 'Kilograms' %}</option>
                            <option value="units">Units</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Activity Data" %}</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="{% trans 'Enter activity data' %}" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Supplier (Optional)" %}</label>
                        <select class="form-control">
                            <option value="">{% trans "Select Supplier" %}</option>
                            <option value="supplier1">Supplier 1</option>
                            <option value="supplier2">Supplier 2</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Description (Optional)" %}<span class="text-muted">0/100</span></label>
                        <textarea class="form-control" rows="3" maxlength="100" placeholder="{% trans 'Add description' %}"></textarea>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Proof Document (Optional)" %} <span class="text-muted">{% trans "PDF, DOC, DOCX - Max 10MB" %}</span></label>
                        <input type="file" class="form-control" id="scope3-proof-document" accept=".pdf,.doc,.docx,.txt" style="padding: 8px;">
                        <p class="text-muted" style="font-size: 12px; margin-top: 5px;">
                            {% trans "Upload supporting documents like receipts, invoices, etc." %}
                        </p>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Capital Goods -->
                <div class="emission-category" onclick="toggleCategory('capital-goods')">
                    <h3>
                        Capital Goods
                        <i class="fas fa-chevron-down help-icon" title="Emissions from capital goods"></i>
                    </h3>
                    <p>Emissions from production of capital goods (machinery, vehicles, buildings)</p>
                </div>

                <div id="capital-goods-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <option value="machinery">Machinery</option>
                            <option value="vehicles">Vehicles</option>
                            <option value="buildings">Buildings/Construction</option>
                            <option value="it-equipment">IT Equipment</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans 'Unit' %}</label>
                        <select class="form-control">
                            <option value="">{% trans "Select Unit" %}</option>
                            <option value="units">Units</option>
                            <option value="m2">Square Meters (m¬≤)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Activity Data" %}</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="{% trans 'Enter activity data' %}" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Fuel and Energy Related Activities -->
                <div class="emission-category" onclick="toggleCategory('fuel-energy')">
                    <h3>
                        Fuel and Energy Related Activities
                        <i class="fas fa-chevron-down help-icon" title="Upstream emissions from fuel and energy"></i>
                    </h3>
                    <p>Upstream emissions from fuel extraction, processing, and transmission losses</p>
                </div>

                <div id="fuel-energy-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <option value="upstream-electricity">Upstream Electricity</option>
                            <option value="transmission-losses">Transmission & Distribution Losses</option>
                            <option value="fuel-extraction">Fuel Extraction & Processing</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans 'Unit' %}</label>
                        <select class="form-control">
                            <option value="">{% trans "Select Unit" %}</option>
                            <option value="kwh">kWh</option>
                            <option value="liters">{% trans 'Liters' %}</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Activity Data" %}</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="{% trans 'Enter activity data' %}" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Upstream Transportation and Distribution -->
                <div class="emission-category" onclick="toggleCategory('upstream-transport')">
                    <h3>
                        Upstream Transportation and Distribution
                        <i class="fas fa-chevron-down help-icon" title="Transportation of purchased goods"></i>
                    </h3>
                    <p>Emissions from transportation and distribution of purchased goods</p>
                </div>

                <div id="upstream-transport-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <option value="truck-freight">Truck Freight</option>
                            <option value="rail-freight">Rail Freight</option>
                            <option value="sea-freight">Sea Freight</option>
                            <option value="air-freight">Air Freight</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans 'Unit' %}</label>
                        <select class="form-control" disabled>
                            <option value="tonne-km">Tonne-km</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data (tonne-km)</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="{% trans 'Enter activity data' %}" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Water Supply and Treatment -->
                <div class="emission-category" onclick="toggleCategory('water')">
                    <h3>
                        Water Supply and Treatment
                        <i class="fas fa-chevron-down help-icon" title="Emissions from water supply and wastewater treatment"></i>
                    </h3>
                    <p>Emissions from water supply and wastewater treatment (Defra 2024)</p>
                </div>

                <div id="water-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control" id="water-source">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <option value="supply">Water Supply - Defra 2024</option>
                            <option value="treatment">Wastewater Treatment - Defra 2024</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans 'Unit' %}</label>
                        <select class="form-control" disabled>
                            <option value="m3">Cubic Meters (m¬≥)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data (m¬≥)</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="{% trans 'Enter volume' %}" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Supplier (Optional)" %}</label>
                        <div style="display: flex; gap: 10px;">
                            <select class="form-control supplier-select" id="water-supplier" style="flex: 1;">
                                <option value="">{% trans "Select Supplier" %}</option>
                            </select>
                            <button type="button" class="btn-add-supplier" onclick="showAddSupplierModal()" style="background: #0ea5e9; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; white-space: nowrap;">
                                <i class="fas fa-plus"></i>{% trans "Add" %}</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Description (Optional)" %}<span class="text-muted">0/100</span></label>
                        <textarea class="form-control" rows="3" maxlength="100" placeholder="{% trans 'Add description' %}"></textarea>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Waste Generated in Operations -->
                <div class="emission-category" onclick="toggleCategory('waste')">
                    <h3>
                        Waste Generated in Operations
                        <i class="fas fa-chevron-down help-icon" title="Emissions from waste disposal"></i>
                    </h3>
                    <p>Emissions from disposal and treatment of waste generated in operations</p>
                </div>

                <div id="waste-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control" id="waste-source" onchange="handleOtherSelection(this, 'waste')">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <optgroup label="Turkey">
                                <option value="landfill">Landfill (Turkey)</option>
                                <option value="recyclable">Recyclable (Turkey)</option>
                                <option value="organic-compost">Organic Compost (Turkey)</option>
                                <option value="incineration">Incineration (Turkey)</option>
                            </optgroup>
                            <optgroup label="Global">
                                <option value="general-landfill">General Waste (Landfill)</option>
                                <option value="recyclable">Recyclable Waste</option>
                                <option value="organic-compost">Organic Waste (Compost)</option>
                                <option value="incineration">Waste Incineration</option>
                            </optgroup>
                            <optgroup label="Other">
                                <option value="other">üìù Other / Not Listed</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans 'Unit' %}</label>
                        <select class="form-control" disabled>
                            <option value="kg">{% trans 'Kilograms' %}</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Activity Data" %}</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="{% trans 'Enter weight' %}" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Business Travel -->
                <div class="emission-category" onclick="toggleCategory('business-travel')">
                    <h3>
                        Business Travel
                        <i class="fas fa-chevron-down help-icon" title="Emissions from employee business travel"></i>
                    </h3>
                    <p>Emissions from employee business travel in vehicles not owned by the company</p>
                </div>

                <div id="business-travel-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control" id="business-travel-source">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <optgroup label="Turkey Transportation">
                                <option value="flight-domestic">üáπüá∑ Domestic Flight (Turkey)</option>
                                <option value="flight-international">‚úàÔ∏è International Flight</option>
                                <option value="train">üöÜ Train (Turkey)</option>
                                <option value="metro">üöá Metro (Turkey)</option>
                                <option value="bus">üöå Bus (Turkey)</option>
                                <option value="dolmus">üöê Dolmu≈ü (Turkey)</option>
                                <option value="car-gasoline">üöó Car - Gasoline (Turkey)</option>
                                <option value="car-diesel">üöó Car - Diesel (Turkey)</option>
                                <option value="car-lpg">üöó Car - LPG (Turkey)</option>
                                <option value="car-electric">‚ö° Car - Electric (Turkey)</option>
                                <option value="car-hybrid">üîã Car - Hybrid (Turkey)</option>
                            </optgroup>
                            <optgroup label="Global">
                                <option value="flight-short">Short-haul Flight (< 500 km)</option>
                                <option value="flight-medium">Medium-haul Flight (500-3700 km)</option>
                                <option value="flight-long">Long-haul Flight (> 3700 km)</option>
                                <option value="train">Train</option>
                                <option value="taxi">Taxi</option>
                                <option value="bus">Bus</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans 'Unit' %}</label>
                        <select class="form-control" disabled>
                            <option value="km">{% trans 'Kilometers' %}</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Activity Data" %}</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="{% trans 'Enter distance' %}" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Employee Commuting -->
                <div class="emission-category" onclick="toggleCategory('commuting')">
                    <h3>
                        Employee Commuting
                        <i class="fas fa-chevron-down help-icon" title="Emissions from employee commuting"></i>
                    </h3>
                    <p>Emissions from employee commuting between home and work</p>
                </div>

                <div id="commuting-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control" id="commuting-source">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <optgroup label="Turkey">
                                <option value="car-gasoline">üöó Car - Gasoline (Turkey)</option>
                                <option value="car-diesel">üöó Car - Diesel (Turkey)</option>
                                <option value="car-lpg">üöó Car - LPG (Turkey)</option>
                                <option value="car-electric">‚ö° Car - Electric (Turkey)</option>
                                <option value="car-hybrid">üîã Car - Hybrid (Turkey)</option>
                                <option value="bus">üöå Bus (Turkey)</option>
                                <option value="metro">üöá Metro (Turkey)</option>
                                <option value="train">üöÜ Train (Turkey)</option>
                                <option value="dolmus">üöê Dolmu≈ü (Turkey)</option>
                            </optgroup>
                            <optgroup label="Global">
                                <option value="car">Car</option>
                                <option value="bus">Bus</option>
                                <option value="train">Train</option>
                                <option value="motorcycle">Motorcycle</option>
                                <option value="bicycle">Bicycle (Zero Emissions)</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans 'Unit' %}</label>
                        <select class="form-control" disabled>
                            <option value="km">{% trans 'Kilometers' %}</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Activity Data" %}</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="{% trans 'Enter distance' %}" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Upstream Leased Assets -->
                <div class="emission-category" onclick="toggleCategory('upstream-leased')">
                    <h3>
                        Upstream Leased Assets
                        <i class="fas fa-chevron-down help-icon" title="Emissions from leased assets"></i>
                    </h3>
                    <p>Emissions from operation of assets leased by the reporting company</p>
                </div>

                <div id="upstream-leased-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <option value="office-space">Leased Office Space</option>
                            <option value="warehouse">Leased Warehouse</option>
                            <option value="vehicles">Leased Vehicles</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans 'Unit' %}</label>
                        <select class="form-control">
                            <option value="">{% trans "Select Unit" %}</option>
                            <option value="m2">Square Meters (m¬≤)</option>
                            <option value="units">Units</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Activity Data" %}</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="{% trans 'Enter activity data' %}" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Downstream Transportation and Distribution -->
                <div class="emission-category" onclick="toggleCategory('downstream-transport')">
                    <h3>
                        Downstream Transportation and Distribution
                        <i class="fas fa-chevron-down help-icon" title="Transportation of sold products"></i>
                    </h3>
                    <p>Emissions from transportation and distribution of sold products</p>
                </div>

                <div id="downstream-transport-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <option value="truck-delivery">Truck Delivery</option>
                            <option value="courier">Courier Service</option>
                            <option value="postal">Postal Service</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans 'Unit' %}</label>
                        <select class="form-control">
                            <option value="">{% trans "Select Unit" %}</option>
                            <option value="tonne-km">Tonne-km</option>
                            <option value="packages">Packages</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Activity Data" %}</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="{% trans 'Enter activity data' %}" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- End of Life Treatment of Sold Products -->
                <div class="emission-category" onclick="toggleCategory('end-of-life')">
                    <h3>
                        End of Life Treatment of Sold Products
                        <i class="fas fa-chevron-down help-icon" title="End of life treatment emissions"></i>
                    </h3>
                    <p>Emissions from waste disposal and treatment of sold products at end of life</p>
                </div>

                <div id="end-of-life-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <option value="product-recycling">Product Recycling</option>
                            <option value="product-landfill">Product to Landfill</option>
                            <option value="product-incineration">Product Incineration</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans 'Unit' %}</label>
                        <select class="form-control" disabled>
                            <option value="kg">{% trans 'Kilograms' %}</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Activity Data" %}</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="{% trans 'Enter weight' %}" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Franchises -->
                <div class="emission-category" onclick="toggleCategory('franchises')">
                    <h3>
                        Franchises
                        <i class="fas fa-chevron-down help-icon" title="Emissions from franchise operations"></i>
                    </h3>
                    <p>Emissions from operation of franchises not included in Scope 1 or 2</p>
                </div>

                <div id="franchises-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control" disabled>
                            <option value="franchise-operations">Franchise Operations</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans 'Unit' %}</label>
                        <select class="form-control" disabled>
                            <option value="franchises">Number of Franchises</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans "Activity Data" %}</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="{% trans 'Enter number of franchises' %}" value="0" step="1">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Investments -->
                <div class="emission-category" onclick="toggleCategory('investments')">
                    <h3>
                        Investments
                        <i class="fas fa-chevron-down help-icon" title="Emissions from investments"></i>
                    </h3>
                    <p>Emissions from investments (equity, debt, project finance, etc.)</p>
                </div>

                <div id="investments-form" style="display: none;">
                    <div class="form-group">
                        <label>{% trans "Emission Source" %}</label>
                        <select class="form-control">
                            <option value="">{% trans "Select Emission Source" %}</option>
                            <option value="equity-investments">Equity Investments</option>
                            <option value="debt-investments">Debt Investments</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>{% trans 'Unit' %}</label>
                        <select class="form-control" disabled>
                            <option value="usd">USD</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data (USD)</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="{% trans 'Enter investment amount' %}" value="0" step="100">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">{% trans "Calculate" %}</button>
                    <div style="clear: both;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Choice Modal for "Other" Selection -->
<div id="otherChoiceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 40px; max-width: 500px; width: 90%; margin: auto;">
        <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 15px; text-align: center;">
            <i class="fas fa-question-circle" style="color: #3b82f6;"></i> {% trans "Material Not Listed" %}
        </h3>
        <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 30px;">
            {% trans "What would you like to do?" %}
        </p>
        
        <!-- Option 1: Custom Factor -->
        <div onclick="selectOtherOption('custom')" style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#22c55e'; this.style.background='#f0fdf4'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="background: #22c55e; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                    <i class="fas fa-calculator"></i>
                </div>
                <div style="flex: 1;">
                    <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 5px 0; color: #333;">{% trans "I Have the Emission Factor" %}</h4>
                    <p style="font-size: 13px; color: #666; margin: 0;">{% trans "Add a custom emission factor from your supplier or calculations" %}</p>
                </div>
            </div>
        </div>
        
        <!-- Option 2: Request Material -->
        <div onclick="selectOtherOption('request')" style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 25px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#f0f9ff'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="background: #3b82f6; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                    <i class="fas fa-paper-plane"></i>
                </div>
                <div style="flex: 1;">
                    <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 5px 0; color: #333;">{% trans "I Need Help Finding It" %}</h4>
                    <p style="font-size: 13px; color: #666; margin: 0;">{% trans "Request our team to research and add the emission factor" %}</p>
                </div>
            </div>
        </div>
        
        <!-- Cancel Button -->
        <button type="button" onclick="hideOtherChoiceModal()" style="width: 100%; background: #e0e0e0; color: #333; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
            {% trans "Cancel" %}
        </button>
    </div>
</div>

<!-- Custom Emission Factor Modal -->
<div id="customFactorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; margin: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="font-size: 20px; font-weight: 700; margin: 0;">
                <i class="fas fa-calculator" style="color: #22c55e; margin-right: 10px;"></i>
                {% trans "ADD CUSTOM EMISSION FACTOR" %}
            </h3>
            <button onclick="hideCustomFactorModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
        </div>
        <p style="color: #666; font-size: 13px; margin-bottom: 25px;">{% trans "Add a custom emission factor provided by your supplier or from your own calculations." %}</p>
        
        <!-- Material Name (Required) -->
        <div class="form-group">
            <label>{% trans "Material/Product Name" %} <span style="color: red;">*</span></label>
            <input type="text" id="custom-material-name" class="form-control" placeholder="{% trans 'e.g., Recycled Paper, Custom Steel' %}" required>
        </div>
        
        <!-- Category -->
        <div class="form-group">
            <label>{% trans "Category" %} <span style="color: red;">*</span></label>
            <select id="custom-category" class="form-control" required>
                <option value="">{% trans "Select Category" %}</option>
                <option value="purchased-goods">{% trans "Purchased Goods & Services" %}</option>
                <option value="stationary">{% trans "Stationary Combustion" %}</option>
                <option value="mobile">{% trans "Mobile Combustion" %}</option>
                <option value="capital-goods">{% trans "Capital Goods" %}</option>
                <option value="upstream-transport">{% trans "Upstream Transportation" %}</option>
                <option value="waste">{% trans "Waste" %}</option>
                <option value="other">{% trans "Other" %}</option>
            </select>
        </div>
        
        <!-- Emission Factor -->
        <div class="form-group">
            <label>{% trans "Emission Factor" %} <span style="color: red;">*</span></label>
            <input type="number" id="custom-emission-factor" class="form-control" placeholder="{% trans 'e.g., 2.5' %}" step="0.0001" required>
            <small style="color: #666; font-size: 12px;">{% trans "kg CO2e per unit" %}</small>
        </div>
        
        <!-- Unit -->
        <div class="form-group">
            <label>{% trans "Unit" %} <span style="color: red;">*</span></label>
            <select id="custom-unit" class="form-control" required>
                <option value="">{% trans "Select Unit" %}</option>
                <option value="kg">{% trans "Kilograms (kg)" %}</option>
                <option value="liters">{% trans "Liters" %}</option>
                <option value="m3">{% trans "Cubic Meters (m¬≥)" %}</option>
                <option value="m2">{% trans "Square Meters (m¬≤)" %}</option>
                <option value="kwh">{% trans "Kilowatt-hours (kWh)" %}</option>
                <option value="gj">{% trans "Gigajoules (GJ)" %}</option>
                <option value="km">{% trans "Kilometers (km)" %}</option>
                <option value="tonne-km">{% trans "Tonne-kilometers (tonne-km)" %}</option>
                <option value="units">{% trans "Units (for equipment/machinery)" %}</option>
                <option value="packages">{% trans "Packages (for delivery)" %}</option>
            </select>
        </div>
        
        <!-- Supplier (Optional) -->
        <div class="form-group">
            <label>{% trans "Supplier (Optional)" %}</label>
            <select id="custom-supplier" class="form-control supplier-select">
                <option value="">{% trans "Select Supplier" %}</option>
            </select>
        </div>
        
        <!-- Source/Reference -->
        <div class="form-group">
            <label>{% trans "Source/Reference" %}</label>
            <textarea id="custom-source-reference" class="form-control" rows="2" placeholder="{% trans 'e.g., Supplier certificate, LCA study, ISO 14064-1 report' %}"></textarea>
        </div>
        
        <!-- Description -->
        <div class="form-group">
            <label>{% trans "Description" %}</label>
            <textarea id="custom-description" class="form-control" rows="2" placeholder="{% trans 'Additional details about this material' %}"></textarea>
        </div>
        
        <!-- Buttons -->
        <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button type="button" onclick="hideCustomFactorModal()" style="flex: 1; background: #e0e0e0; color: #333; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                {% trans "Cancel" %}
            </button>
            <button type="button" id="save-custom-factor-btn-new" style="flex: 1; background: #22c55e; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                {% trans "Save Custom Factor" %}
            </button>
        </div>
    </div>
</div>

<!-- Request New Material Modal -->
<div id="requestMaterialModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; margin: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="font-size: 20px; font-weight: 700; margin: 0;">
                <i class="fas fa-paper-plane" style="color: #3b82f6; margin-right: 10px;"></i>
                {% trans "REQUEST NEW MATERIAL" %}
            </h3>
            <button onclick="hideRequestMaterialModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
        </div>
        <p style="color: #666; font-size: 13px; margin-bottom: 25px;">{% trans "Can't find your material in the system? Request it and our team will add the emission factor from official sources (Defra, IPCC, etc.)." %}</p>
        
        <!-- Material Name (Required) -->
        <div class="form-group">
            <label>{% trans "Material/Product Name" %} <span style="color: red;">*</span></label>
            <input type="text" id="request-material-name" class="form-control" placeholder="{% trans 'e.g., Bamboo Fiber, Bioplastic PLA' %}" required>
        </div>
        
        <!-- Category -->
        <div class="form-group">
            <label>{% trans "Category" %} <span style="color: red;">*</span></label>
            <select id="request-category" class="form-control" required>
                <option value="">{% trans "Select Category" %}</option>
                <option value="purchased-goods">{% trans "Purchased Goods & Services" %}</option>
                <option value="stationary">{% trans "Stationary Combustion" %}</option>
                <option value="mobile">{% trans "Mobile Combustion" %}</option>
                <option value="capital-goods">{% trans "Capital Goods" %}</option>
                <option value="upstream-transport">{% trans "Upstream Transportation" %}</option>
                <option value="waste">{% trans "Waste" %}</option>
                <option value="other">{% trans "Other" %}</option>
            </select>
        </div>
        
        <!-- Description -->
        <div class="form-group">
            <label>{% trans "Description" %} <span style="color: red;">*</span></label>
            <textarea id="request-description" class="form-control" rows="3" placeholder="{% trans 'Describe the material and why you need it' %}" required></textarea>
        </div>
        
        <!-- Optional: Suggested Factor -->
        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <p style="font-size: 13px; font-weight: 600; color: #333; margin-bottom: 10px;">
                <i class="fas fa-lightbulb" style="color: #3b82f6;"></i> {% trans "Do you have a suggested emission factor?" %}
            </p>
            <div class="form-group" style="margin-bottom: 10px;">
                <label>{% trans "Suggested Factor (Optional)" %}</label>
                <input type="number" id="request-suggested-factor" class="form-control" placeholder="{% trans 'e.g., 1.5' %}" step="0.0001">
            </div>
            <div class="form-group" style="margin-bottom: 10px;">
                <label>{% trans "Unit (Optional)" %}</label>
                <select id="request-suggested-unit" class="form-control">
                    <option value="">{% trans "Select Unit" %}</option>
                    <option value="kg">{% trans "Kilograms (kg)" %}</option>
                    <option value="liters">{% trans "Liters" %}</option>
                    <option value="m3">{% trans "Cubic Meters (m¬≥)" %}</option>
                    <option value="m2">{% trans "Square Meters (m¬≤)" %}</option>
                    <option value="kwh">{% trans "Kilowatt-hours (kWh)" %}</option>
                    <option value="gj">{% trans "Gigajoules (GJ)" %}</option>
                    <option value="km">{% trans "Kilometers (km)" %}</option>
                    <option value="tonne-km">{% trans "Tonne-kilometers (tonne-km)" %}</option>
                    <option value="units">{% trans "Units (for equipment/machinery)" %}</option>
                    <option value="packages">{% trans "Packages (for delivery)" %}</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>{% trans "Source (Optional)" %}</label>
                <textarea id="request-suggested-source" class="form-control" rows="2" placeholder="{% trans 'Where did you get this factor?' %}"></textarea>
            </div>
        </div>
        
        <!-- Buttons -->
        <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button type="button" onclick="hideRequestMaterialModal()" style="flex: 1; background: #e0e0e0; color: #333; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                {% trans "Cancel" %}
            </button>
            <button type="button" onclick="event.preventDefault(); event.stopPropagation(); submitMaterialRequest(event);" style="flex: 1; background: #3b82f6; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                {% trans "Submit Request" %}
            </button>
        </div>
    </div>
</div>

<!-- Add Supplier Modal -->
<div id="supplierModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; margin: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="font-size: 20px; font-weight: 700; margin: 0;">
                <i class="fas fa-building" style="color: #22c55e; margin-right: 10px;"></i>
                {% trans "ADD NEW SUPPLIER" %}
            </h3>
            <button onclick="hideAddSupplierModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
        </div>
        <p style="color: #666; font-size: 13px; margin-bottom: 25px;">{% trans "Add new suppliers to your database." %}</p>
        
        <!-- Supplier Name (Required) -->
        <div class="form-group">
            <label>{% trans "Supplier name" %} <span style="color: red;">*</span></label>
            <input type="text" id="modal-supplier-name" class="form-control" placeholder="{% trans 'Enter supplier name' %}" required>
        </div>
        
        <!-- Contact Name -->
        <div class="form-group">
            <label>{% trans "Contact name" %}</label>
            <input type="text" id="modal-contact-name" class="form-control" placeholder="{% trans 'Enter primary contact name' %}">
        </div>
        
        <!-- Email -->
        <div class="form-group">
            <label>{% trans "Email" %}</label>
            <input type="email" id="modal-email" class="form-control" placeholder="{% trans 'Enter primary contact email' %}">
        </div>
        
        <!-- Phone Number -->
        <div class="form-group">
            <label>{% trans "Phone number" %}</label>
            <div style="display: flex; gap: 10px;">
                <select id="modal-phone-code" class="form-control" style="width: 120px;">
                    <option value="+90">üáπüá∑ +90</option>
                    <option value="+1">üá∫üá∏ +1</option>
                    <option value="+44">üá¨üáß +44</option>
                    <option value="+49">üá©üá™ +49</option>
                    <option value="+33">üá´üá∑ +33</option>
                    <option value="+86">üá®üá≥ +86</option>
                </select>
                <input type="tel" id="modal-phone" class="form-control" placeholder="{% trans 'Enter phone number' %}" style="flex: 1;">
            </div>
        </div>
        
        <!-- Activity (Supplier Type) -->
        <div class="form-group">
            <label>{% trans "Activity" %}</label>
            <select id="modal-supplier-type" class="form-control">
                <option value="">{% trans "Select activity" %}</option>
                <option value="Energy">{% trans "Energy" %}</option>
                <option value="Fuel">{% trans "Fuel" %}</option>
                <option value="Transportation">{% trans "Transportation" %}</option>
                <option value="Waste Management">{% trans "Waste Management" %}</option>
                <option value="Manufacturing">{% trans "Manufacturing" %}</option>
                <option value="Construction">{% trans "Construction" %}</option>
                <option value="Other">{% trans "Other" %}</option>
            </select>
        </div>
        
        <!-- Country & City -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>{% trans "Country" %}</label>
                <select id="modal-country" class="form-control">
                    <option value="">{% trans "Select country" %}</option>
                    <option value="Turkey">üáπüá∑ {% trans "Turkey" %}</option>
                    <option value="USA">üá∫üá∏ {% trans "United States" %}</option>
                    <option value="UK">üá¨üáß {% trans "United Kingdom" %}</option>
                    <option value="Germany">üá©üá™ {% trans "Germany" %}</option>
                    <option value="France">üá´üá∑ {% trans "France" %}</option>
                    <option value="China">üá®üá≥ {% trans "China" %}</option>
                </select>
            </div>
            <div class="form-group">
                <label>{% trans "City" %}</label>
                <input type="text" id="modal-city" class="form-control" placeholder="{% trans 'Select city' %}">
            </div>
        </div>
        
        <!-- Tax Number -->
        <div class="form-group">
            <label>{% trans "Tax number" %}</label>
            <input type="text" id="modal-tax-number" class="form-control" placeholder="{% trans 'Enter tax number' %}">
        </div>
        
        <!-- Company Website -->
        <div class="form-group">
            <label>{% trans "Company Website" %}</label>
            <input type="url" id="modal-website" class="form-control" placeholder="{% trans 'Enter company website' %}">
        </div>
        
        <!-- Address/Notes -->
        <div class="form-group">
            <label>{% trans "Address / Notes" %}</label>
            <textarea id="modal-notes" class="form-control" rows="3" placeholder="{% trans 'Enter address or additional notes' %}"></textarea>
        </div>
        
        <!-- Buttons -->
        <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button onclick="hideAddSupplierModal()" style="flex: 1; background: #e0e0e0; color: #333; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                {% trans "Cancel" %}
            </button>
            <button onclick="saveSupplier()" style="flex: 1; background: #22c55e; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                {% trans "Save" %}
            </button>
        </div>
    </div>
</div>

<!-- Add Industry Modal -->
<div id="addIndustryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; margin: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="font-size: 20px; font-weight: 700; color: #333; margin: 0;">
                {% trans "REQUEST NEW INDUSTRY TYPE" %}
            </h3>
            <button onclick="hideAddIndustryModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
        </div>
        <p style="color: #666; font-size: 13px; margin-bottom: 25px;">{% trans "Don't see your industry type in the list? Request it and our team will add it to the system for better emission factor categorization." %}</p>
        
        <!-- Industry Name -->
        <div class="form-group">
            <label>{% trans "Industry Name" %} <span style="color: red;">*</span></label>
            <input type="text" id="modal-industry-name" class="form-control" placeholder="{% trans 'e.g., Textile Manufacturing, Food Processing' %}" required maxlength="200" oninput="updateCharCount('modal-industry-name', 'name-char-count', 200)">
            <small style="color: #666; font-size: 11px; float: right;">
                <span id="name-char-count">0</span>/200 {% trans "characters" %}
            </small>
            <div style="clear: both;"></div>
        </div>
        
        <!-- Industry Code (Optional) -->
        <div class="form-group">
            <label>Industry Code (Optional)</label>
            <input type="text" id="modal-industry-code" class="form-control" placeholder="{% trans 'e.g., NAICS 313, SIC 22' %}" maxlength="20" oninput="updateCharCount('modal-industry-code', 'code-char-count', 20)">
            <small style="color: #666; font-size: 11px;">
                If you know the NAICS, SIC, or other industry classification code
                <span style="float: right;"><span id="code-char-count">0</span>/20 characters</span>
            </small>
            <div style="clear: both;"></div>
        </div>
        
        <!-- Description -->
        <div class="form-group">
            <label>Industry Description <span style="color: red;">*</span></label>
            <textarea id="modal-industry-description" class="form-control" rows="3" placeholder="{% trans 'Describe what this industry does and its main activities...' %}" required maxlength="1000" oninput="updateCharCount('modal-industry-description', 'desc-char-count', 1000)"></textarea>
            <small style="color: #666; font-size: 11px; float: right;">
                <span id="desc-char-count">0</span>/1000 characters
            </small>
            <div style="clear: both;"></div>
        </div>
        
        <!-- Business Context -->
        <div class="form-group">
            <label>How does this relate to your business? (Optional)</label>
            <textarea id="modal-business-context" class="form-control" rows="2" placeholder="{% trans 'Explain how this industry type relates to your organization activities' %}" maxlength="1000" oninput="updateCharCount('modal-business-context', 'context-char-count', 1000)"></textarea>
            <small style="color: #666; font-size: 11px; float: right;">
                <span id="context-char-count">0</span>/1000 characters
            </small>
            <div style="clear: both;"></div>
        </div>
        
        <!-- Buttons -->
        <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button type="button" onclick="hideAddIndustryModal()" style="flex: 1; background: #e0e0e0; color: #333; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">{% trans "Cancel" %}</button>
            <button type="button" id="save-industry-btn" onclick="saveIndustryRequest()" style="flex: 1; background: #3b82f6; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                <i class="fas fa-paper-plane"></i> Submit Request
            </button>
        </div>
    </div>
</div>
</div>

<script>
// API URLs - using Django URL reverse to avoid hardcoding
const MATERIAL_REQUEST_URL = "{% url 'ghg:request_material' %}";
const CUSTOM_FACTOR_ADD_URL = "{% url 'ghg:add_custom_factor' %}";
const INDUSTRY_REQUEST_URL = "{% url 'ghg:request_industry' %}";
const GET_INDUSTRIES_URL = "{% url 'ghg:get_industry_types' %}";

// Debug: Log URLs
console.log('MATERIAL_REQUEST_URL:', MATERIAL_REQUEST_URL);
console.log('CUSTOM_FACTOR_ADD_URL:', CUSTOM_FACTOR_ADD_URL);
console.log('INDUSTRY_REQUEST_URL:', INDUSTRY_REQUEST_URL);
console.log('GET_INDUSTRIES_URL:', GET_INDUSTRIES_URL);

// Unit mapping for stationary combustion sources
const stationaryUnits = {
    'coal-industrial': ['kg'],
    'coal': ['kg'],
    'gas-diesel-oil-energy': ['gj'],
    'lpg': ['liters'],
    'propane': ['kg'],
    'motor-gasoline': ['gj'],
    'natural-gas': ['gj'],
    'diesel': ['liters'],
    'fuel-oil': ['liters']
};

// Unit mapping for mobile combustion sources
const mobileUnits = {
    'off-road-ipcc': ['gj'],
    'off-road-diesel': ['liters'],
    'off-road-gasoline': ['liters'],
    'on-road-diesel': ['gj'],
    'on-road-gasoline-low-mileage': ['gj'],
    'on-road-gasoline-uncontrolled': ['gj'],
    'on-road-gasoline-oxidation': ['gj'],
    'on-road-natural-gas': ['gj'],
    'on-road-lpg': ['gj'],
    'on-road-petrol-desnz': ['liters'],
    'on-road-diesel-desnz': ['liters'],
    'on-road-lpg-desnz': ['gj'],
    'gasoline': ['liters'],
    'diesel': ['liters'],
    'cng': ['kg'],
    'vehicle-km': ['km']
};

// Removed complex fuel type handling - sources are now directly selectable

function updateMobileFields() {
    const sourceSelect = document.getElementById('mobile-source');
    const unitSelect = document.getElementById('mobile-unit');
    const selectedSource = sourceSelect.value;
    
    // Clear current options
    unitSelect.innerHTML = '<option value="">{% trans "Select Unit" %}</option>';
    
    if (selectedSource && mobileUnits[selectedSource]) {
        const allowedUnits = mobileUnits[selectedSource];
        
        // Add only allowed units
        allowedUnits.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit;
            
            // Set display text
            if (unit === 'kg') option.textContent = 'Kilograms (kg)';
            else if (unit === 'liters') option.textContent = 'Liters';
            else if (unit === 'gj') option.textContent = 'Gigajoules (GJ)';
            else if (unit === 'km') option.textContent = 'Kilometers';
            else option.textContent = unit;
            
            unitSelect.appendChild(option);
        });
        
        // Auto-select if only one option
        if (allowedUnits.length === 1) {
            unitSelect.value = allowedUnits[0];
        }
    } else {
        // Show all units if no source selected
        unitSelect.innerHTML = `
            <option value="">{% trans "Select Unit" %}</option>
            <option value="liters">{% trans 'Liters' %}</option>
            <option value="kg">Kilograms (kg)</option>
            <option value="gj">Gigajoules (GJ)</option>
            <option value="km">{% trans 'Kilometers' %}</option>
        `;
    }
}

function updateStationaryFields() {
    const sourceSelect = document.getElementById('stationary-source');
    const unitSelect = document.getElementById('stationary-unit');
    const industryTypeGroup = document.getElementById('industry-type-group');
    const selectedSource = sourceSelect.value;
    
    // Show Industry Type field for all emission sources (not just specific ones)
    if (selectedSource && selectedSource !== '') {
        industryTypeGroup.style.display = 'block';
    } else {
        industryTypeGroup.style.display = 'none';
    }
    
    // Clear current options
    unitSelect.innerHTML = '<option value="">{% trans "Select Unit" %}</option>';
    
    if (selectedSource && stationaryUnits[selectedSource]) {
        const allowedUnits = stationaryUnits[selectedSource];
        
        // Add only allowed units
        allowedUnits.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit;
            
            // Set display text
            if (unit === 'kg') option.textContent = 'Kilograms (kg)';
            else if (unit === 'liters') option.textContent = 'Liters';
            else if (unit === 'm3') option.textContent = 'Cubic Meters (m¬≥)';
            else if (unit === 'gj') option.textContent = 'Gigajoules (GJ)';
            else if (unit === 'kwh') option.textContent = 'kWh';
            else option.textContent = unit;
            
            unitSelect.appendChild(option);
        });
        
        // Auto-select if only one option
        if (allowedUnits.length === 1) {
            unitSelect.value = allowedUnits[0];
        }
    } else {
        // Show all units if no source selected
        unitSelect.innerHTML = `
            <option value="">{% trans "Select Unit" %}</option>
            <option value="liters">{% trans 'Liters' %}</option>
            <option value="kg">Kilograms (kg)</option>
            <option value="m3">Cubic Meters (m¬≥)</option>
            <option value="gj">Gigajoules (GJ)</option>
            <option value="kwh">kWh</option>
        `;
    }
}

function switchScope(scopeNum) {
    // Hide all scopes
    document.querySelectorAll('.scope-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.scope-tab').forEach(el => el.classList.remove('active'));
    
    // Show selected scope
    document.getElementById('scope' + scopeNum).classList.add('active');
    document.querySelectorAll('.scope-tab')[scopeNum - 1].classList.add('active');
}

function toggleCategory(category) {
    const form = document.getElementById(category + '-form');
    const icon = event.currentTarget.querySelector('i');
    
    if (form.style.display === 'none') {
        form.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
    } else {
        form.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
    }
}

// Activity data increment/decrement
document.querySelectorAll('.activity-input button').forEach(btn => {
    btn.addEventListener('click', function() {
        const input = this.parentElement.querySelector('input');
        const currentValue = parseFloat(input.value) || 0;
        
        if (this.textContent === '+') {
            input.value = currentValue + 1;
        } else if (this.textContent === '‚àí' && currentValue > 0) {
            input.value = currentValue - 1;
        }
    });
});

// Calculate emissions
document.querySelectorAll('.btn-calculate').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        
        const form = this.closest('div[id$="-form"]');
        const category = form.id.replace('-form', '');
        
        // Get form data - find the source select by category-specific ID
        let sourceSelect;
        if (category === 'stationary') {
            sourceSelect = document.getElementById('stationary-source');
        } else if (category === 'mobile') {
            sourceSelect = document.getElementById('mobile-source');
        } else if (category === 'fugitive') {
            sourceSelect = document.getElementById('fugitive-source');
        } else if (category === 'electricity') {
            sourceSelect = document.getElementById('electricity-source');
        } else if (category === 'steam-heat') {
            sourceSelect = document.getElementById('steam-heat-source');
        } else if (category === 'water') {
            sourceSelect = document.getElementById('water-source');
        } else if (category === 'purchased-goods') {
            sourceSelect = document.getElementById('purchased-goods-source');
        } else if (category === 'business-travel') {
            sourceSelect = document.getElementById('business-travel-source');
        } else if (category === 'commuting') {
            sourceSelect = document.getElementById('commuting-source');
        } else if (category === 'waste') {
            sourceSelect = document.getElementById('waste-source');
        } else {
            // Fallback to first select
            sourceSelect = form.querySelector('select[class*="form-control"]');
        }
        
        const activityInput = form.querySelector('input[type="number"]');
        const supplierSelect = form.querySelector('.supplier-select');
        const descriptionTextarea = form.querySelector('textarea');
        const industryTypeSelect = document.getElementById('stationary-industry-type');
        const fuelNameSelect = document.getElementById('mobile-fuel-name');
        
        if (!sourceSelect || !activityInput) return;
        
        let source = sourceSelect.value;
        const activityData = parseFloat(activityInput.value) || 0;
        const supplierId = supplierSelect ? supplierSelect.value : null;
        const description = descriptionTextarea ? descriptionTextarea.value : '';
        const industryType = industryTypeSelect ? industryTypeSelect.value : '';
        const fuelName = fuelNameSelect ? fuelNameSelect.value : '';
        const fuelTypeSelect = document.getElementById('mobile-fuel-type');
        const fuelType = fuelTypeSelect ? fuelTypeSelect.value : '';
        
        // No need for complex fuel type handling anymore - sources are directly selectable
        
        if (!source || activityData <= 0) {
            alert('Please select an emission source and enter activity data');
            return;
        }
        
        // Check if this is a custom factor
        if (source.startsWith('custom-')) {
            const customFactorId = source.replace('custom-', '');
            
            // Show loading
            this.textContent = 'Calculating...';
            this.disabled = true;
            
            // Calculate with custom factor
            fetch('/api/custom-factors/calculate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    custom_factor_id: customFactorId,
                    activity_data: activityData,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    showResult(data, form);
                }
                this.textContent = 'Calculate';
                this.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Calculation failed. Please try again.');
                this.textContent = 'Calculate';
                this.disabled = false;
            });
            
            return; // Exit early for custom factors
        }
        
        // Determine category type
        let categoryType = 'stationary';
        if (category === 'mobile') categoryType = 'mobile';
        else if (category === 'fugitive') categoryType = 'fugitive';
        else if (category === 'electricity') categoryType = 'electricity';
        else if (category === 'steam-heat') categoryType = 'steam-heat';
        else if (category === 'business-travel') categoryType = 'travel';
        else if (category.includes('water')) categoryType = 'water';
        else if (category === 'waste') categoryType = 'waste';
        else if (category === 'purchased-goods') categoryType = 'purchased-goods';
        else if (category === 'capital-goods') categoryType = 'capital-goods';
        else if (category === 'fuel-energy') categoryType = 'fuel-energy';
        else if (category === 'upstream-transport') categoryType = 'upstream-transport';
        else if (category === 'commuting') categoryType = 'commuting';
        else if (category === 'upstream-leased') categoryType = 'upstream-leased';
        else if (category === 'downstream-transport') categoryType = 'downstream-transport';
        else if (category === 'end-of-life') categoryType = 'end-of-life';
        else if (category === 'franchises') categoryType = 'franchises';
        else if (category === 'investments') categoryType = 'investments';
        
        // Get selected country
        const country = document.getElementById('country-selector').value;
        
        // Show loading
        this.textContent = 'Calculating...';
        this.disabled = true;
        
        // Calculate
        const requestData = {
            category: categoryType,
            source: source,
            activity_data: activityData,
            country: country,
            supplier_id: supplierId || null,
            description: description,
            industry_type: industryType || null,
            fuel_name: fuelName || null
        };
        
        console.log('Sending calculation request:', requestData);
        
        fetch(window.location.pathname.replace('data-entry/', 'api/calculate/'), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                showResult(data, form);
            }
            this.textContent = 'Calculate';
            this.disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Calculation failed. Please try again.');
            this.textContent = 'Calculate';
            this.disabled = false;
        });
    });
});

function showResult(data, form) {
    // Remove existing result
    const existingResult = form.querySelector('.calculation-result');
    if (existingResult) existingResult.remove();
    
    // Create result display
    const resultDiv = document.createElement('div');
    resultDiv.className = 'calculation-result';
    resultDiv.style.cssText = 'background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 20px; margin-top: 20px;';
    
    resultDiv.innerHTML = `
        <h4 style="color: #22c55e; font-size: 16px; font-weight: 700; margin-bottom: 15px;">
            <i class="fas fa-check-circle"></i> Calculation Result ${data.saved ? '<span style="font-size: 12px; color: #666; font-weight: normal;">(Saved to History)</span>' : ''}
        </h4>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
            <div>
                <p style="font-size: 12px; color: #666; margin-bottom: 5px;">{% trans "Activity Data" %}</p>
                <p style="font-size: 18px; font-weight: 700; color: #333;">${data.activity_data} ${data.unit}</p>
            </div>
            <div>
                <p style="font-size: 12px; color: #666; margin-bottom: 5px;">Emission Factor</p>
                <p style="font-size: 18px; font-weight: 700; color: #333;">${data.factor} kg CO2e/${data.unit}</p>
            </div>
            <div>
                <p style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Emissions (kg)</p>
                <p style="font-size: 20px; font-weight: 700; color: #22c55e;">${data.emissions_kg} kg CO2e</p>
            </div>
            <div>
                <p style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Emissions (tons)</p>
                <p style="font-size: 20px; font-weight: 700; color: #22c55e;">${data.emissions_tons} t CO2e</p>
            </div>
        </div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #22c55e;">
            <p style="font-size: 13px; color: #666;">
                <i class="fas fa-info-circle"></i> 
                Source: ${data.source_name} 
                ${data.is_custom ? '<span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 5px;">CUSTOM</span>' : ''}
                ${data.is_verified ? '<span style="color: #22c55e; margin-left: 5px;" title="Verified by admin">‚úì</span>' : ''}
                | Country: ${data.country === 'turkey' ? 'üáπüá∑ Turkey' : data.country === 'custom' ? 'üîß Custom' : 'üåç Global'}
            </p>
            ${data.reference ? `<p style="font-size: 12px; color: #999; margin-top: 5px;"><i class="fas fa-book"></i> Reference: ${data.reference}</p>` : ''}
        </div>
    `;
    
    form.appendChild(resultDiv);
    
    // Scroll to result
    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Country selector change handler
document.getElementById('country-selector').addEventListener('change', function() {
    const countryInfo = document.getElementById('country-info');
    if (this.value === 'turkey') {
        countryInfo.innerHTML = '<i class="fas fa-info-circle"></i> Using Turkey-specific emission factors (IEA 2023, Turkish Ministry of Environment)';
        countryInfo.style.color = '#22c55e';
    } else {
        countryInfo.innerHTML = '<i class="fas fa-info-circle"></i> Using global average emission factors (IPCC, EPA, DEFRA)';
        countryInfo.style.color = '#666';
    }
});

// Supplier Management Functions
function loadSuppliers() {
    fetch('/api/suppliers/', {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        const supplierSelects = document.querySelectorAll('.supplier-select');
        supplierSelects.forEach(select => {
            // Keep the first option (Select Supplier)
            const firstOption = select.options[0];
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            // Add suppliers
            data.suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = supplier.name + (supplier.supplier_type ? ` (${supplier.supplier_type})` : '');
                select.appendChild(option);
            });
        });
    })
    .catch(error => console.error('Error loading suppliers:', error));
}

function showAddSupplierModal() {
    const modal = document.getElementById('supplierModal');
    modal.style.display = 'flex';
    
    // Clear all fields
    document.getElementById('modal-supplier-name').value = '';
    document.getElementById('modal-contact-name').value = '';
    document.getElementById('modal-email').value = '';
    document.getElementById('modal-phone-code').value = '+90';
    document.getElementById('modal-phone').value = '';
    document.getElementById('modal-supplier-type').value = '';
    document.getElementById('modal-country').value = '';
    document.getElementById('modal-city').value = '';
    document.getElementById('modal-tax-number').value = '';
    document.getElementById('modal-website').value = '';
    document.getElementById('modal-notes').value = '';
}

function hideAddSupplierModal() {
    document.getElementById('supplierModal').style.display = 'none';
}

function saveSupplier() {
    const name = document.getElementById('modal-supplier-name').value.trim();
    
    if (!name) {
        alert('Please enter supplier name');
        return;
    }
    
    const supplierData = {
        name: name,
        contact_person: document.getElementById('modal-contact-name').value.trim(),
        email: document.getElementById('modal-email').value.trim(),
        phone_code: document.getElementById('modal-phone-code').value,
        phone: document.getElementById('modal-phone').value.trim(),
        supplier_type: document.getElementById('modal-supplier-type').value,
        country: document.getElementById('modal-country').value,
        city: document.getElementById('modal-city').value.trim(),
        tax_number: document.getElementById('modal-tax-number').value.trim(),
        website: document.getElementById('modal-website').value.trim(),
        notes: document.getElementById('modal-notes').value.trim()
    };
    
    fetch(window.location.pathname.replace('data-entry/', 'api/suppliers/add/'), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(supplierData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            // Show error message as toast
            const errorMsg = document.createElement('div');
            errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error: ' + data.error;
            document.body.appendChild(errorMsg);
            
            setTimeout(() => {
                errorMsg.remove();
            }, 4000);
        } else {
            hideAddSupplierModal();
            loadSuppliers(); // Reload supplier list
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #22c55e; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Supplier added successfully!';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                successMsg.remove();
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Show error message as toast
        const errorMsg = document.createElement('div');
        errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
        errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Failed to add supplier. Please try again.';
        document.body.appendChild(errorMsg);
        
        setTimeout(() => {
            errorMsg.remove();
        }, 4000);
    });
}

// Handle "Other" selection in any dropdown
function handleOtherSelection(selectElement, category) {
    if (selectElement.value === 'other') {
        // Show choice modal
        showOtherChoiceModal(category);
        // Reset dropdown to empty
        selectElement.value = '';
    }
}

// Handle "Other" selection in Purchased Goods dropdown (backward compatibility)
function handlePurchasedGoodsSourceChange(selectElement) {
    handleOtherSelection(selectElement, 'purchased-goods');
}

// Other Choice Modal Functions
let currentCategory = 'purchased-goods'; // Store current category

function showOtherChoiceModal(category) {
    currentCategory = category || 'purchased-goods';
    const modal = document.getElementById('otherChoiceModal');
    modal.style.display = 'flex';
}

function hideOtherChoiceModal() {
    const modal = document.getElementById('otherChoiceModal');
    modal.style.display = 'none';
}

function selectOtherOption(option) {
    console.log('selectOtherOption called with:', option);
    hideOtherChoiceModal();
    
    if (option === 'custom') {
        // Open Custom Factor Modal with pre-filled category
        console.log('Opening custom factor modal');
        showCustomFactorModal(window.currentCategory || '');
    } else if (option === 'request') {
        // Open Request Material Modal with pre-filled category
        console.log('Opening request material modal');
        showRequestMaterialModal(window.currentCategory || '');
    }
}

// Custom Emission Factor Functions
function showCustomFactorModal(prefilledCategory) {
    const modal = document.getElementById('customFactorModal');
    
    // Move modal to body to prevent form nesting issues
    if (modal && modal.parentNode !== document.body) {
        console.log('Moving modal to body');
        document.body.appendChild(modal);
    }
    
    modal.style.display = 'flex';
    
    // Clear all fields
    document.getElementById('custom-material-name').value = '';
    document.getElementById('custom-emission-factor').value = '';
    document.getElementById('custom-unit').value = '';
    document.getElementById('custom-supplier').value = '';
    document.getElementById('custom-source-reference').value = '';
    document.getElementById('custom-description').value = '';
    
    // Pre-fill category if provided
    const categorySelect = document.getElementById('custom-category');
    if (prefilledCategory) {
        // Map frontend categories to form categories
        const categoryMap = {
            'stationary': 'stationary',
            'mobile': 'mobile',
            'purchased-goods': 'purchased-goods',
            'capital-goods': 'capital-goods',
            'waste': 'waste'
        };
        categorySelect.value = categoryMap[prefilledCategory] || '';
    } else {
        categorySelect.value = '';
    }
    
    // Load suppliers if function exists
    if (typeof loadSuppliers === 'function') {
        loadSuppliers('custom-supplier');
    }
    
    // Setup event listener for new button
    setTimeout(function() {
        const saveBtn = document.getElementById('save-custom-factor-btn-new');
        if (saveBtn && !saveBtn.hasAttribute('data-listener-added')) {
            console.log('Adding event listener to save button in modal');
            saveBtn.addEventListener('click', function(e) {
                console.log('Save button clicked in modal');
                e.preventDefault();
                e.stopPropagation();
                saveCustomFactorNew();
                return false;
            });
            saveBtn.setAttribute('data-listener-added', 'true');
        }
    }, 100);
}

function hideCustomFactorModal() {
    document.getElementById('customFactorModal').style.display = 'none';
}

function saveCustomFactor(e) {
    if (e) e.preventDefault();   // ÿ¨ŸÑŸà⁄Ø€åÿ±€å ÿßÿ≤ submit ŸÅÿ±ŸÖ
    if (e) e.stopPropagation();  // ÿ¨ŸÑŸà⁄Ø€åÿ±€å ÿßÿ≤ bubble up
    
    console.log('saveCustomFactor called');
    
    const materialName = document.getElementById('custom-material-name').value.trim();
    const category = document.getElementById('custom-category').value;
    const emissionFactor = document.getElementById('custom-emission-factor').value;
    const unit = document.getElementById('custom-unit').value;
    
    console.log('Form data:', { materialName, category, emissionFactor, unit });
    
    if (!materialName || !category || !emissionFactor || !unit) {
        alert('Please fill in all required fields');
        return;
    }
    
    const factorData = {
        material_name: materialName,
        category: category,
        emission_factor: parseFloat(emissionFactor),
        unit: unit,
        supplier_id: document.getElementById('custom-supplier').value || null,
        source_reference: document.getElementById('custom-source-reference').value.trim(),
        description: document.getElementById('custom-description').value.trim()
    };
    
    console.log('Sending data:', factorData);
    console.log('URL:', CUSTOM_FACTOR_ADD_URL);
    
    fetch(CUSTOM_FACTOR_ADD_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify(factorData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.error) {
            // Show error message as toast
            const errorMsg = document.createElement('div');
            errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error: ' + data.error;
            document.body.appendChild(errorMsg);
            
            setTimeout(() => {
                errorMsg.remove();
            }, 4000);
        } else {
            hideCustomFactorModal();
            
            // Clear form
            document.getElementById('custom-material-name').value = '';
            document.getElementById('custom-category').value = '';
            document.getElementById('custom-emission-factor').value = '';
            document.getElementById('custom-unit').value = '';
            document.getElementById('custom-supplier').value = '';
            document.getElementById('custom-source-reference').value = '';
            document.getElementById('custom-description').value = '';
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #22c55e; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Custom emission factor added successfully!';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                successMsg.remove();
            }, 3000);
            
            // Reload custom factors if needed
            if (typeof loadCustomFactors === 'function') {
                loadCustomFactors();
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Show error message as toast
        const errorMsg = document.createElement('div');
        errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
        errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Network error: ' + error.message;
        document.body.appendChild(errorMsg);
        
        setTimeout(() => {
            errorMsg.remove();
        }, 4000);
    });
}

// Add event listener as backup
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up event listeners');
    
    // Prevent all form submissions on this page
    document.addEventListener('submit', function(e) {
        console.log('Form submission detected, preventing...');
        e.preventDefault();
        e.stopPropagation();
        return false;
    });
    
    // Prevent Enter key from submitting forms
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA')) {
            console.log('Enter key pressed in form element, preventing submission');
            e.preventDefault();
            e.stopPropagation();
            return false;
        }
    });
    
    // New approach: Use addEventListener instead of onclick
    setTimeout(function() {
        const saveBtn = document.getElementById('save-custom-factor-btn-new');
        if (saveBtn) {
            console.log('Found new save button, adding event listener');
            
            // Remove any existing onclick handlers
            saveBtn.onclick = null;
            
            // Add new event listener
            saveBtn.addEventListener('click', function(e) {
                console.log('New save button clicked');
                e.preventDefault();
                e.stopPropagation();
                
                // Call save function
                saveCustomFactorNew();
                
                return false;
            });
        } else {
            console.log('New save button not found');
        }
    }, 1000); // Wait 1 second for DOM to be fully ready
});

// New save function with better error handling
function saveCustomFactorNew() {
    console.log('saveCustomFactorNew called');
    
    try {
        const materialName = document.getElementById('custom-material-name').value.trim();
        const category = document.getElementById('custom-category').value;
        const emissionFactor = document.getElementById('custom-emission-factor').value;
        const unit = document.getElementById('custom-unit').value;
        
        console.log('Form data:', { materialName, category, emissionFactor, unit });
        
        if (!materialName || !category || !emissionFactor || !unit) {
            alert('Please fill in all required fields');
            return;
        }
        
        const factorData = {
            material_name: materialName,
            category: category,
            emission_factor: parseFloat(emissionFactor),
            unit: unit,
            supplier_id: document.getElementById('custom-supplier').value || null,
            source_reference: document.getElementById('custom-source-reference').value.trim(),
            description: document.getElementById('custom-description').value.trim()
        };
        
        console.log('Sending data to URL:', CUSTOM_FACTOR_ADD_URL);
        console.log('Data:', factorData);
        
        const csrfToken = getCookie('csrftoken');
        console.log('CSRF Token:', csrfToken);
        
        if (!csrfToken) {
            alert('CSRF token not found. Please refresh the page.');
            return;
        }
        
        fetch(CUSTOM_FACTOR_ADD_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin',
            body: JSON.stringify(factorData)
        })
        .then(response => {
            console.log('Response received:', response);
            console.log('Response status:', response.status);
            console.log('Response ok:', response.ok);
            
            if (!response.ok) {
                return response.text().then(text => {
                    console.log('Error response text:', text);
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Success response data:', data);
            hideCustomFactorModal();
            
            // Clear form
            document.getElementById('custom-material-name').value = '';
            document.getElementById('custom-category').value = '';
            document.getElementById('custom-emission-factor').value = '';
            document.getElementById('custom-unit').value = '';
            document.getElementById('custom-supplier').value = '';
            document.getElementById('custom-source-reference').value = '';
            document.getElementById('custom-description').value = '';
            
            alert('Custom emission factor added successfully!');
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('Error: ' + error.message);
        });
        
    } catch (error) {
        console.error('Function error:', error);
        alert('Unexpected error: ' + error.message);
    }
}

// Test function to directly call API
function testDirectAPI() {
    console.log('Testing API directly...');
    
    const testData = {
        material_name: 'Test Material Direct',
        category: 'stationary',
        emission_factor: 2.5,
        unit: 'kg',
        source_reference: 'Direct test',
        description: 'Test from direct API call'
    };
    
    console.log('Test data:', testData);
    console.log('URL:', CUSTOM_FACTOR_ADD_URL);
    
    fetch(CUSTOM_FACTOR_ADD_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify(testData)
    })
    .then(response => {
        console.log('Test API Response status:', response.status);
        console.log('Test API Response headers:', response.headers);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Test API Response data:', data);
        alert('Direct API test successful!');
    })
    .catch(error => {
        console.error('Test API Error:', error);
        alert('Direct API test failed: ' + error.message);
    });
}

// Request New Material Functions
function showRequestMaterialModal(prefilledCategory) {
    const modal = document.getElementById('requestMaterialModal');
    modal.style.display = 'flex';
    
    // Clear all fields
    document.getElementById('request-material-name').value = '';
    document.getElementById('request-description').value = '';
    document.getElementById('request-suggested-factor').value = '';
    document.getElementById('request-suggested-unit').value = '';
    document.getElementById('request-suggested-source').value = '';
    
    // Pre-fill category if provided
    const categorySelect = document.getElementById('request-category');
    if (prefilledCategory) {
        const categoryMap = {
            'stationary': 'stationary',
            'mobile': 'mobile',
            'purchased-goods': 'purchased-goods',
            'capital-goods': 'capital-goods',
            'waste': 'waste'
        };
        categorySelect.value = categoryMap[prefilledCategory] || '';
    } else {
        categorySelect.value = '';
    }
}

function hideRequestMaterialModal() {
    document.getElementById('requestMaterialModal').style.display = 'none';
}

function submitMaterialRequest(e) {
    if (e) e.preventDefault();   // ÿ¨ŸÑŸà⁄Ø€åÿ±€å ÿßÿ≤ submit ŸÅÿ±ŸÖ
    if (e) e.stopPropagation();  // ÿ¨ŸÑŸà⁄Ø€åÿ±€å ÿßÿ≤ bubble up
    
    const materialName = document.getElementById('request-material-name').value.trim();
    const category = document.getElementById('request-category').value;
    const description = document.getElementById('request-description').value.trim();
    
    if (!materialName || !category || !description) {
        alert('Please fill in all required fields');
        return;
    }
    
    const requestData = {
        material_name: materialName,
        category: category,
        description: description,
        suggested_factor: document.getElementById('request-suggested-factor').value || null,
        suggested_unit: document.getElementById('request-suggested-unit').value || null,
        suggested_source: document.getElementById('request-suggested-source').value.trim() || null
    };
    
    fetch(MATERIAL_REQUEST_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify(requestData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            // Show error message as toast
            const errorMsg = document.createElement('div');
            errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error: ' + data.error;
            document.body.appendChild(errorMsg);
            
            setTimeout(() => {
                errorMsg.remove();
            }, 4000);
        } else {
            hideRequestMaterialModal();
            
            // Clear form
            document.getElementById('request-material-name').value = '';
            document.getElementById('request-category').value = '';
            document.getElementById('request-description').value = '';
            document.getElementById('request-suggested-factor').value = '';
            document.getElementById('request-suggested-unit').value = '';
            document.getElementById('request-suggested-source').value = '';
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #22c55e; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Request submitted! Admin will review it soon.';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                successMsg.remove();
            }, 4000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Show error message as toast
        const errorMsg = document.createElement('div');
        errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
        errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Failed to submit request. Please try again.';
        document.body.appendChild(errorMsg);
        
        setTimeout(() => {
            errorMsg.remove();
        }, 4000);
    });
}

function loadCustomFactors(category) {
    // Load custom factors for the specified category
    const url = category ? `/api/custom-factors/?category=${category}` : '/api/custom-factors/';
    
    fetch(url, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.factors && data.factors.length > 0) {
            // Update purchased-goods dropdown with custom factors
            updateCustomFactorsInDropdown('purchased-goods-source', data.factors);
            
            console.log(`Loaded ${data.factors.length} custom factors`);
        }
    })
    .catch(error => {
        console.error('Error loading custom factors:', error);
    });
}

function updateCustomFactorsInDropdown(selectId, factors) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    // Find or create custom factors optgroup
    let optgroup = document.getElementById('custom-factors-optgroup');
    
    if (factors.length > 0) {
        // Clear existing custom factors
        optgroup.innerHTML = '';
        
        // Add custom factors
        factors.forEach(factor => {
            const option = document.createElement('option');
            option.value = 'custom-' + factor.id;
            option.textContent = `${factor.material_name} (${factor.emission_factor} kg CO2e/${factor.unit})`;
            if (factor.is_verified) {
                option.textContent += ' ‚úì';
            }
            optgroup.appendChild(option);
        });
        
        // Show optgroup
        optgroup.style.display = 'block';
    } else {
        // Hide optgroup if no custom factors
        if (optgroup) {
            optgroup.style.display = 'none';
        }
    }
}

function calculateWithCustomFactor(customFactorId, activityData, description) {
    // Calculate emissions using a custom emission factor
    fetch('/api/custom-factors/calculate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            custom_factor_id: customFactorId,
            activity_data: activityData,
            description: description || ''
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            // Show result (same as standard calculation)
            const form = document.getElementById('purchased-goods-form');
            showResult(data, form);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Calculation failed. Please try again.');
    });
}

// Load suppliers and custom factors on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSuppliers();
    loadCustomFactors('purchased-goods'); // Load custom factors for purchased goods
    loadIndustryTypes(); // Load industry types
    
    // Character counter for fugitive description
    const fugitiveDescription = document.getElementById('fugitive-description');
    const fugitiveCharCount = document.getElementById('fugitive-char-count');
    
    if (fugitiveDescription && fugitiveCharCount) {
        fugitiveDescription.addEventListener('input', function() {
            fugitiveCharCount.textContent = this.value.length;
        });
    }
});

// Load industry types from API
function loadIndustryTypes() {
    const industrySelect = document.getElementById('stationary-industry-type');
    if (!industrySelect) return;
    
    // Show loading state
    industrySelect.innerHTML = '<option value="">{% trans "üîÑ Loading industries..." %}</option>';
    industrySelect.disabled = true;
    
    fetch(GET_INDUSTRIES_URL)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.industries && data.industries.length > 0) {
                // Store industries globally for search
                window.allIndustries = data.industries;
                
                // Clear loading state
                industrySelect.innerHTML = '<option value="">{% trans "Select Industry Type" %}</option>';
                
                // Add industries from API
                data.industries.forEach(industry => {
                    const option = document.createElement('option');
                    option.value = industry.id;
                    option.textContent = industry.code ? `${industry.name} (${industry.code})` : industry.name;
                    option.title = industry.description || '';
                    option.dataset.name = industry.name.toLowerCase();
                    option.dataset.code = (industry.code || '').toLowerCase();
                    option.dataset.description = (industry.description || '').toLowerCase();
                    industrySelect.appendChild(option);
                });
                
                // Show search box if there are many industries
                if (data.industries.length > 10) {
                    const searchInput = document.getElementById('industry-search');
                    if (searchInput) {
                        searchInput.style.display = 'block';
                        searchInput.addEventListener('input', filterIndustries);
                    }
                }
                
                console.log(`‚úì Loaded ${data.industries.length} industry types`);
            } else {
                industrySelect.innerHTML = '<option value="">{% trans "No industries available" %}</option>';
            }
        })
        .catch(error => {
            console.error('Error loading industry types:', error);
            industrySelect.innerHTML = '<option value="">{% trans "‚ùå Failed to load industries" %}</option>';
            
            // Show user-friendly error
            const errorMsg = document.createElement('p');
            errorMsg.style.cssText = 'color: #ef4444; font-size: 12px; margin-top: 5px;';
            errorMsg.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed to load industry types. Please refresh the page.';
            
            const industryGroup = document.getElementById('industry-type-group');
            if (industryGroup && !industryGroup.querySelector('.error-message')) {
                errorMsg.className = 'error-message';
                industryGroup.appendChild(errorMsg);
            }
        })
        .finally(() => {
            industrySelect.disabled = false;
        });
}

// Filter industries based on search input
function filterIndustries() {
    const searchInput = document.getElementById('industry-search');
    const industrySelect = document.getElementById('stationary-industry-type');
    
    if (!searchInput || !industrySelect || !window.allIndustries) return;
    
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    // Clear current options except the first one
    industrySelect.innerHTML = '<option value="">{% trans "Select Industry Type" %}</option>';
    
    // Filter and add matching industries
    const filteredIndustries = window.allIndustries.filter(industry => {
        return industry.name.toLowerCase().includes(searchTerm) ||
               (industry.code && industry.code.toLowerCase().includes(searchTerm)) ||
               (industry.description && industry.description.toLowerCase().includes(searchTerm));
    });
    
    filteredIndustries.forEach(industry => {
        const option = document.createElement('option');
        option.value = industry.id;
        option.textContent = industry.code ? `${industry.name} (${industry.code})` : industry.name;
        option.title = industry.description || '';
        industrySelect.appendChild(option);
    });
    
    // Show "no results" if nothing found
    if (filteredIndustries.length === 0 && searchTerm) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = `No industries found for "${searchTerm}"`;
        option.disabled = true;
        industrySelect.appendChild(option);
    }
}

// Show add industry modal
function showAddIndustryModal() {
    const modal = document.getElementById('addIndustryModal');
    modal.style.display = 'flex';
}

// Hide add industry modal
function hideAddIndustryModal() {
    const modal = document.getElementById('addIndustryModal');
    modal.style.display = 'none';
    
    // Clear form
    document.getElementById('modal-industry-name').value = '';
    document.getElementById('modal-industry-code').value = '';
    document.getElementById('modal-industry-description').value = '';
    document.getElementById('modal-business-context').value = '';
    
    // Clear any error/success messages
    clearErrorMessages();
}

// Save industry request
function saveIndustryRequest() {
    const industryName = document.getElementById('modal-industry-name').value.trim();
    const industryCode = document.getElementById('modal-industry-code').value.trim();
    const description = document.getElementById('modal-industry-description').value.trim();
    const businessContext = document.getElementById('modal-business-context').value.trim();
    
    // Clear previous error messages
    clearErrorMessages();
    
    // Client-side validation
    const errors = [];
    
    if (!industryName) {
        errors.push('Industry name is required');
    } else if (industryName.length < 3) {
        errors.push('Industry name must be at least 3 characters long');
    } else if (industryName.length > 200) {
        errors.push('Industry name cannot exceed 200 characters');
    }
    
    if (!description) {
        errors.push('Industry description is required');
    } else if (description.length < 10) {
        errors.push('Description must be at least 10 characters long');
    } else if (description.length > 1000) {
        errors.push('Description cannot exceed 1000 characters');
    }
    
    if (industryCode && industryCode.length > 20) {
        errors.push('Industry code cannot exceed 20 characters');
    }
    
    if (businessContext && businessContext.length > 1000) {
        errors.push('Business context cannot exceed 1000 characters');
    }
    
    // Show validation errors
    if (errors.length > 0) {
        showErrorMessage(errors.join('<br>'));
        return;
    }
    
    const saveBtn = document.getElementById('save-industry-btn');
    const originalText = saveBtn.innerHTML;
    
    // Show loading state
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    saveBtn.disabled = true;
    
    const data = {
        industry_name: industryName,
        industry_code: industryCode || null,
        description: description,
        business_context: businessContext || null
    };
    
    fetch(INDUSTRY_REQUEST_URL, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            if (data.auto_approved) {
                showSuccessMessage(`üéâ ${data.message}`);
                setTimeout(() => {
                    hideAddIndustryModal();
                    // Reload industry types to show the newly approved industry
                    loadIndustryTypes();
                }, 3000);
            } else {
                showSuccessMessage(data.message || 'Industry request submitted successfully!');
                setTimeout(() => {
                    hideAddIndustryModal();
                    // Reload industry types to show any newly approved ones
                    loadIndustryTypes();
                }, 2000);
            }
        } else {
            showErrorMessage(data.error || 'Unknown error occurred');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (error.error) {
            showErrorMessage(error.error);
        } else {
            showErrorMessage('Network error. Please check your connection and try again.');
        }
    })
    .finally(() => {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

// Helper functions for error/success messages
function showErrorMessage(message) {
    const modal = document.getElementById('addIndustryModal');
    let errorDiv = modal.querySelector('.error-message');
    
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.style.cssText = 'background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 12px; border-radius: 8px; margin: 15px 0; font-size: 13px;';
        
        const formContainer = modal.querySelector('.form-group').parentNode;
        formContainer.insertBefore(errorDiv, formContainer.querySelector('.form-group'));
    }
    
    errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function showSuccessMessage(message) {
    const modal = document.getElementById('addIndustryModal');
    let successDiv = modal.querySelector('.success-message');
    
    if (!successDiv) {
        successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.style.cssText = 'background: #f0fdf4; border: 1px solid #bbf7d0; color: #16a34a; padding: 12px; border-radius: 8px; margin: 15px 0; font-size: 13px;';
        
        const formContainer = modal.querySelector('.form-group').parentNode;
        formContainer.insertBefore(successDiv, formContainer.querySelector('.form-group'));
    }
    
    successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    successDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function clearErrorMessages() {
    const modal = document.getElementById('addIndustryModal');
    const errorMsg = modal.querySelector('.error-message');
    const successMsg = modal.querySelector('.success-message');
    
    if (errorMsg) errorMsg.remove();
    if (successMsg) successMsg.remove();
}

// Character counter function
function updateCharCount(inputId, counterId, maxLength) {
    const input = document.getElementById(inputId);
    const counter = document.getElementById(counterId);
    
    if (input && counter) {
        const currentLength = input.value.length;
        counter.textContent = currentLength;
        
        // Change color based on usage
        if (currentLength > maxLength * 0.9) {
            counter.style.color = '#dc2626'; // Red when near limit
        } else if (currentLength > maxLength * 0.7) {
            counter.style.color = '#f59e0b'; // Orange when getting close
        } else {
            counter.style.color = '#666'; // Default gray
        }
    }
}
</script>
{% endblock %}
