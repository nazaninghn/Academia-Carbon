{% extends 'dashboard_base.html' %}
{% load static %}
{% load i18n %}

{% block page_title %}Data Entry{% endblock %}

{% block extra_css %}
<style>

    .btn-data-entry {
        background: #22c55e;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin: 0 20px 20px 20px;
        width: calc(100% - 40px);
    }

    .btn-data-entry:hover {
        background: #16a34a;
    }

    .sidebar-menu {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .sidebar-menu li a {
        display: block;
        padding: 12px 25px;
        color: #666;
        text-decoration: none;
        transition: all 0.3s;
        font-size: 14px;
    }

    .sidebar-menu li a:hover,
    .sidebar-menu li a.active {
        background: #f0f9ff;
        color: #0ea5e9;
        border-left: 3px solid #0ea5e9;
    }

    .sidebar-menu i {
        width: 20px;
        margin-right: 10px;
    }

    .content-area {
        flex: 1;
        padding: 30px;
        overflow-y: auto;
    }

    .page-header {
        margin-bottom: 30px;
    }

    .page-header h1 {
        font-size: 24px;
        font-weight: 700;
        color: #333;
        margin-bottom: 5px;
    }

    .scope-tabs {
        display: flex;
        gap: 0;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 30px;
    }

    .scope-tab {
        padding: 12px 24px;
        background: transparent;
        border: none;
        color: #666;
        font-weight: 600;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
        font-size: 14px;
    }

    .scope-tab:hover {
        color: #22c55e;
    }

    .scope-tab.active {
        color: #22c55e;
        border-bottom-color: #22c55e;
    }

    .scope-content {
        display: none;
    }

    .scope-content.active {
        display: block;
    }

    .form-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 20px;
    }

    .emission-category {
        padding: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .emission-category:hover {
        border-color: #22c55e;
        background: #f0fdf4;
    }

    .emission-category h3 {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .emission-category p {
        font-size: 13px;
        color: #666;
        margin: 5px 0 0 0;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }

    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
    }

    .form-control:focus {
        outline: none;
        border-color: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
    }

    .form-control::placeholder {
        color: #999;
    }

    .btn-calculate {
        background: #22c55e;
        color: white;
        border: none;
        padding: 12px 32px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        float: right;
    }

    .btn-calculate:hover {
        background: #16a34a;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    .help-icon {
        color: #999;
        cursor: help;
    }

    .activity-input {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .activity-input input {
        flex: 1;
    }

    .activity-input button {
        background: #22c55e;
        color: white;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 18px;
    }

    .activity-input button:hover {
        background: #16a34a;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <button class="btn-data-entry">
            <i class="fas fa-plus"></i> Data entry
        </button>
        
        <ul class="sidebar-menu">
            <li><a href="{% url 'ghg:index' %}"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="{% url 'ghg:data_entry' %}" class="active"><i class="fas fa-edit"></i> Emission Management</a></li>
            <li><a href="{% url 'ghg:emission_history' %}"><i class="fas fa-history"></i> History</a></li>
            <li><a href="#"><i class="fas fa-chart-line"></i> Analysis</a></li>
            <li><a href="#"><i class="fas fa-file-alt"></i> Reporting</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="content-area">
        <div class="page-header">
            <h1>{% trans "Data Entry" %}</h1>
            <p class="text-muted">Organization: <strong>{{ user.username|title }}</strong></p>
            
            <!-- Country Selector -->
            <div style="margin-top: 15px;">
                <label style="font-size: 14px; font-weight: 600; color: #333; margin-right: 10px;">
                    <i class="fas fa-globe"></i> Country/Region:
                </label>
                <select id="country-selector" style="padding: 8px 16px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; min-width: 200px;">
                    <option value="global">üåç Global Average</option>
                    <option value="turkey" selected>üáπüá∑ Turkey (T√ºrkiye)</option>
                </select>
                <span id="country-info" style="margin-left: 10px; font-size: 12px; color: #666;">
                    <i class="fas fa-info-circle"></i> Using Turkey-specific emission factors
                </span>
            </div>
        </div>

        <!-- Scope Tabs -->
        <div class="scope-tabs">
            <button class="scope-tab active" onclick="switchScope(1)">Scope 1</button>
            <button class="scope-tab" onclick="switchScope(2)">Scope 2</button>
            <button class="scope-tab" onclick="switchScope(3)">Scope 3</button>
        </div>

        <!-- Scope 1 Content -->
        <div class="scope-content active" id="scope1">
            <div class="form-card">
                <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">Scope 1 - Direct Emissions</h2>
                
                <div class="emission-category" onclick="toggleCategory('stationary')">
                    <h3>
                        Stationary combustion
                        <i class="fas fa-chevron-down"></i>
                    </h3>
                    <p>Emissions from fuel combustion in stationary equipment</p>
                </div>

                <div id="stationary-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control" id="stationary-source" onchange="updateStationaryFields(); handleOtherSelection(this, 'stationary')">
                            <option value="">Select Emission Source</option>
                            <option value="coal-industrial">Coal (industrial) - Defra 2024</option>
                            <option value="coal">Coal (generic) - IPCC 2006</option>
                            <option value="gas-diesel-oil-energy">Gas/Diesel Oil (energy basis) - IPCC 2019</option>
                            <option value="lpg">Liquefied Petroleum Gas (LPG) - Defra 2024</option>
                            <option value="propane">Propane - Defra 2024</option>
                            <option value="motor-gasoline">Motor Gasoline - IPCC 2019</option>
                            <option value="natural-gas">Natural Gas - IPCC 2019</option>
                            <option value="diesel">Diesel (volume) - IPCC 2006</option>
                            <option value="fuel-oil">Fuel Oil - IPCC 2006</option>
                            <option value="other">üìù Other / Not Listed</option>
                        </select>
                        <p class="text-muted" style="font-size: 12px; margin-top: 8px;">
                            <i class="fas fa-info-circle"></i> Calculate your emissions more precisely by accessing additional emission sources with the Booster Plan. 
                            <a href="#" style="color: #22c55e;">Learn more</a>
                        </p>
                    </div>

                    <!-- Industry Type (only for Gas/Diesel Oil) -->
                    <div class="form-group" id="industry-type-group" style="display: none;">
                        <label>Industry Type</label>
                        <select class="form-control" id="stationary-industry-type">
                            <option value="">Select Industry Type</option>
                            <option value="commercial-institutional">Commercial/Institutional</option>
                            <option value="residential-agriculture">Residential and Agriculture/Forestery/Fishing/Fishing Farms</option>
                            <option value="manufacturing-construction">Manufacturing And Construction</option>
                            <option value="energy-industries">Energy Industries</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control" id="stationary-unit">
                            <option value="">Select Unit</option>
                            <option value="liters">Liters</option>
                            <option value="kg">Kilograms</option>
                            <option value="m3">Cubic Meters (m¬≥)</option>
                            <option value="kwh">kWh</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" id="stationary-activity" placeholder="Enter activity data" value="0">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Supplier (Optional)</label>
                        <div style="display: flex; gap: 10px;">
                            <select class="form-control supplier-select" id="stationary-supplier" style="flex: 1;">
                                <option value="">Select Supplier</option>
                            </select>
                            <button type="button" class="btn-add-supplier" onclick="showAddSupplierModal()" style="background: #0ea5e9; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; white-space: nowrap;">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Description (Optional) <span class="text-muted">0/100</span></label>
                        <textarea class="form-control" id="stationary-description" rows="3" maxlength="100" placeholder="Add description"></textarea>
                    </div>

                    <p class="text-muted" style="font-size: 13px;">
                        You can <a href="#" style="color: #22c55e;">add your proof document</a> here (i.e. gas bills).
                    </p>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>

                <div class="emission-category" onclick="toggleCategory('mobile')">
                    <h3>
                        Mobile combustion
                        <i class="fas fa-chevron-down"></i>
                    </h3>
                    <p>Emissions from fuel combustion in mobile equipment</p>
                </div>

                <div id="mobile-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control" id="mobile-source" onchange="updateMobileFields(); handleOtherSelection(this, 'mobile')">
                            <option value="">Select Emission Source</option>
                            <option value="off-road-ipcc">Off-Road Equipment - IPCC 2019</option>
                            <option value="off-road-diesel">Off-Road Diesel - DESNZ 2024</option>
                            <option value="off-road-gasoline">Off-Road Gasoline - DESNZ 2024</option>
                            <option value="on-road-diesel">On-Road Diesel - IPCC 2019</option>
                            <option value="on-road-gasoline-low-mileage">On-Road Gasoline (Low Mileage) - IPCC 2019</option>
                            <option value="on-road-gasoline-uncontrolled">On-Road Gasoline (Uncontrolled) - IPCC 2019</option>
                            <option value="on-road-gasoline-oxidation">On-Road Gasoline (Oxidation Catalyst) - IPCC 2019</option>
                            <option value="on-road-natural-gas">On-Road Natural Gas - IPCC 2019</option>
                            <option value="on-road-lpg">On-Road LPG - IPCC 2019</option>
                            <option value="on-road-petrol-desnz">On-Road Petrol - DESNZ 2024</option>
                            <option value="on-road-diesel-desnz">On-Road Diesel - DESNZ 2024</option>
                            <option value="gasoline">Gasoline (generic)</option>
                            <option value="diesel">Diesel (generic)</option>
                            <option value="cng">CNG</option>
                            <option value="vehicle-km">Vehicle distance (avg car)</option>
                            <option value="other">üìù Other / Not Listed</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control" id="mobile-unit">
                            <option value="">Select Unit</option>
                            <option value="liters">Liters</option>
                            <option value="kg">Kilograms</option>
                            <option value="gj">Gigajoules (GJ)</option>
                            <option value="km">Kilometers</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" id="mobile-activity" placeholder="Enter activity data" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Supplier (Optional)</label>
                        <div style="display: flex; gap: 10px;">
                            <select class="form-control supplier-select" id="mobile-supplier" style="flex: 1;">
                                <option value="">Select Supplier</option>
                            </select>
                            <button type="button" class="btn-add-supplier" onclick="showAddSupplierModal()" style="background: #0ea5e9; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; white-space: nowrap;">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Description (Optional) <span class="text-muted">0/100</span></label>
                        <textarea class="form-control" id="mobile-description" rows="3" maxlength="100" placeholder="Add description"></textarea>
                    </div>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>

                <div class="emission-category" onclick="toggleCategory('fugitive')">
                    <h3>
                        Fugitive emissions
                        <i class="fas fa-chevron-down"></i>
                    </h3>
                    <p>Emissions from refrigerants, air conditioning, and other sources</p>
                </div>

                <div id="fugitive-form" style="display: none;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control" id="fugitive-source" onchange="handleOtherSelection(this, 'fugitive')">
                            <option value="">Select Emission Source</option>
                            <option value="r410a">R-410A (Refrigerant) - Defra 2024</option>
                            <option value="r432a">R-432A (Refrigerant) - Defra 2024</option>
                            <option value="r22">R-22 (HCFC-22) - Defra 2024</option>
                            <option value="hfc-227ea">HFC-227ea - Defra 2024</option>
                            <option value="r600a">R-600a (Isobutane) - Defra 2024</option>
                            <option value="methane">Methane (CH4) - IPCC AR6</option>
                            <option value="other">üìù Other / Not Listed</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control" id="fugitive-unit" disabled>
                            <option value="kg">Kilograms (kg)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data</label>
                        <div class="activity-input">
                            <button type="button" onclick="adjustValue(this, -1)">‚àí</button>
                            <input type="number" class="form-control" id="fugitive-activity" placeholder="Enter activity data" value="0" min="0" step="0.1">
                            <button type="button" onclick="adjustValue(this, 1)">+</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Supplier (Optional)</label>
                        <div style="display: flex; gap: 10px;">
                            <select class="form-control supplier-select" id="fugitive-supplier" style="flex: 1;">
                                <option value="">Select Supplier</option>
                            </select>
                            <button type="button" class="btn-add-supplier" onclick="showAddSupplierModal()" style="background: #0ea5e9; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; white-space: nowrap;">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Description <span style="color: #999; font-weight: normal;">(Optional)</span></label>
                        <textarea class="form-control" id="fugitive-description" placeholder="Add description" rows="3" maxlength="500"></textarea>
                        <small class="form-text text-muted" style="text-align: right; display: block;">
                            <span id="fugitive-char-count">0</span>/500
                        </small>
                    </div>

                    <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
                        You can <strong>add your proof document</strong> here (i.e. gas bills).
                    </p>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>
            </div>
        </div>

        <!-- Scope 2 Content -->
        <div class="scope-content" id="scope2">
            <div class="form-card">
                <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">Scope 2 - Indirect Emissions (Energy)</h2>
                
                <div class="emission-category" onclick="toggleCategory('electricity')">
                    <h3>
                        Electricity
                        <i class="fas fa-chevron-down help-icon" title="Emissions from purchased electricity"></i>
                    </h3>
                    <p>Emissions from purchased electricity consumption</p>
                </div>

                <div id="electricity-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control" id="electricity-source">
                            <option value="">Select Emission Source</option>
                            <option value="turkey-grid">üáπüá∑ Turkey National Grid</option>
                            <option value="grid-average">üåç Grid Average (Global)</option>
                            <option value="us-grid">üá∫üá∏ US Grid</option>
                            <option value="eu-grid">üá™üá∫ EU Grid</option>
                            <option value="china-grid">üá®üá≥ China Grid</option>
                            <option value="renewable">‚ôªÔ∏è 100% Renewable Energy</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control" disabled>
                            <option value="kwh">kWh</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="Enter activity data" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Supplier (Optional)</label>
                        <select class="form-control">
                            <option value="">Select Supplier</option>
                            <option value="supplier1">Electric Company 1</option>
                            <option value="supplier2">Electric Company 2</option>
                            <option value="supplier3">Electric Company 3</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Description (Optional) <span class="text-muted">0/100</span></label>
                        <textarea class="form-control" rows="3" maxlength="100" placeholder="Add description"></textarea>
                    </div>

                    <p class="text-muted" style="font-size: 13px;">
                        You can <a href="#" style="color: #22c55e;">add your proof document</a> here (i.e. gas bills).
                    </p>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>

                <div class="emission-category" onclick="toggleCategory('steam-heat')">
                    <h3>
                        Steam, Heat and Cooling
                        <i class="fas fa-chevron-down help-icon" title="Emissions from purchased steam, heat, or cooling"></i>
                    </h3>
                    <p>Emissions from purchased steam, heating, or cooling energy</p>
                </div>

                <div id="steam-heat-form" style="display: none;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control" id="steam-heat-source">
                            <option value="">Select Emission Source</option>
                            <option value="district-heating">District Heating</option>
                            <option value="district-cooling">District Cooling</option>
                            <option value="steam">Steam</option>
                            <option value="chilled-water">Chilled Water</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control">
                            <option value="">Select Unit</option>
                            <option value="kwh">kWh</option>
                            <option value="mj">MJ (Megajoules)</option>
                            <option value="mmbtu">MMBtu</option>
                            <option value="tons">Tons</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="Enter activity data" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Supplier (Optional)</label>
                        <select class="form-control">
                            <option value="">Select Supplier</option>
                            <option value="supplier1">Energy Provider 1</option>
                            <option value="supplier2">Energy Provider 2</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Description (Optional) <span class="text-muted">0/100</span></label>
                        <textarea class="form-control" rows="3" maxlength="100" placeholder="Add description"></textarea>
                    </div>

                    <p class="text-muted" style="font-size: 13px;">
                        You can <a href="#" style="color: #22c55e;">add your proof document</a> here (i.e. gas bills).
                    </p>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>
            </div>
        </div>

        <!-- Scope 3 Content -->
        <div class="scope-content" id="scope3">
            <div class="form-card">
                <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 20px;">Scope 3 - Other Indirect Emissions</h2>
                
                <!-- Purchased Goods and Services -->
                <div class="emission-category" onclick="toggleCategory('purchased-goods')">
                    <h3>
                        Purchased Goods and Services
                        <i class="fas fa-chevron-down help-icon" title="Emissions from purchased goods and services"></i>
                    </h3>
                    <p>Emissions from production of purchased goods and services</p>
                </div>

                <div id="purchased-goods-form" style="display: none; margin-bottom: 30px;">
                    <!-- Custom Factor & Request Material Buttons -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px;">
                        <button type="button" onclick="showCustomFactorModal()" style="flex: 1; background: #22c55e; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                            <i class="fas fa-calculator"></i> Use Custom Factor
                        </button>
                        <button type="button" onclick="showRequestMaterialModal()" style="flex: 1; background: #3b82f6; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px;">
                            <i class="fas fa-paper-plane"></i> Request New Material
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control" id="purchased-goods-source" onchange="handlePurchasedGoodsSourceChange(this)">
                            <option value="">Select Emission Source</option>
                            <optgroup label="Turkey-Specific (ATOM KABLO ISO 14064-1)">
                                <option value="chemical">Chemical</option>
                                <option value="chemical-oil">Chemical Oil</option>
                                <option value="plastic">Plastic</option>
                                <option value="carton">Carton</option>
                                <option value="metal-primary">Metal (Primary)</option>
                                <option value="metal-recycled">Metal (Recycled)</option>
                                <option value="wood">Wood</option>
                                <option value="foam-tape">Foam Tape</option>
                            </optgroup>
                            <optgroup label="Global (Defra 2024)">
                                <option value="electrical-large">Electrical Items - Large</option>
                                <option value="electrical-small">Electrical Items - Small</option>
                                <option value="electrical-fridges-freezers">Electrical Items - Fridges & Freezers</option>
                                <option value="electrical-it">Electrical Items - IT</option>
                                <option value="glass">Glass</option>
                                <option value="metal-aluminium-cans-foil">Metal: Aluminium Cans & Foil</option>
                                <option value="metal-mixed-cans">Metal: Mixed Cans</option>
                                <option value="metal-steel-cans">Metal: Steel Cans</option>
                                <option value="mineral-oil">Mineral Oil</option>
                                <option value="paper-mixed">Paper & Board: Mixed</option>
                                <option value="plastic-average">Plastics: Average</option>
                                <option value="plastic-hdpe">Plastics: HDPE</option>
                            </optgroup>
                            <optgroup label="Custom Factors" id="custom-factors-optgroup" style="display: none;">
                                <!-- Custom factors will be loaded here dynamically -->
                            </optgroup>
                            <optgroup label="Other">
                                <option value="other">üìù Other / Not Listed</option>
                            </optgroup>
                        </select>
                        <p style="font-size: 12px; color: #666; margin-top: 8px;">
                            <i class="fas fa-info-circle"></i> Can't find your material? Select "Other" or use buttons above.
                        </p>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control">
                            <option value="">Select Unit</option>
                            <option value="kg">Kilograms</option>
                            <option value="units">Units</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="Enter activity data" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Supplier (Optional)</label>
                        <select class="form-control">
                            <option value="">Select Supplier</option>
                            <option value="supplier1">Supplier 1</option>
                            <option value="supplier2">Supplier 2</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Description (Optional) <span class="text-muted">0/100</span></label>
                        <textarea class="form-control" rows="3" maxlength="100" placeholder="Add description"></textarea>
                    </div>

                    <p class="text-muted" style="font-size: 13px;">
                        You can <a href="#" style="color: #22c55e;">add your proof document</a> here (i.e. gas bills).
                    </p>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Capital Goods -->
                <div class="emission-category" onclick="toggleCategory('capital-goods')">
                    <h3>
                        Capital Goods
                        <i class="fas fa-chevron-down help-icon" title="Emissions from capital goods"></i>
                    </h3>
                    <p>Emissions from production of capital goods (machinery, vehicles, buildings)</p>
                </div>

                <div id="capital-goods-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control">
                            <option value="">Select Emission Source</option>
                            <option value="machinery">Machinery</option>
                            <option value="vehicles">Vehicles</option>
                            <option value="buildings">Buildings/Construction</option>
                            <option value="it-equipment">IT Equipment</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control">
                            <option value="">Select Unit</option>
                            <option value="units">Units</option>
                            <option value="m2">Square Meters (m¬≤)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="Enter activity data" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Fuel and Energy Related Activities -->
                <div class="emission-category" onclick="toggleCategory('fuel-energy')">
                    <h3>
                        Fuel and Energy Related Activities
                        <i class="fas fa-chevron-down help-icon" title="Upstream emissions from fuel and energy"></i>
                    </h3>
                    <p>Upstream emissions from fuel extraction, processing, and transmission losses</p>
                </div>

                <div id="fuel-energy-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control">
                            <option value="">Select Emission Source</option>
                            <option value="upstream-electricity">Upstream Electricity</option>
                            <option value="transmission-losses">Transmission & Distribution Losses</option>
                            <option value="fuel-extraction">Fuel Extraction & Processing</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control">
                            <option value="">Select Unit</option>
                            <option value="kwh">kWh</option>
                            <option value="liters">Liters</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="Enter activity data" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Upstream Transportation and Distribution -->
                <div class="emission-category" onclick="toggleCategory('upstream-transport')">
                    <h3>
                        Upstream Transportation and Distribution
                        <i class="fas fa-chevron-down help-icon" title="Transportation of purchased goods"></i>
                    </h3>
                    <p>Emissions from transportation and distribution of purchased goods</p>
                </div>

                <div id="upstream-transport-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control">
                            <option value="">Select Emission Source</option>
                            <option value="truck-freight">Truck Freight</option>
                            <option value="rail-freight">Rail Freight</option>
                            <option value="sea-freight">Sea Freight</option>
                            <option value="air-freight">Air Freight</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control" disabled>
                            <option value="tonne-km">Tonne-km</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data (tonne-km)</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="Enter activity data" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Water Supply and Treatment -->
                <div class="emission-category" onclick="toggleCategory('water')">
                    <h3>
                        Water Supply and Treatment
                        <i class="fas fa-chevron-down help-icon" title="Emissions from water supply and wastewater treatment"></i>
                    </h3>
                    <p>Emissions from water supply and wastewater treatment (Defra 2024)</p>
                </div>

                <div id="water-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control" id="water-source">
                            <option value="">Select Emission Source</option>
                            <option value="supply">Water Supply - Defra 2024</option>
                            <option value="treatment">Wastewater Treatment - Defra 2024</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control" disabled>
                            <option value="m3">Cubic Meters (m¬≥)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data (m¬≥)</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="Enter volume" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Supplier (Optional)</label>
                        <div style="display: flex; gap: 10px;">
                            <select class="form-control supplier-select" id="water-supplier" style="flex: 1;">
                                <option value="">Select Supplier</option>
                            </select>
                            <button type="button" class="btn-add-supplier" onclick="showAddSupplierModal()" style="background: #0ea5e9; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; white-space: nowrap;">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Description (Optional) <span class="text-muted">0/100</span></label>
                        <textarea class="form-control" rows="3" maxlength="100" placeholder="Add description"></textarea>
                    </div>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Waste Generated in Operations -->
                <div class="emission-category" onclick="toggleCategory('waste')">
                    <h3>
                        Waste Generated in Operations
                        <i class="fas fa-chevron-down help-icon" title="Emissions from waste disposal"></i>
                    </h3>
                    <p>Emissions from disposal and treatment of waste generated in operations</p>
                </div>

                <div id="waste-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control" id="waste-source" onchange="handleOtherSelection(this, 'waste')">
                            <option value="">Select Emission Source</option>
                            <optgroup label="Turkey">
                                <option value="landfill">Landfill (Turkey)</option>
                                <option value="recyclable">Recyclable (Turkey)</option>
                                <option value="organic-compost">Organic Compost (Turkey)</option>
                                <option value="incineration">Incineration (Turkey)</option>
                            </optgroup>
                            <optgroup label="Global">
                                <option value="general-landfill">General Waste (Landfill)</option>
                                <option value="recyclable">Recyclable Waste</option>
                                <option value="organic-compost">Organic Waste (Compost)</option>
                                <option value="incineration">Waste Incineration</option>
                            </optgroup>
                            <optgroup label="Other">
                                <option value="other">üìù Other / Not Listed</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control" disabled>
                            <option value="kg">Kilograms</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="Enter weight" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Business Travel -->
                <div class="emission-category" onclick="toggleCategory('business-travel')">
                    <h3>
                        Business Travel
                        <i class="fas fa-chevron-down help-icon" title="Emissions from employee business travel"></i>
                    </h3>
                    <p>Emissions from employee business travel in vehicles not owned by the company</p>
                </div>

                <div id="business-travel-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control" id="business-travel-source">
                            <option value="">Select Emission Source</option>
                            <optgroup label="Turkey Transportation">
                                <option value="flight-domestic">üáπüá∑ Domestic Flight (Turkey)</option>
                                <option value="flight-international">‚úàÔ∏è International Flight</option>
                                <option value="train">üöÜ Train (Turkey)</option>
                                <option value="metro">üöá Metro (Turkey)</option>
                                <option value="bus">üöå Bus (Turkey)</option>
                                <option value="dolmus">üöê Dolmu≈ü (Turkey)</option>
                                <option value="car-gasoline">üöó Car - Gasoline (Turkey)</option>
                                <option value="car-diesel">üöó Car - Diesel (Turkey)</option>
                                <option value="car-lpg">üöó Car - LPG (Turkey)</option>
                                <option value="car-electric">‚ö° Car - Electric (Turkey)</option>
                                <option value="car-hybrid">üîã Car - Hybrid (Turkey)</option>
                            </optgroup>
                            <optgroup label="Global">
                                <option value="flight-short">Short-haul Flight (< 500 km)</option>
                                <option value="flight-medium">Medium-haul Flight (500-3700 km)</option>
                                <option value="flight-long">Long-haul Flight (> 3700 km)</option>
                                <option value="train">Train</option>
                                <option value="taxi">Taxi</option>
                                <option value="bus">Bus</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control" disabled>
                            <option value="km">Kilometers</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="Enter distance" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Employee Commuting -->
                <div class="emission-category" onclick="toggleCategory('commuting')">
                    <h3>
                        Employee Commuting
                        <i class="fas fa-chevron-down help-icon" title="Emissions from employee commuting"></i>
                    </h3>
                    <p>Emissions from employee commuting between home and work</p>
                </div>

                <div id="commuting-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control" id="commuting-source">
                            <option value="">Select Emission Source</option>
                            <optgroup label="Turkey">
                                <option value="car-gasoline">üöó Car - Gasoline (Turkey)</option>
                                <option value="car-diesel">üöó Car - Diesel (Turkey)</option>
                                <option value="car-lpg">üöó Car - LPG (Turkey)</option>
                                <option value="car-electric">‚ö° Car - Electric (Turkey)</option>
                                <option value="car-hybrid">üîã Car - Hybrid (Turkey)</option>
                                <option value="bus">üöå Bus (Turkey)</option>
                                <option value="metro">üöá Metro (Turkey)</option>
                                <option value="train">üöÜ Train (Turkey)</option>
                                <option value="dolmus">üöê Dolmu≈ü (Turkey)</option>
                            </optgroup>
                            <optgroup label="Global">
                                <option value="car">Car</option>
                                <option value="bus">Bus</option>
                                <option value="train">Train</option>
                                <option value="motorcycle">Motorcycle</option>
                                <option value="bicycle">Bicycle (Zero Emissions)</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control" disabled>
                            <option value="km">Kilometers</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="Enter distance" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Upstream Leased Assets -->
                <div class="emission-category" onclick="toggleCategory('upstream-leased')">
                    <h3>
                        Upstream Leased Assets
                        <i class="fas fa-chevron-down help-icon" title="Emissions from leased assets"></i>
                    </h3>
                    <p>Emissions from operation of assets leased by the reporting company</p>
                </div>

                <div id="upstream-leased-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control">
                            <option value="">Select Emission Source</option>
                            <option value="office-space">Leased Office Space</option>
                            <option value="warehouse">Leased Warehouse</option>
                            <option value="vehicles">Leased Vehicles</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control">
                            <option value="">Select Unit</option>
                            <option value="m2">Square Meters (m¬≤)</option>
                            <option value="units">Units</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="Enter activity data" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Downstream Transportation and Distribution -->
                <div class="emission-category" onclick="toggleCategory('downstream-transport')">
                    <h3>
                        Downstream Transportation and Distribution
                        <i class="fas fa-chevron-down help-icon" title="Transportation of sold products"></i>
                    </h3>
                    <p>Emissions from transportation and distribution of sold products</p>
                </div>

                <div id="downstream-transport-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control">
                            <option value="">Select Emission Source</option>
                            <option value="truck-delivery">Truck Delivery</option>
                            <option value="courier">Courier Service</option>
                            <option value="postal">Postal Service</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control">
                            <option value="">Select Unit</option>
                            <option value="tonne-km">Tonne-km</option>
                            <option value="packages">Packages</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="Enter activity data" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- End of Life Treatment of Sold Products -->
                <div class="emission-category" onclick="toggleCategory('end-of-life')">
                    <h3>
                        End of Life Treatment of Sold Products
                        <i class="fas fa-chevron-down help-icon" title="End of life treatment emissions"></i>
                    </h3>
                    <p>Emissions from waste disposal and treatment of sold products at end of life</p>
                </div>

                <div id="end-of-life-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control">
                            <option value="">Select Emission Source</option>
                            <option value="product-recycling">Product Recycling</option>
                            <option value="product-landfill">Product to Landfill</option>
                            <option value="product-incineration">Product Incineration</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control" disabled>
                            <option value="kg">Kilograms</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="Enter weight" value="0" step="0.01">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Franchises -->
                <div class="emission-category" onclick="toggleCategory('franchises')">
                    <h3>
                        Franchises
                        <i class="fas fa-chevron-down help-icon" title="Emissions from franchise operations"></i>
                    </h3>
                    <p>Emissions from operation of franchises not included in Scope 1 or 2</p>
                </div>

                <div id="franchises-form" style="display: none; margin-bottom: 30px;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control" disabled>
                            <option value="franchise-operations">Franchise Operations</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control" disabled>
                            <option value="franchises">Number of Franchises</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="Enter number of franchises" value="0" step="1">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>

                <!-- Investments -->
                <div class="emission-category" onclick="toggleCategory('investments')">
                    <h3>
                        Investments
                        <i class="fas fa-chevron-down help-icon" title="Emissions from investments"></i>
                    </h3>
                    <p>Emissions from investments (equity, debt, project finance, etc.)</p>
                </div>

                <div id="investments-form" style="display: none;">
                    <div class="form-group">
                        <label>Emission Source</label>
                        <select class="form-control">
                            <option value="">Select Emission Source</option>
                            <option value="equity-investments">Equity Investments</option>
                            <option value="debt-investments">Debt Investments</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit</label>
                        <select class="form-control" disabled>
                            <option value="usd">USD</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Activity Data (USD)</label>
                        <div class="activity-input">
                            <button type="button">‚àí</button>
                            <input type="number" class="form-control" placeholder="Enter investment amount" value="0" step="100">
                            <button type="button">+</button>
                        </div>
                    </div>

                    <button class="btn-calculate">Calculate</button>
                    <div style="clear: both;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Choice Modal for "Other" Selection -->
<div id="otherChoiceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 40px; max-width: 500px; width: 90%; margin: auto;">
        <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 15px; text-align: center;">
            <i class="fas fa-question-circle" style="color: #3b82f6;"></i> Material Not Listed
        </h3>
        <p style="color: #666; font-size: 14px; text-align: center; margin-bottom: 30px;">
            What would you like to do?
        </p>
        
        <!-- Option 1: Custom Factor -->
        <div onclick="selectOtherOption('custom')" style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#22c55e'; this.style.background='#f0fdf4'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="background: #22c55e; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                    <i class="fas fa-calculator"></i>
                </div>
                <div style="flex: 1;">
                    <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 5px 0; color: #333;">I Have the Emission Factor</h4>
                    <p style="font-size: 13px; color: #666; margin: 0;">Add a custom emission factor from your supplier or calculations</p>
                </div>
            </div>
        </div>
        
        <!-- Option 2: Request Material -->
        <div onclick="selectOtherOption('request')" style="border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 25px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#f0f9ff'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="background: #3b82f6; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                    <i class="fas fa-paper-plane"></i>
                </div>
                <div style="flex: 1;">
                    <h4 style="font-size: 16px; font-weight: 600; margin: 0 0 5px 0; color: #333;">I Need Help Finding It</h4>
                    <p style="font-size: 13px; color: #666; margin: 0;">Request our team to research and add the emission factor</p>
                </div>
            </div>
        </div>
        
        <!-- Cancel Button -->
        <button onclick="hideOtherChoiceModal()" style="width: 100%; background: #e0e0e0; color: #333; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
            Cancel
        </button>
    </div>
</div>

<!-- Custom Emission Factor Modal -->
<div id="customFactorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; margin: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="font-size: 20px; font-weight: 700; margin: 0;">
                <i class="fas fa-calculator" style="color: #22c55e; margin-right: 10px;"></i>
                ADD CUSTOM EMISSION FACTOR
            </h3>
            <button onclick="hideCustomFactorModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
        </div>
        <p style="color: #666; font-size: 13px; margin-bottom: 25px;">Add a custom emission factor provided by your supplier or from your own calculations.</p>
        
        <!-- Material Name (Required) -->
        <div class="form-group">
            <label>Material/Product Name <span style="color: red;">*</span></label>
            <input type="text" id="custom-material-name" class="form-control" placeholder="e.g., Recycled Paper, Custom Steel" required>
        </div>
        
        <!-- Category -->
        <div class="form-group">
            <label>Category <span style="color: red;">*</span></label>
            <select id="custom-category" class="form-control" required>
                <option value="">Select Category</option>
                <option value="purchased-goods">Purchased Goods & Services</option>
                <option value="stationary">Stationary Combustion</option>
                <option value="mobile">Mobile Combustion</option>
                <option value="capital-goods">Capital Goods</option>
                <option value="upstream-transport">Upstream Transportation</option>
                <option value="waste">Waste</option>
                <option value="other">Other</option>
            </select>
        </div>
        
        <!-- Emission Factor -->
        <div class="form-group">
            <label>Emission Factor <span style="color: red;">*</span></label>
            <input type="number" id="custom-emission-factor" class="form-control" placeholder="e.g., 2.5" step="0.0001" required>
            <small style="color: #666; font-size: 12px;">kg CO2e per unit</small>
        </div>
        
        <!-- Unit -->
        <div class="form-group">
            <label>Unit <span style="color: red;">*</span></label>
            <select id="custom-unit" class="form-control" required>
                <option value="">Select Unit</option>
                <option value="kg">Kilograms (kg)</option>
                <option value="liters">Liters</option>
                <option value="m3">Cubic Meters (m¬≥)</option>
                <option value="m2">Square Meters (m¬≤)</option>
                <option value="kwh">Kilowatt-hours (kWh)</option>
                <option value="gj">Gigajoules (GJ)</option>
                <option value="km">Kilometers (km)</option>
                <option value="tonne-km">Tonne-kilometers (tonne-km)</option>
                <option value="units">Units (for equipment/machinery)</option>
                <option value="packages">Packages (for delivery)</option>
            </select>
        </div>
        
        <!-- Supplier (Optional) -->
        <div class="form-group">
            <label>Supplier (Optional)</label>
            <select id="custom-supplier" class="form-control supplier-select">
                <option value="">Select Supplier</option>
            </select>
        </div>
        
        <!-- Source/Reference -->
        <div class="form-group">
            <label>Source/Reference</label>
            <textarea id="custom-source-reference" class="form-control" rows="2" placeholder="e.g., Supplier certificate, LCA study, ISO 14064-1 report"></textarea>
        </div>
        
        <!-- Description -->
        <div class="form-group">
            <label>Description</label>
            <textarea id="custom-description" class="form-control" rows="2" placeholder="Additional details about this material"></textarea>
        </div>
        
        <!-- Buttons -->
        <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button onclick="hideCustomFactorModal()" style="flex: 1; background: #e0e0e0; color: #333; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                Cancel
            </button>
            <button onclick="saveCustomFactor()" style="flex: 1; background: #22c55e; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                Save Custom Factor
            </button>
        </div>
    </div>
</div>

<!-- Request New Material Modal -->
<div id="requestMaterialModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; margin: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="font-size: 20px; font-weight: 700; margin: 0;">
                <i class="fas fa-paper-plane" style="color: #3b82f6; margin-right: 10px;"></i>
                REQUEST NEW MATERIAL
            </h3>
            <button onclick="hideRequestMaterialModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
        </div>
        <p style="color: #666; font-size: 13px; margin-bottom: 25px;">Can't find your material in the system? Request it and our team will add the emission factor from official sources (Defra, IPCC, etc.).</p>
        
        <!-- Material Name (Required) -->
        <div class="form-group">
            <label>Material/Product Name <span style="color: red;">*</span></label>
            <input type="text" id="request-material-name" class="form-control" placeholder="e.g., Bamboo Fiber, Bioplastic PLA" required>
        </div>
        
        <!-- Category -->
        <div class="form-group">
            <label>Category <span style="color: red;">*</span></label>
            <select id="request-category" class="form-control" required>
                <option value="">Select Category</option>
                <option value="purchased-goods">Purchased Goods & Services</option>
                <option value="stationary">Stationary Combustion</option>
                <option value="mobile">Mobile Combustion</option>
                <option value="capital-goods">Capital Goods</option>
                <option value="upstream-transport">Upstream Transportation</option>
                <option value="waste">Waste</option>
                <option value="other">Other</option>
            </select>
        </div>
        
        <!-- Description -->
        <div class="form-group">
            <label>Description <span style="color: red;">*</span></label>
            <textarea id="request-description" class="form-control" rows="3" placeholder="Describe the material and why you need it" required></textarea>
        </div>
        
        <!-- Optional: Suggested Factor -->
        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <p style="font-size: 13px; font-weight: 600; color: #333; margin-bottom: 10px;">
                <i class="fas fa-lightbulb" style="color: #3b82f6;"></i> Do you have a suggested emission factor?
            </p>
            <div class="form-group" style="margin-bottom: 10px;">
                <label>Suggested Factor (Optional)</label>
                <input type="number" id="request-suggested-factor" class="form-control" placeholder="e.g., 1.5" step="0.0001">
            </div>
            <div class="form-group" style="margin-bottom: 10px;">
                <label>Unit (Optional)</label>
                <select id="request-suggested-unit" class="form-control">
                    <option value="">Select Unit</option>
                    <option value="kg">Kilograms (kg)</option>
                    <option value="liters">Liters</option>
                    <option value="m3">Cubic Meters (m¬≥)</option>
                    <option value="m2">Square Meters (m¬≤)</option>
                    <option value="kwh">Kilowatt-hours (kWh)</option>
                    <option value="gj">Gigajoules (GJ)</option>
                    <option value="km">Kilometers (km)</option>
                    <option value="tonne-km">Tonne-kilometers (tonne-km)</option>
                    <option value="units">Units (for equipment/machinery)</option>
                    <option value="packages">Packages (for delivery)</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label>Source (Optional)</label>
                <textarea id="request-suggested-source" class="form-control" rows="2" placeholder="Where did you get this factor?"></textarea>
            </div>
        </div>
        
        <!-- Buttons -->
        <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button onclick="hideRequestMaterialModal()" style="flex: 1; background: #e0e0e0; color: #333; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                Cancel
            </button>
            <button onclick="submitMaterialRequest()" style="flex: 1; background: #3b82f6; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                Submit Request
            </button>
        </div>
    </div>
</div>

<!-- Add Supplier Modal -->
<div id="supplierModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; overflow-y: auto; padding: 20px;">
    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; margin: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3 style="font-size: 20px; font-weight: 700; margin: 0;">
                <i class="fas fa-building" style="color: #22c55e; margin-right: 10px;"></i>
                ADD NEW SUPPLIER
            </h3>
            <button onclick="hideAddSupplierModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
        </div>
        <p style="color: #666; font-size: 13px; margin-bottom: 25px;">Add new suppliers to your database.</p>
        
        <!-- Supplier Name (Required) -->
        <div class="form-group">
            <label>Supplier name <span style="color: red;">*</span></label>
            <input type="text" id="modal-supplier-name" class="form-control" placeholder="Enter supplier name" required>
        </div>
        
        <!-- Contact Name -->
        <div class="form-group">
            <label>Contact name</label>
            <input type="text" id="modal-contact-name" class="form-control" placeholder="Enter primary contact name">
        </div>
        
        <!-- Email -->
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="modal-email" class="form-control" placeholder="Enter primary contact email">
        </div>
        
        <!-- Phone Number -->
        <div class="form-group">
            <label>Phone number</label>
            <div style="display: flex; gap: 10px;">
                <select id="modal-phone-code" class="form-control" style="width: 120px;">
                    <option value="+90">üáπüá∑ +90</option>
                    <option value="+1">üá∫üá∏ +1</option>
                    <option value="+44">üá¨üáß +44</option>
                    <option value="+49">üá©üá™ +49</option>
                    <option value="+33">üá´üá∑ +33</option>
                    <option value="+86">üá®üá≥ +86</option>
                </select>
                <input type="tel" id="modal-phone" class="form-control" placeholder="Enter phone number" style="flex: 1;">
            </div>
        </div>
        
        <!-- Activity (Supplier Type) -->
        <div class="form-group">
            <label>Activity</label>
            <select id="modal-supplier-type" class="form-control">
                <option value="">Select activity</option>
                <option value="Energy">Energy</option>
                <option value="Fuel">Fuel</option>
                <option value="Transportation">Transportation</option>
                <option value="Waste Management">Waste Management</option>
                <option value="Manufacturing">Manufacturing</option>
                <option value="Construction">Construction</option>
                <option value="Other">Other</option>
            </select>
        </div>
        
        <!-- Country & City -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>Country</label>
                <select id="modal-country" class="form-control">
                    <option value="">Select country</option>
                    <option value="Turkey">üáπüá∑ Turkey</option>
                    <option value="USA">üá∫üá∏ United States</option>
                    <option value="UK">üá¨üáß United Kingdom</option>
                    <option value="Germany">üá©üá™ Germany</option>
                    <option value="France">üá´üá∑ France</option>
                    <option value="China">üá®üá≥ China</option>
                </select>
            </div>
            <div class="form-group">
                <label>City</label>
                <input type="text" id="modal-city" class="form-control" placeholder="Select city">
            </div>
        </div>
        
        <!-- Tax Number -->
        <div class="form-group">
            <label>Tax number</label>
            <input type="text" id="modal-tax-number" class="form-control" placeholder="Enter tax number">
        </div>
        
        <!-- Company Website -->
        <div class="form-group">
            <label>Company Website</label>
            <input type="url" id="modal-website" class="form-control" placeholder="Enter company website">
        </div>
        
        <!-- Address/Notes -->
        <div class="form-group">
            <label>Address / Notes</label>
            <textarea id="modal-notes" class="form-control" rows="3" placeholder="Enter address or additional notes"></textarea>
        </div>
        
        <!-- Buttons -->
        <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button onclick="hideAddSupplierModal()" style="flex: 1; background: #e0e0e0; color: #333; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                Cancel
            </button>
            <button onclick="saveSupplier()" style="flex: 1; background: #22c55e; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                Save
            </button>
        </div>
    </div>
</div>

<script>
// Unit mapping for stationary combustion sources
const stationaryUnits = {
    'coal-industrial': ['kg'],
    'coal': ['kg'],
    'gas-diesel-oil-energy': ['gj'],
    'lpg': ['liters'],
    'propane': ['kg'],
    'motor-gasoline': ['gj'],
    'natural-gas': ['gj'],
    'diesel': ['liters'],
    'fuel-oil': ['liters']
};

// Unit mapping for mobile combustion sources
const mobileUnits = {
    'off-road-ipcc': ['gj'],
    'off-road-diesel': ['liters'],
    'off-road-gasoline': ['liters'],
    'on-road-diesel': ['gj'],
    'on-road-gasoline-low-mileage': ['gj'],
    'on-road-gasoline-uncontrolled': ['gj'],
    'on-road-gasoline-oxidation': ['gj'],
    'on-road-natural-gas': ['gj'],
    'on-road-lpg': ['gj'],
    'on-road-petrol-desnz': ['liters'],
    'on-road-diesel-desnz': ['liters'],
    'on-road-lpg-desnz': ['gj'],
    'gasoline': ['liters'],
    'diesel': ['liters'],
    'cng': ['kg'],
    'vehicle-km': ['km']
};

// Removed complex fuel type handling - sources are now directly selectable

function updateMobileFields() {
    const sourceSelect = document.getElementById('mobile-source');
    const unitSelect = document.getElementById('mobile-unit');
    const selectedSource = sourceSelect.value;
    
    // Clear current options
    unitSelect.innerHTML = '<option value="">Select Unit</option>';
    
    if (selectedSource && mobileUnits[selectedSource]) {
        const allowedUnits = mobileUnits[selectedSource];
        
        // Add only allowed units
        allowedUnits.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit;
            
            // Set display text
            if (unit === 'kg') option.textContent = 'Kilograms (kg)';
            else if (unit === 'liters') option.textContent = 'Liters';
            else if (unit === 'gj') option.textContent = 'Gigajoules (GJ)';
            else if (unit === 'km') option.textContent = 'Kilometers';
            else option.textContent = unit;
            
            unitSelect.appendChild(option);
        });
        
        // Auto-select if only one option
        if (allowedUnits.length === 1) {
            unitSelect.value = allowedUnits[0];
        }
    } else {
        // Show all units if no source selected
        unitSelect.innerHTML = `
            <option value="">Select Unit</option>
            <option value="liters">Liters</option>
            <option value="kg">Kilograms (kg)</option>
            <option value="gj">Gigajoules (GJ)</option>
            <option value="km">Kilometers</option>
        `;
    }
}

function updateStationaryFields() {
    const sourceSelect = document.getElementById('stationary-source');
    const unitSelect = document.getElementById('stationary-unit');
    const industryTypeGroup = document.getElementById('industry-type-group');
    const selectedSource = sourceSelect.value;
    
    // Show/hide Industry Type field for Gas/Diesel Oil, LPG, Motor Gasoline, and Natural Gas
    if (selectedSource === 'gas-diesel-oil-energy' || selectedSource === 'lpg' || selectedSource === 'motor-gasoline' || selectedSource === 'natural-gas') {
        industryTypeGroup.style.display = 'block';
    } else {
        industryTypeGroup.style.display = 'none';
    }
    
    // Clear current options
    unitSelect.innerHTML = '<option value="">Select Unit</option>';
    
    if (selectedSource && stationaryUnits[selectedSource]) {
        const allowedUnits = stationaryUnits[selectedSource];
        
        // Add only allowed units
        allowedUnits.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit;
            
            // Set display text
            if (unit === 'kg') option.textContent = 'Kilograms (kg)';
            else if (unit === 'liters') option.textContent = 'Liters';
            else if (unit === 'm3') option.textContent = 'Cubic Meters (m¬≥)';
            else if (unit === 'gj') option.textContent = 'Gigajoules (GJ)';
            else if (unit === 'kwh') option.textContent = 'kWh';
            else option.textContent = unit;
            
            unitSelect.appendChild(option);
        });
        
        // Auto-select if only one option
        if (allowedUnits.length === 1) {
            unitSelect.value = allowedUnits[0];
        }
    } else {
        // Show all units if no source selected
        unitSelect.innerHTML = `
            <option value="">Select Unit</option>
            <option value="liters">Liters</option>
            <option value="kg">Kilograms (kg)</option>
            <option value="m3">Cubic Meters (m¬≥)</option>
            <option value="gj">Gigajoules (GJ)</option>
            <option value="kwh">kWh</option>
        `;
    }
}

function switchScope(scopeNum) {
    // Hide all scopes
    document.querySelectorAll('.scope-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.scope-tab').forEach(el => el.classList.remove('active'));
    
    // Show selected scope
    document.getElementById('scope' + scopeNum).classList.add('active');
    document.querySelectorAll('.scope-tab')[scopeNum - 1].classList.add('active');
}

function toggleCategory(category) {
    const form = document.getElementById(category + '-form');
    const icon = event.currentTarget.querySelector('i');
    
    if (form.style.display === 'none') {
        form.style.display = 'block';
        icon.style.transform = 'rotate(180deg)';
    } else {
        form.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
    }
}

// Activity data increment/decrement
document.querySelectorAll('.activity-input button').forEach(btn => {
    btn.addEventListener('click', function() {
        const input = this.parentElement.querySelector('input');
        const currentValue = parseFloat(input.value) || 0;
        
        if (this.textContent === '+') {
            input.value = currentValue + 1;
        } else if (this.textContent === '‚àí' && currentValue > 0) {
            input.value = currentValue - 1;
        }
    });
});

// Calculate emissions
document.querySelectorAll('.btn-calculate').forEach(btn => {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        
        const form = this.closest('div[id$="-form"]');
        const category = form.id.replace('-form', '');
        
        // Get form data - find the source select by category-specific ID
        let sourceSelect;
        if (category === 'stationary') {
            sourceSelect = document.getElementById('stationary-source');
        } else if (category === 'mobile') {
            sourceSelect = document.getElementById('mobile-source');
        } else if (category === 'fugitive') {
            sourceSelect = document.getElementById('fugitive-source');
        } else if (category === 'electricity') {
            sourceSelect = document.getElementById('electricity-source');
        } else if (category === 'steam-heat') {
            sourceSelect = document.getElementById('steam-heat-source');
        } else if (category === 'water') {
            sourceSelect = document.getElementById('water-source');
        } else if (category === 'purchased-goods') {
            sourceSelect = document.getElementById('purchased-goods-source');
        } else if (category === 'business-travel') {
            sourceSelect = document.getElementById('business-travel-source');
        } else if (category === 'commuting') {
            sourceSelect = document.getElementById('commuting-source');
        } else if (category === 'waste') {
            sourceSelect = document.getElementById('waste-source');
        } else {
            // Fallback to first select
            sourceSelect = form.querySelector('select[class*="form-control"]');
        }
        
        const activityInput = form.querySelector('input[type="number"]');
        const supplierSelect = form.querySelector('.supplier-select');
        const descriptionTextarea = form.querySelector('textarea');
        const industryTypeSelect = document.getElementById('stationary-industry-type');
        const fuelNameSelect = document.getElementById('mobile-fuel-name');
        
        if (!sourceSelect || !activityInput) return;
        
        let source = sourceSelect.value;
        const activityData = parseFloat(activityInput.value) || 0;
        const supplierId = supplierSelect ? supplierSelect.value : null;
        const description = descriptionTextarea ? descriptionTextarea.value : '';
        const industryType = industryTypeSelect ? industryTypeSelect.value : '';
        const fuelName = fuelNameSelect ? fuelNameSelect.value : '';
        const fuelTypeSelect = document.getElementById('mobile-fuel-type');
        const fuelType = fuelTypeSelect ? fuelTypeSelect.value : '';
        
        // No need for complex fuel type handling anymore - sources are directly selectable
        
        if (!source || activityData <= 0) {
            alert('Please select an emission source and enter activity data');
            return;
        }
        
        // Check if this is a custom factor
        if (source.startsWith('custom-')) {
            const customFactorId = source.replace('custom-', '');
            
            // Show loading
            this.textContent = 'Calculating...';
            this.disabled = true;
            
            // Calculate with custom factor
            fetch('/api/custom-factors/calculate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    custom_factor_id: customFactorId,
                    activity_data: activityData,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    showResult(data, form);
                }
                this.textContent = 'Calculate';
                this.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Calculation failed. Please try again.');
                this.textContent = 'Calculate';
                this.disabled = false;
            });
            
            return; // Exit early for custom factors
        }
        
        // Determine category type
        let categoryType = 'stationary';
        if (category === 'mobile') categoryType = 'mobile';
        else if (category === 'fugitive') categoryType = 'fugitive';
        else if (category === 'electricity') categoryType = 'electricity';
        else if (category === 'steam-heat') categoryType = 'steam-heat';
        else if (category === 'business-travel') categoryType = 'travel';
        else if (category.includes('water')) categoryType = 'water';
        else if (category === 'waste') categoryType = 'waste';
        else if (category === 'purchased-goods') categoryType = 'purchased-goods';
        else if (category === 'capital-goods') categoryType = 'capital-goods';
        else if (category === 'fuel-energy') categoryType = 'fuel-energy';
        else if (category === 'upstream-transport') categoryType = 'upstream-transport';
        else if (category === 'commuting') categoryType = 'commuting';
        else if (category === 'upstream-leased') categoryType = 'upstream-leased';
        else if (category === 'downstream-transport') categoryType = 'downstream-transport';
        else if (category === 'end-of-life') categoryType = 'end-of-life';
        else if (category === 'franchises') categoryType = 'franchises';
        else if (category === 'investments') categoryType = 'investments';
        
        // Get selected country
        const country = document.getElementById('country-selector').value;
        
        // Show loading
        this.textContent = 'Calculating...';
        this.disabled = true;
        
        // Calculate
        fetch(window.location.pathname.replace('data-entry/', 'api/calculate/'), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                category: categoryType,
                source: source,
                activity_data: activityData,
                country: country,
                supplier_id: supplierId || null,
                description: description,
                industry_type: industryType || null,
                fuel_name: fuelName || null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                showResult(data, form);
            }
            this.textContent = 'Calculate';
            this.disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Calculation failed. Please try again.');
            this.textContent = 'Calculate';
            this.disabled = false;
        });
    });
});

function showResult(data, form) {
    // Remove existing result
    const existingResult = form.querySelector('.calculation-result');
    if (existingResult) existingResult.remove();
    
    // Create result display
    const resultDiv = document.createElement('div');
    resultDiv.className = 'calculation-result';
    resultDiv.style.cssText = 'background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 20px; margin-top: 20px;';
    
    resultDiv.innerHTML = `
        <h4 style="color: #22c55e; font-size: 16px; font-weight: 700; margin-bottom: 15px;">
            <i class="fas fa-check-circle"></i> Calculation Result ${data.saved ? '<span style="font-size: 12px; color: #666; font-weight: normal;">(Saved to History)</span>' : ''}
        </h4>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
            <div>
                <p style="font-size: 12px; color: #666; margin-bottom: 5px;">Activity Data</p>
                <p style="font-size: 18px; font-weight: 700; color: #333;">${data.activity_data} ${data.unit}</p>
            </div>
            <div>
                <p style="font-size: 12px; color: #666; margin-bottom: 5px;">Emission Factor</p>
                <p style="font-size: 18px; font-weight: 700; color: #333;">${data.factor} kg CO2e/${data.unit}</p>
            </div>
            <div>
                <p style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Emissions (kg)</p>
                <p style="font-size: 20px; font-weight: 700; color: #22c55e;">${data.emissions_kg} kg CO2e</p>
            </div>
            <div>
                <p style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Emissions (tons)</p>
                <p style="font-size: 20px; font-weight: 700; color: #22c55e;">${data.emissions_tons} t CO2e</p>
            </div>
        </div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #22c55e;">
            <p style="font-size: 13px; color: #666;">
                <i class="fas fa-info-circle"></i> 
                Source: ${data.source_name} 
                ${data.is_custom ? '<span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 5px;">CUSTOM</span>' : ''}
                ${data.is_verified ? '<span style="color: #22c55e; margin-left: 5px;" title="Verified by admin">‚úì</span>' : ''}
                | Country: ${data.country === 'turkey' ? 'üáπüá∑ Turkey' : data.country === 'custom' ? 'üîß Custom' : 'üåç Global'}
            </p>
            ${data.reference ? `<p style="font-size: 12px; color: #999; margin-top: 5px;"><i class="fas fa-book"></i> Reference: ${data.reference}</p>` : ''}
        </div>
    `;
    
    form.appendChild(resultDiv);
    
    // Scroll to result
    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Country selector change handler
document.getElementById('country-selector').addEventListener('change', function() {
    const countryInfo = document.getElementById('country-info');
    if (this.value === 'turkey') {
        countryInfo.innerHTML = '<i class="fas fa-info-circle"></i> Using Turkey-specific emission factors (IEA 2023, Turkish Ministry of Environment)';
        countryInfo.style.color = '#22c55e';
    } else {
        countryInfo.innerHTML = '<i class="fas fa-info-circle"></i> Using global average emission factors (IPCC, EPA, DEFRA)';
        countryInfo.style.color = '#666';
    }
});

// Supplier Management Functions
function loadSuppliers() {
    fetch('/api/suppliers/', {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        const supplierSelects = document.querySelectorAll('.supplier-select');
        supplierSelects.forEach(select => {
            // Keep the first option (Select Supplier)
            const firstOption = select.options[0];
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            // Add suppliers
            data.suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = supplier.name + (supplier.supplier_type ? ` (${supplier.supplier_type})` : '');
                select.appendChild(option);
            });
        });
    })
    .catch(error => console.error('Error loading suppliers:', error));
}

function showAddSupplierModal() {
    const modal = document.getElementById('supplierModal');
    modal.style.display = 'flex';
    
    // Clear all fields
    document.getElementById('modal-supplier-name').value = '';
    document.getElementById('modal-contact-name').value = '';
    document.getElementById('modal-email').value = '';
    document.getElementById('modal-phone-code').value = '+90';
    document.getElementById('modal-phone').value = '';
    document.getElementById('modal-supplier-type').value = '';
    document.getElementById('modal-country').value = '';
    document.getElementById('modal-city').value = '';
    document.getElementById('modal-tax-number').value = '';
    document.getElementById('modal-website').value = '';
    document.getElementById('modal-notes').value = '';
}

function hideAddSupplierModal() {
    document.getElementById('supplierModal').style.display = 'none';
}

function saveSupplier() {
    const name = document.getElementById('modal-supplier-name').value.trim();
    
    if (!name) {
        alert('Please enter supplier name');
        return;
    }
    
    const supplierData = {
        name: name,
        contact_person: document.getElementById('modal-contact-name').value.trim(),
        email: document.getElementById('modal-email').value.trim(),
        phone_code: document.getElementById('modal-phone-code').value,
        phone: document.getElementById('modal-phone').value.trim(),
        supplier_type: document.getElementById('modal-supplier-type').value,
        country: document.getElementById('modal-country').value,
        city: document.getElementById('modal-city').value.trim(),
        tax_number: document.getElementById('modal-tax-number').value.trim(),
        website: document.getElementById('modal-website').value.trim(),
        notes: document.getElementById('modal-notes').value.trim()
    };
    
    fetch('/api/suppliers/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(supplierData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            // Show error message as toast
            const errorMsg = document.createElement('div');
            errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error: ' + data.error;
            document.body.appendChild(errorMsg);
            
            setTimeout(() => {
                errorMsg.remove();
            }, 4000);
        } else {
            hideAddSupplierModal();
            loadSuppliers(); // Reload supplier list
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #22c55e; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Supplier added successfully!';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                successMsg.remove();
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Show error message as toast
        const errorMsg = document.createElement('div');
        errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
        errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Failed to add supplier. Please try again.';
        document.body.appendChild(errorMsg);
        
        setTimeout(() => {
            errorMsg.remove();
        }, 4000);
    });
}

// Handle "Other" selection in any dropdown
function handleOtherSelection(selectElement, category) {
    if (selectElement.value === 'other') {
        // Show choice modal
        showOtherChoiceModal(category);
        // Reset dropdown to empty
        selectElement.value = '';
    }
}

// Handle "Other" selection in Purchased Goods dropdown (backward compatibility)
function handlePurchasedGoodsSourceChange(selectElement) {
    handleOtherSelection(selectElement, 'purchased-goods');
}

// Other Choice Modal Functions
let currentCategory = 'purchased-goods'; // Store current category

function showOtherChoiceModal(category) {
    currentCategory = category || 'purchased-goods';
    const modal = document.getElementById('otherChoiceModal');
    modal.style.display = 'flex';
}

function hideOtherChoiceModal() {
    const modal = document.getElementById('otherChoiceModal');
    modal.style.display = 'none';
}

function selectOtherOption(option) {
    hideOtherChoiceModal();
    
    if (option === 'custom') {
        // Open Custom Factor Modal with pre-filled category
        showCustomFactorModal(currentCategory);
    } else if (option === 'request') {
        // Open Request Material Modal with pre-filled category
        showRequestMaterialModal(currentCategory);
    }
}

// Custom Emission Factor Functions
function showCustomFactorModal(prefilledCategory) {
    const modal = document.getElementById('customFactorModal');
    modal.style.display = 'flex';
    
    // Clear all fields
    document.getElementById('custom-material-name').value = '';
    document.getElementById('custom-emission-factor').value = '';
    document.getElementById('custom-unit').value = '';
    document.getElementById('custom-supplier').value = '';
    document.getElementById('custom-source-reference').value = '';
    document.getElementById('custom-description').value = '';
    
    // Pre-fill category if provided
    const categorySelect = document.getElementById('custom-category');
    if (prefilledCategory) {
        // Map frontend categories to form categories
        const categoryMap = {
            'stationary': 'stationary',
            'mobile': 'mobile',
            'purchased-goods': 'purchased-goods',
            'capital-goods': 'capital-goods',
            'waste': 'waste'
        };
        categorySelect.value = categoryMap[prefilledCategory] || '';
    } else {
        categorySelect.value = '';
    }
}

function hideCustomFactorModal() {
    document.getElementById('customFactorModal').style.display = 'none';
}

function saveCustomFactor() {
    const materialName = document.getElementById('custom-material-name').value.trim();
    const category = document.getElementById('custom-category').value;
    const emissionFactor = document.getElementById('custom-emission-factor').value;
    const unit = document.getElementById('custom-unit').value;
    
    if (!materialName || !category || !emissionFactor || !unit) {
        alert('Please fill in all required fields');
        return;
    }
    
    const factorData = {
        material_name: materialName,
        category: category,
        emission_factor: parseFloat(emissionFactor),
        unit: unit,
        supplier_id: document.getElementById('custom-supplier').value || null,
        source_reference: document.getElementById('custom-source-reference').value.trim(),
        description: document.getElementById('custom-description').value.trim()
    };
    
    fetch('/api/custom-factors/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(factorData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            // Show error message as toast
            const errorMsg = document.createElement('div');
            errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error: ' + data.error;
            document.body.appendChild(errorMsg);
            
            setTimeout(() => {
                errorMsg.remove();
            }, 4000);
        } else {
            hideCustomFactorModal();
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #22c55e; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Custom emission factor added successfully!';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                successMsg.remove();
            }, 3000);
            
            // Reload custom factors if needed
            loadCustomFactors();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Show error message as toast
        const errorMsg = document.createElement('div');
        errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
        errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Failed to add custom factor. Please try again.';
        document.body.appendChild(errorMsg);
        
        setTimeout(() => {
            errorMsg.remove();
        }, 4000);
    });
}

// Request New Material Functions
function showRequestMaterialModal(prefilledCategory) {
    const modal = document.getElementById('requestMaterialModal');
    modal.style.display = 'flex';
    
    // Clear all fields
    document.getElementById('request-material-name').value = '';
    document.getElementById('request-description').value = '';
    document.getElementById('request-suggested-factor').value = '';
    document.getElementById('request-suggested-unit').value = '';
    document.getElementById('request-suggested-source').value = '';
    
    // Pre-fill category if provided
    const categorySelect = document.getElementById('request-category');
    if (prefilledCategory) {
        const categoryMap = {
            'stationary': 'stationary',
            'mobile': 'mobile',
            'purchased-goods': 'purchased-goods',
            'capital-goods': 'capital-goods',
            'waste': 'waste'
        };
        categorySelect.value = categoryMap[prefilledCategory] || '';
    } else {
        categorySelect.value = '';
    }
}

function hideRequestMaterialModal() {
    document.getElementById('requestMaterialModal').style.display = 'none';
}

function submitMaterialRequest() {
    const materialName = document.getElementById('request-material-name').value.trim();
    const category = document.getElementById('request-category').value;
    const description = document.getElementById('request-description').value.trim();
    
    if (!materialName || !category || !description) {
        alert('Please fill in all required fields');
        return;
    }
    
    const requestData = {
        material_name: materialName,
        category: category,
        description: description,
        suggested_factor: document.getElementById('request-suggested-factor').value || null,
        suggested_unit: document.getElementById('request-suggested-unit').value || null,
        suggested_source: document.getElementById('request-suggested-source').value.trim() || null
    };
    
    fetch('/api/materials/request/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            // Show error message as toast
            const errorMsg = document.createElement('div');
            errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Error: ' + data.error;
            document.body.appendChild(errorMsg);
            
            setTimeout(() => {
                errorMsg.remove();
            }, 4000);
        } else {
            hideRequestMaterialModal();
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #3b82f6; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            successMsg.innerHTML = '<i class="fas fa-check-circle"></i> Request submitted! Admin will review it soon.';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                successMsg.remove();
            }, 4000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Show error message as toast
        const errorMsg = document.createElement('div');
        errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 15px 25px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
        errorMsg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Failed to submit request. Please try again.';
        document.body.appendChild(errorMsg);
        
        setTimeout(() => {
            errorMsg.remove();
        }, 4000);
    });
}

function loadCustomFactors(category) {
    // Load custom factors for the specified category
    const url = category ? `/api/custom-factors/?category=${category}` : '/api/custom-factors/';
    
    fetch(url, {
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.factors && data.factors.length > 0) {
            // Update purchased-goods dropdown with custom factors
            updateCustomFactorsInDropdown('purchased-goods-source', data.factors);
            
            console.log(`Loaded ${data.factors.length} custom factors`);
        }
    })
    .catch(error => {
        console.error('Error loading custom factors:', error);
    });
}

function updateCustomFactorsInDropdown(selectId, factors) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    // Find or create custom factors optgroup
    let optgroup = document.getElementById('custom-factors-optgroup');
    
    if (factors.length > 0) {
        // Clear existing custom factors
        optgroup.innerHTML = '';
        
        // Add custom factors
        factors.forEach(factor => {
            const option = document.createElement('option');
            option.value = 'custom-' + factor.id;
            option.textContent = `${factor.material_name} (${factor.emission_factor} kg CO2e/${factor.unit})`;
            if (factor.is_verified) {
                option.textContent += ' ‚úì';
            }
            optgroup.appendChild(option);
        });
        
        // Show optgroup
        optgroup.style.display = 'block';
    } else {
        // Hide optgroup if no custom factors
        if (optgroup) {
            optgroup.style.display = 'none';
        }
    }
}

function calculateWithCustomFactor(customFactorId, activityData, description) {
    // Calculate emissions using a custom emission factor
    fetch('/api/custom-factors/calculate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            custom_factor_id: customFactorId,
            activity_data: activityData,
            description: description || ''
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            // Show result (same as standard calculation)
            const form = document.getElementById('purchased-goods-form');
            showResult(data, form);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Calculation failed. Please try again.');
    });
}

// Load suppliers and custom factors on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSuppliers();
    loadCustomFactors('purchased-goods'); // Load custom factors for purchased goods
    
    // Character counter for fugitive description
    const fugitiveDescription = document.getElementById('fugitive-description');
    const fugitiveCharCount = document.getElementById('fugitive-char-count');
    
    if (fugitiveDescription && fugitiveCharCount) {
        fugitiveDescription.addEventListener('input', function() {
            fugitiveCharCount.textContent = this.value.length;
        });
    }
});
</script>
{% endblock %}
